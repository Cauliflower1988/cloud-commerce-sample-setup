/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/*
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
import * as tslib_1 from "tslib";
import { Inject, Optional } from '@angular/core';
import * as lodash from 'lodash';
import { functionsUtils } from '../../utils';
import { IAuthenticationManagerService, IAuthenticationService, IModalService, ISettingsService, ISharedDataService, IStorageService } from '../../interfaces';
import { ITranslationsFetchService } from '../translations';
import { DEFAULT_AUTH_MAP, DEFAULT_AUTHENTICATION_ENTRY_POINT, DEFAULT_CREDENTIALS_MAP, EVENT_SERVICE, EVENTS } from '../../constants';
import { SSOAuthenticationHelper } from './sso-authentication.helper';
import { LoginDialogComponent } from '../../components/login-dialog';
var AuthenticationService = /** @class */ (function (_super) {
    tslib_1.__extends(AuthenticationService, _super);
    function AuthenticationService(translationsFetchService, modalService, sharedDataService, storageService, eventService, ssoAuthenticationHelper, settingsService, authenticationManager) {
        var _this = _super.call(this) || this;
        _this.translationsFetchService = translationsFetchService;
        _this.modalService = modalService;
        _this.sharedDataService = sharedDataService;
        _this.storageService = storageService;
        _this.eventService = eventService;
        _this.ssoAuthenticationHelper = ssoAuthenticationHelper;
        _this.settingsService = settingsService;
        _this.authenticationManager = authenticationManager;
        return _this;
    }
    AuthenticationService.prototype.filterEntryPoints = function (resource) {
        return this.sharedDataService.get('authenticationMap').then(function (authenticationMap) {
            return functionsUtils
                .convertToArray(tslib_1.__assign({}, (authenticationMap || {}), DEFAULT_AUTH_MAP))
                .filter(function (entry) {
                return new RegExp(entry.key, 'g').test(resource);
            })
                .map(function (element) { return element.value; });
        });
    };
    AuthenticationService.prototype.isAuthEntryPoint = function (resource) {
        return this.sharedDataService.get('authenticationMap').then(function (authenticationMap) {
            var authEntryPoints = functionsUtils
                .convertToArray(authenticationMap || {})
                .map(function (element) { return element.value; });
            return (authEntryPoints.indexOf(resource) > -1 ||
                resource === DEFAULT_AUTHENTICATION_ENTRY_POINT);
        });
    };
    AuthenticationService.prototype.authenticate = function (resource) {
        var _this = this;
        return this._findLoginData(resource).then(function (loginData) {
            return _this._launchAuth(loginData).then(function (modalFeedback) {
                Promise.resolve(_this.eventService.publish(EVENTS.AUTHORIZATION_SUCCESS, {
                    userHasChanged: modalFeedback.userHasChanged
                })).then(function () {
                    if (modalFeedback.userHasChanged) {
                        _this.eventService.publish(EVENTS.USER_HAS_CHANGED);
                    }
                    /**
                     * We only need to reload when the user has changed and all authentication forms were closed.
                     * There can be many authentication forms if some modules use different (from default one) end points.
                     */
                    var reauthInProcess = lodash
                        .values(_this.reauthInProgress)
                        .some(function (inProcess) { return inProcess; });
                    if (modalFeedback.userHasChanged &&
                        !reauthInProcess &&
                        _this.authenticationManager &&
                        _this.authenticationManager.onUserHasChanged) {
                        _this.authenticationManager.onUserHasChanged();
                    }
                });
                _this.reauthInProgress[loginData.authURI] = false;
            });
        });
    };
    AuthenticationService.prototype.logout = function () {
        var _this = this;
        // First, indicate the services that SmartEdit is logging out. This should give them the opportunity to clean up.
        // NOTE: This is not synchronous since some clean-up might be lengthy, and logging out should be fast.
        return this.eventService.publish(EVENTS.LOGOUT).then(function () {
            _this.storageService.removeAllAuthTokens();
            if (_this.ssoAuthenticationHelper.isAutoSSOMain()) {
                _this.ssoAuthenticationHelper.logout();
            }
            else if (_this.authenticationManager && _this.authenticationManager.onLogout) {
                _this.authenticationManager.onLogout();
            }
        });
    };
    AuthenticationService.prototype.isReAuthInProgress = function (entryPoint) {
        return Promise.resolve(this.reauthInProgress[entryPoint] === true);
    };
    AuthenticationService.prototype.setReAuthInProgress = function (entryPoint) {
        this.reauthInProgress[entryPoint] = true;
        return Promise.resolve();
    };
    AuthenticationService.prototype.isAuthenticated = function (url) {
        var _this = this;
        return this.filterEntryPoints(url).then(function (entryPoints) {
            var authURI = entryPoints && entryPoints[0];
            return Promise.resolve(_this.storageService.getAuthToken(authURI)).then(function (authToken) {
                return !!authToken;
            });
        });
    };
    /*
     * will try determine first relevant authentication entry point from authenticationMap and retrieve potential client credentials to be added on top of user credentials
     */
    AuthenticationService.prototype._findLoginData = function (resource) {
        var _this = this;
        return this.filterEntryPoints(resource).then(function (entryPoints) {
            return Promise.resolve(_this.sharedDataService.get('credentialsMap').then(function (credentialsMap) {
                var map = tslib_1.__assign({}, (credentialsMap || {}), DEFAULT_CREDENTIALS_MAP);
                var authURI = entryPoints[0];
                return {
                    authURI: authURI,
                    clientCredentials: map[authURI]
                };
            }));
        });
    };
    AuthenticationService.prototype._launchAuth = function (loginData) {
        var _this = this;
        return this.translationsFetchService
            .waitToBeReady()
            .then(function () {
            return Promise.all([
                _this.storageService.isInitialized(),
                _this.settingsService.getBoolean('smartedit.sso.enabled')
            ]);
        })
            .then(function (_a) {
            var _b = tslib_1.__read(_a, 2), isFullScreen = _b[0], ssoEnabled = _b[1];
            var modalRef = _this.modalService.open({
                component: LoginDialogComponent,
                data: tslib_1.__assign({}, loginData, { isFullScreen: isFullScreen,
                    ssoEnabled: ssoEnabled }),
                config: {
                    modalPanelClass: 'su-login-dialog-container',
                    hasBackdrop: false
                }
            });
            return new Promise(function (resolve, reject) {
                modalRef.afterClosed.subscribe(resolve, reject);
            });
        });
    };
    AuthenticationService = tslib_1.__decorate([
        tslib_1.__param(4, Inject(EVENT_SERVICE)),
        tslib_1.__param(7, Optional()),
        tslib_1.__metadata("design:paramtypes", [ITranslationsFetchService,
            IModalService,
            ISharedDataService,
            IStorageService, Object, SSOAuthenticationHelper,
            ISettingsService,
            IAuthenticationManagerService])
    ], AuthenticationService);
    return AuthenticationService;
}(IAuthenticationService));
export { AuthenticationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2F1dGhlbnRpY2F0aW9uL2F1dGhlbnRpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBQ0g7O0dBRUc7O0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakQsT0FBTyxLQUFLLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFFakMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM3QyxPQUFPLEVBQ0gsNkJBQTZCLEVBQzdCLHNCQUFzQixFQU10QixhQUFhLEVBQ2IsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQixlQUFlLEVBQ2xCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUNILGdCQUFnQixFQUNoQixrQ0FBa0MsRUFDbEMsdUJBQXVCLEVBQ3ZCLGFBQWEsRUFDYixNQUFNLEVBQ1QsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUV0RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQWVyRTtJQUEyQyxpREFBc0I7SUFDN0QsK0JBQ2Msd0JBQW1ELEVBQ25ELFlBQTJCLEVBQzNCLGlCQUFxQyxFQUNyQyxjQUErQixFQUNSLFlBQTJCLEVBQ2xELHVCQUFnRCxFQUNoRCxlQUFpQyxFQUNyQixxQkFBb0Q7UUFSOUUsWUFVSSxpQkFBTyxTQUNWO1FBVmEsOEJBQXdCLEdBQXhCLHdCQUF3QixDQUEyQjtRQUNuRCxrQkFBWSxHQUFaLFlBQVksQ0FBZTtRQUMzQix1QkFBaUIsR0FBakIsaUJBQWlCLENBQW9CO1FBQ3JDLG9CQUFj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O1lBQzVCLElBQU0sUUFBUSxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFhO2dCQUNoRCxTQUFTLEVBQUUsb0JBQW9CO2dCQUMvQixJQUFJLHVCQUNHLFNBQVMsSUFDWixZQUFZLGNBQUE7b0JBQ1osVUFBVSxZQUFBLEdBQ2I7Z0JBQ0QsTUFBTSxFQUFFO29CQUNKLGVBQWUsRUFBRSwyQkFBMkI7b0JBQzVDLFdBQVcsRUFBRSxLQUFLO2lCQUNyQjthQUNKLENBQUMsQ0FBQztZQUVILE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtnQkFDL0IsUUFBUSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3BELENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBMUpRLHFCQUFxQjtRQU16QixtQkFBQSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUE7UUFHckIsbUJBQUEsUUFBUSxFQUFFLENBQUE7aURBUHlCLHlCQUF5QjtZQUNyQyxhQUFhO1lBQ1Isa0JBQWtCO1lBQ3JCLGVBQWUsVUFFTix1QkFBdUI7WUFDL0IsZ0JBQWdCO1lBQ0UsNkJBQTZCO09BVHJFLHFCQUFxQixDQTJKakM7SUFBRCw0QkFBQztDQUFBLEFBM0pELENBQTJDLHNCQUFzQixHQTJKaEU7U0EzSlkscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgbG9kYXNoIGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IGZ1bmN0aW9uc1V0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHtcbiAgICBJQXV0aGVudGljYXRpb25NYW5hZ2VyU2VydmljZSxcbiAgICBJQXV0aGVudGljYXRpb25TZXJ2aWNlLFxuICAgIElBdXRoVG9rZW4sXG4gICAgSUNyZWRlbnRpYWxzTWFwUmVjb3JkLFxuICAgIElFdmVudFNlcnZpY2UsXG4gICAgSUxvZ2luRGF0YSxcbiAgICBJTG9naW5Nb2RhbEZlZWRiYWNrLFxuICAgIElNb2RhbFNlcnZpY2UsXG4gICAgSVNldHRpbmdzU2VydmljZSxcbiAgICBJU2hhcmVkRGF0YVNlcnZpY2UsXG4gICAgSVN0b3JhZ2VTZXJ2aWNlXG59IGZyb20gJy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgSVRyYW5zbGF0aW9uc0ZldGNoU2VydmljZSB9IGZyb20gJy4uL3RyYW5zbGF0aW9ucyc7XG5pbXBvcnQge1xuICAgIERFRkFVTFRfQVVUSF9NQVAsXG4gICAgREVGQVVMVF9BVVRIRU5USUNBVElPTl9FTlRSWV9QT0lOVCxcbiAgICBERUZBVUxUX0NSRURFTlRJQUxTX01BUCxcbiAgICBFVkVOVF9TRVJWSUNFLFxuICAgIEVWRU5UU1xufSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgU1NPQXV0aGVudGljYXRpb25IZWxwZXIgfSBmcm9tICcuL3Nzby1hdXRoZW50aWNhdGlvbi5oZWxwZXInO1xuaW1wb3J0IHsgQ2xvbmVhYmxlIH0gZnJvbSAnLi4vLi4vZHRvcyc7XG5pbXBvcnQgeyBMb2dpbkRpYWxvZ0NvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvbG9naW4tZGlhbG9nJztcblxuZXhwb3J0IGludGVyZmFjZSBJQ3JlZGVudGlhbHNNYXAge1xuICAgIFtlbnRyeVBvaW50OiBzdHJpbmddOiBJQ3JlZGVudGlhbHNNYXBSZWNvcmQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUF1dGhNYXAge1xuICAgIFtlbnRyeVBvaW50OiBzdHJpbmddOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJQXV0aGVudGljYXRpb25NYXBFbnRyeSB7XG4gICAga2V5OiBzdHJpbmc7XG4gICAgdmFsdWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0aW9uU2VydmljZSBleHRlbmRzIElBdXRoZW50aWNhdGlvblNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgdHJhbnNsYXRpb25zRmV0Y2hTZXJ2aWNlOiBJVHJhbnNsYXRpb25zRmV0Y2hTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgbW9kYWxTZXJ2aWNlOiBJTW9kYWxTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgc2hhcmVkRGF0YVNlcnZpY2U6IElTaGFyZWREYXRhU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHN0b3JhZ2VTZXJ2aWNlOiBJU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgIEBJbmplY3QoRVZFTlRfU0VSVklDRSkgcHJvdGVjdGVkIGV2ZW50U2VydmljZTogSUV2ZW50U2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHNzb0F1dGhlbnRpY2F0aW9uSGVscGVyOiBTU09BdXRoZW50aWNhdGlvbkhlbHBlcixcbiAgICAgICAgcHJvdGVjdGVkIHNldHRpbmdzU2VydmljZTogSVNldHRpbmdzU2VydmljZSxcbiAgICAgICAgQE9wdGlvbmFsKCkgcHJvdGVjdGVkIGF1dGhlbnRpY2F0aW9uTWFuYWdlcjogSUF1dGhlbnRpY2F0aW9uTWFuYWdlclNlcnZpY2VcbiAgICApIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBmaWx0ZXJFbnRyeVBvaW50cyhyZXNvdXJjZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zaGFyZWREYXRhU2VydmljZS5nZXQoJ2F1dGhlbnRpY2F0aW9uTWFwJykudGhlbigoYXV0aGVudGljYXRpb25NYXApID0+IHtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbnNVdGlsc1xuICAgICAgICAgICAgICAgIC5jb252ZXJ0VG9BcnJheTxzdHJpbmc+KHtcbiAgICAgICAgICAgICAgICAgICAgLi4uKCgoYXV0aGVudGljYXRpb25NYXAgYXMgdW5rbm93bikgYXMgSUF1dGhlbnRpY2F0aW9uTWFwRW50cnkpIHx8IHt9KSxcbiAgICAgICAgICAgICAgICAgICAgLi4uREVGQVVMVF9BVVRIX01BUFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZW50cnk6IElBdXRoZW50aWNhdGlvbk1hcEVudHJ5KSA9PlxuICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKGVudHJ5LmtleSwgJ2cnKS50ZXN0KHJlc291cmNlKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAubWFwKChlbGVtZW50OiBJQXV0aGVudGljYXRpb25NYXBFbnRyeSkgPT4gZWxlbWVudC52YWx1ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlzQXV0aEVudHJ5UG9pbnQocmVzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zaGFyZWREYXRhU2VydmljZS5nZXQoJ2F1dGhlbnRpY2F0aW9uTWFwJykudGhlbigoYXV0aGVudGljYXRpb25NYXApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGF1dGhFbnRyeVBvaW50cyA9IGZ1bmN0aW9uc1V0aWxzXG4gICAgICAgICAgICAgICAgLmNvbnZlcnRUb0FycmF5PHN0cmluZz4oKChhdXRoZW50aWNhdGlvbk1hcCBhcyB1bmtub3duKSBhcyBJQXV0aE1hcCkgfHwge30pXG4gICAgICAgICAgICAgICAgLm1hcCgoZWxlbWVudDogSUF1dGhlbnRpY2F0aW9uTWFwRW50cnkpID0+IGVsZW1lbnQudmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICBhdXRoRW50cnlQb2ludHMuaW5kZXhPZihyZXNvdXJjZSkgPiAtMSB8fFxuICAgICAgICAgICAgICAgIHJlc291cmNlID09PSBERUZBVUxUX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhdXRoZW50aWNhdGUocmVzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmluZExvZ2luRGF0YShyZXNvdXJjZSkudGhlbigobG9naW5EYXRhOiBJTG9naW5EYXRhKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbGF1bmNoQXV0aChsb2dpbkRhdGEpLnRoZW4oKG1vZGFsRmVlZGJhY2s6IElMb2dpbk1vZGFsRmVlZGJhY2spID0+IHtcbiAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRTZXJ2aWNlLnB1Ymxpc2goRVZFTlRTLkFVVEhPUklaQVRJT05fU1VDQ0VTUywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckhhc0NoYW5nZWQ6IG1vZGFsRmVlZGJhY2sudXNlckhhc0NoYW5nZWRcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxGZWVkYmFjay51c2VySGFzQ2hhbmdlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudFNlcnZpY2UucHVibGlzaChFVkVOVFMuVVNFUl9IQVNfQ0hBTkdFRCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICAgICAqIFdlIG9ubHkgbmVlZCB0byByZWxvYWQgd2hlbiB0aGUgdXNlciBoYXMgY2hhbmdlZCBhbmQgYWxsIGF1dGhlbnRpY2F0aW9uIGZvcm1zIHdlcmUgY2xvc2VkLlxuICAgICAgICAgICAgICAgICAgICAgKiBUaGVyZSBjYW4gYmUgbWFueSBhdXRoZW50aWNhdGlvbiBmb3JtcyBpZiBzb21lIG1vZHVsZXMgdXNlIGRpZmZlcmVudCAoZnJvbSBkZWZhdWx0IG9uZSkgZW5kIHBvaW50cy5cbiAgICAgICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYXV0aEluUHJvY2VzcyA9IGxvZGFzaFxuICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlcyh0aGlzLnJlYXV0aEluUHJvZ3Jlc3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc29tZSgoaW5Qcm9jZXNzOiBib29sZWFuKSA9PiBpblByb2Nlc3MpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsRmVlZGJhY2sudXNlckhhc0NoYW5nZWQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICFyZWF1dGhJblByb2Nlc3MgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25NYW5hZ2VyICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTWFuYWdlci5vblVzZXJIYXNDaGFuZ2VkXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvbk1hbmFnZXIub25Vc2VySGFzQ2hhbmdlZCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWF1dGhJblByb2dyZXNzW2xvZ2luRGF0YS5hdXRoVVJJXSA9IGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGxvZ291dCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gRmlyc3QsIGluZGljYXRlIHRoZSBzZXJ2aWNlcyB0aGF0IFNtYXJ0RWRpdCBpcyBsb2dnaW5nIG91dC4gVGhpcyBzaG91bGQgZ2l2ZSB0aGVtIHRoZSBvcHBvcnR1bml0eSB0byBjbGVhbiB1cC5cbiAgICAgICAgLy8gTk9URTogVGhpcyBpcyBub3Qgc3luY2hyb25vdXMgc2luY2Ugc29tZSBjbGVhbi11cCBtaWdodCBiZSBsZW5ndGh5LCBhbmQgbG9nZ2luZyBvdXQgc2hvdWxkIGJlIGZhc3QuXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50U2VydmljZS5wdWJsaXNoKEVWRU5UUy5MT0dPVVQpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdG9yYWdlU2VydmljZS5yZW1vdmVBbGxBdXRoVG9rZW5zKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5zc29BdXRoZW50aWNhdGlvbkhlbHBlci5pc0F1dG9TU09NYWluKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNzb0F1dGhlbnRpY2F0aW9uSGVscGVyLmxvZ291dCgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmF1dGhlbnRpY2F0aW9uTWFuYWdlciAmJiB0aGlzLmF1dGhlbnRpY2F0aW9uTWFuYWdlci5vbkxvZ291dCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25NYW5hZ2VyLm9uTG9nb3V0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlzUmVBdXRoSW5Qcm9ncmVzcyhlbnRyeVBvaW50OiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLnJlYXV0aEluUHJvZ3Jlc3NbZW50cnlQb2ludF0gPT09IHRydWUpO1xuICAgIH1cblxuICAgIHNldFJlQXV0aEluUHJvZ3Jlc3MoZW50cnlQb2ludDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMucmVhdXRoSW5Qcm9ncmVzc1tlbnRyeVBvaW50XSA9IHRydWU7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBpc0F1dGhlbnRpY2F0ZWQodXJsOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyRW50cnlQb2ludHModXJsKS50aGVuKChlbnRyeVBvaW50czogc3RyaW5nW10pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGF1dGhVUkkgPSBlbnRyeVBvaW50cyAmJiBlbnRyeVBvaW50c1swXTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0QXV0aFRva2VuKFxuICAgICAgICAgICAgICAgIGF1dGhVUklcbiAgICAgICAgICAgICkgYXMgdW5rbm93bikgYXMgSUF1dGhUb2tlbikudGhlbigoYXV0aFRva2VuOiBJQXV0aFRva2VuKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICEhYXV0aFRva2VuO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogd2lsbCB0cnkgZGV0ZXJtaW5lIGZpcnN0IHJlbGV2YW50IGF1dGhlbnRpY2F0aW9uIGVudHJ5IHBvaW50IGZyb20gYXV0aGVudGljYXRpb25NYXAgYW5kIHJldHJpZXZlIHBvdGVudGlhbCBjbGllbnQgY3JlZGVudGlhbHMgdG8gYmUgYWRkZWQgb24gdG9wIG9mIHVzZXIgY3JlZGVudGlhbHNcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgX2ZpbmRMb2dpbkRhdGEocmVzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8SUxvZ2luRGF0YT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXJFbnRyeVBvaW50cyhyZXNvdXJjZSkudGhlbigoZW50cnlQb2ludHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgICAgICAgICAgIHRoaXMuc2hhcmVkRGF0YVNlcnZpY2UuZ2V0KCdjcmVkZW50aWFsc01hcCcpLnRoZW4oKGNyZWRlbnRpYWxzTWFwOiBDbG9uZWFibGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWFwOiBJQ3JlZGVudGlhbHNNYXAgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi4oKChjcmVkZW50aWFsc01hcCBhcyB1bmtub3duKSBhcyBJQ3JlZGVudGlhbHNNYXApIHx8IHt9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLkRFRkFVTFRfQ1JFREVOVElBTFNfTUFQXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhVUkkgPSBlbnRyeVBvaW50c1swXTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhVUkksXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRDcmVkZW50aWFsczogbWFwW2F1dGhVUkldXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfbGF1bmNoQXV0aChsb2dpbkRhdGE6IElMb2dpbkRhdGEpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvbnNGZXRjaFNlcnZpY2VcbiAgICAgICAgICAgIC53YWl0VG9CZVJlYWR5KClcbiAgICAgICAgICAgIC50aGVuKCgpID0+XG4gICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmlzSW5pdGlhbGl6ZWQoKSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1NlcnZpY2UuZ2V0Qm9vbGVhbignc21hcnRlZGl0LnNzby5lbmFibGVkJylcbiAgICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRoZW4oKFtpc0Z1bGxTY3JlZW4sIHNzb0VuYWJsZWRdOiBbYm9vbGVhbiwgYm9vbGVhbl0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2RhbFJlZiA9IHRoaXMubW9kYWxTZXJ2aWNlLm9wZW48SUxvZ2luRGF0YT4oe1xuICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQ6IExvZ2luRGlhbG9nQ29tcG9uZW50LFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5sb2dpbkRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc0Z1bGxTY3JlZW4sXG4gICAgICAgICAgICAgICAgICAgICAgICBzc29FbmFibGVkXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxQYW5lbENsYXNzOiAnc3UtbG9naW4tZGlhbG9nLWNvbnRhaW5lcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNCYWNrZHJvcDogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbW9kYWxSZWYuYWZ0ZXJDbG9zZWQuc3Vic2NyaWJlKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=