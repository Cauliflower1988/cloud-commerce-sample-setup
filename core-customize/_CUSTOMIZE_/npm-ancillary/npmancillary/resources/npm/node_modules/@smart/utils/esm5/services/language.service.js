/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
import { TranslateService } from '@ngx-translate/core';
import { Inject, Injectable, Injector } from '@angular/core';
import { EVENT_SERVICE, LANGUAGE_SERVICE_CONSTANTS, SELECTED_LANGUAGE, SWITCH_LANGUAGE_EVENT } from '../constants';
import { IEventService, ILanguageServiceConstants, IStorageService } from '../interfaces';
import { BrowserService } from './browser';
import { rarelyChangingContent, Cached } from './cache';
import { LogService } from './log.service';
import { RestServiceFactory } from './rest';
import { PromiseUtils } from '../utils';
/**
 * @ngdoc object
 * @name resourceLocationsModule.object:LANGUAGE_RESOURCE_URI
 *
 * @description
 * Resource URI of the languages REST service.
 */
/**
 * @ngdoc service
 * @name @smartutils.services:LanguageService
 */
var LanguageService = /** @class */ (function () {
    function LanguageService(logService, translateService, promiseUtils, eventService, browserService, storageService, injector, languageServiceConstants) {
        this.logService = logService;
        this.translateService = translateService;
        this.promiseUtils = promiseUtils;
        this.eventService = eventService;
        this.browserService = browserService;
        this.storageService = storageService;
        this.injector = injector;
        this.languageServiceConstants = languageServiceConstants;
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getBrowserLanguageIsoCode
     * @methodOf @smartutils.services:LanguageService
     *
     * @deprecated since 1808
     *
     * @description
     * Uses the browser's current locale to determine the selected language ISO code.
     *
     * @returns {String} The language ISO code of the browser's currently selected locale.
     */
    LanguageService.prototype.getBrowserLanguageIsoCode = function () {
        return window.navigator.language.split('-')[0];
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getBrowserLocale
     * @methodOf @smartutils.services:LanguageService
     *
     * @deprecated since 1808 - use browserService instead.
     *
     * @description
     * determines the browser locale in the format en_US
     *
     * @returns {string} the browser locale
     */
    LanguageService.prototype.getBrowserLocale = function () {
        return this.browserService.getBrowserLocale();
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getResolveLocale
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Resolve the user preference tooling locale. It determines in the
     * following order:
     *
     * 1. Check if the user has previously selected the language
     * 2. Check if the user browser locale is supported in the system
     *
     * @returns {Promise<string>} the locale
     */
    LanguageService.prototype.getResolveLocale = function () {
        return this._getDefaultLanguage();
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getResolveLocaleIsoCode
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Resolve the user preference tooling locale ISO code. i.e.: If the selected tooling language is 'en_US',
     * the resolved value will be 'en'.
     *
     * @returns {Promise<string>} A promise that resolves to the isocode of the tooling language.
     */
    LanguageService.prototype.getResolveLocaleIsoCode = function () {
        var _this = this;
        return this.getResolveLocale().then(function (resolveLocale) {
            return _this.convertBCP47TagToJavaTag(resolveLocale).split('_')[0];
        });
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getToolingLanguages
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Retrieves a list of language descriptors using REST calls to the i18n API.
     *
     * @returns {Promise<IToolingLanguage[]>} A promise that resolves to an array of IToolingLanguage.
     */
    LanguageService.prototype.getToolingLanguages = function () {
        var _this = this;
        return this.i18nLanguageRestService
            .get({})
            .then(function (response) {
            return response.languages;
        })
            .catch(function (error) {
            _this.logService.error('LanguageService.getToolingLanguages() - Error loading tooling languages');
            return Promise.reject(error);
        });
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#setSelectedToolingLanguage
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Set the user preference language in the storage service
     *
     * @param {IToolingLanguage} language the language object to be saved.
     */
    LanguageService.prototype.setSelectedToolingLanguage = function (language) {
        this.storageService.setValueInLocalStorage(SELECTED_LANGUAGE, language, false);
        this.translateService.use(language.isoCode);
        this.setApplicationTitle();
        this.eventService.publish(SWITCH_LANGUAGE_EVENT, {
            isoCode: language.isoCode
        });
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#registerSwitchLanguage
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Register a callback function to the gateway in order to switch the tooling language
     */
    LanguageService.prototype.registerSwitchLanguage = function () {
        var _this = this;
        this.eventService.subscribe(SWITCH_LANGUAGE_EVENT, function (eventId, language) {
            if (_this.translateService.currentLang !== language.isoCode) {
                _this.translateService.use(language.isoCode);
            }
        });
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#convertBCP47TagToJavaTag
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Method converts the BCP47 language tag representing the locale to the default java representation.
     * For example, method converts "en-US" to "en_US".
     *
     * @param {string} languageTag the language tag to be converted.
     *
     * @returns {string} the languageTag in java representation
     */
    LanguageService.prototype.convertBCP47TagToJavaTag = function (languageTag) {
        return !!languageTag ? languageTag.replace(/-/g, '_') : languageTag;
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#convertJavaTagToBCP47Tag
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Method converts the default java language tag representing the locale to the BCP47 representation.
     * For example, method converts "en_US" to "en-US".
     *
     * @param {string} languageTag the language tag to be converted.
     *
     * @returns {string} the languageTag in BCP47 representation
     */
    LanguageService.prototype.convertJavaTagToBCP47Tag = function (languageTag) {
        return !!languageTag ? languageTag.replace(/_/g, '-') : languageTag;
    };
    LanguageService.prototype._getDefaultLanguage = function () {
        var _this = this;
        return this.storageService.getValueFromLocalStorage(SELECTED_LANGUAGE, false).then(function (lang) {
            return lang ? lang.isoCode : _this.browserService.getBrowserLocale();
        }, function () {
            return _this.browserService.getBrowserLocale();
        });
    };
    LanguageService.prototype.setApplicationTitle = function () {
        this.translateService.get('se.application.name').subscribe(function (pageTitle) {
            document.title = pageTitle;
        });
    };
    Object.defineProperty(LanguageService.prototype, "i18nLanguageRestService", {
        get: function () {
            return this.injector
                .get(RestServiceFactory)
                .get(this.languageServiceConstants.I18N_LANGUAGES_RESOURCE_URI);
        },
        enumerable: true,
        configurable: true
    });
    LanguageService.ctorParameters = function () { return [
        { type: LogService },
        { type: TranslateService },
        { type: PromiseUtils },
        { type: undefined, decorators: [{ type: Inject, args: [EVENT_SERVICE,] }] },
        { type: BrowserService },
        { type: IStorageService },
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [LANGUAGE_SERVICE_CONSTANTS,] }] }
    ]; };
    tslib_1.__decorate([
        Cached({ actions: [rarelyChangingContent] }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", Promise)
    ], LanguageService.prototype, "getToolingLanguages", null);
    LanguageService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(3, Inject(EVENT_SERVICE)),
        tslib_1.__param(7, Inject(LANGUAGE_SERVICE_CONSTANTS)),
        tslib_1.__metadata("design:paramtypes", [LogService,
            TranslateService,
            PromiseUtils, Object, BrowserService,
            IStorageService,
            Injector, Object])
    ], LanguageService);
    return LanguageService;
}());
export { LanguageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2xhbmd1YWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQ0gsYUFBYSxFQUNiLDBCQUEwQixFQUMxQixpQkFBaUIsRUFDakIscUJBQXFCLEVBQ3hCLE1BQU0sY0FBYyxDQUFDO0FBRXRCLE9BQU8sRUFBRSxhQUFhLEVBQUUseUJBQXlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDM0MsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBcUMsa0JBQWtCLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQXFCeEM7Ozs7OztHQU1HO0FBRUg7OztHQUdHO0FBR0g7SUFDSSx5QkFDYyxVQUFzQixFQUN0QixnQkFBa0MsRUFDbEMsWUFBMEIsRUFDSCxZQUEyQixFQUNsRCxjQUE4QixFQUM5QixjQUErQixFQUMvQixRQUFrQixFQUVsQix3QkFBbUQ7UUFSbkQsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ0gsaUJBQVksR0FBWixZQUFZLENBQWU7UUFDbEQsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FB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Q0FBQzs7Ozs4REFhNUM7SUF2R1EsZUFBZTtRQUQzQixVQUFVLEVBQUU7UUFNSixtQkFBQSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUE7UUFJckIsbUJBQUEsTUFBTSxDQUFDLDBCQUEwQixDQUFDLENBQUE7aURBUGIsVUFBVTtZQUNKLGdCQUFnQjtZQUNwQixZQUFZLFVBRVYsY0FBYztZQUNkLGVBQWU7WUFDckIsUUFBUTtPQVJ2QixlQUFlLENBeU0zQjtJQUFELHNCQUFDO0NBQUEsQUF6TUQsSUF5TUM7U0F6TVksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEVWRU5UX1NFUlZJQ0UsXG4gICAgTEFOR1VBR0VfU0VSVklDRV9DT05TVEFOVFMsXG4gICAgU0VMRUNURURfTEFOR1VBR0UsXG4gICAgU1dJVENIX0xBTkdVQUdFX0VWRU5UXG59IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBQYXlsb2FkIH0gZnJvbSAnLi4vZHRvcyc7XG5pbXBvcnQgeyBJRXZlbnRTZXJ2aWNlLCBJTGFuZ3VhZ2VTZXJ2aWNlQ29uc3RhbnRzLCBJU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IEJyb3dzZXJTZXJ2aWNlIH0gZnJvbSAnLi9icm93c2VyJztcbmltcG9ydCB7IHJhcmVseUNoYW5naW5nQ29udGVudCwgQ2FjaGVkIH0gZnJvbSAnLi9jYWNoZSc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi9sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBJUmVzdFNlcnZpY2UsIElSZXN0U2VydmljZUZhY3RvcnksIFJlc3RTZXJ2aWNlRmFjdG9yeSB9IGZyb20gJy4vcmVzdCc7XG5pbXBvcnQgeyBQcm9taXNlVXRpbHMgfSBmcm9tICcuLi91dGlscyc7XG5cbi8qKlxuICogQG5nZG9jIGludGVyZmFjZVxuICogQG5hbWUgQHNtYXJ0dXRpbHMuaW50ZXJmYWNlczpJTGFuZ3VhZ2VcbiAqIEBkZXNjcmlwdGlvblxuICogSW50ZXJmYWNlIGZvciBsYW5ndWFnZSBpbmZvcm1hdGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIElMYW5ndWFnZSBleHRlbmRzIFBheWxvYWQge1xuICAgIGFjdGl2ZTogYm9vbGVhbjtcbiAgICBpc29jb2RlOiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIG5hdGl2ZU5hbWU6IHN0cmluZztcbiAgICByZXF1aXJlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJVG9vbGluZ0xhbmd1YWdlIGV4dGVuZHMgUGF5bG9hZCB7XG4gICAgaXNvQ29kZTogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbn1cblxuLyoqXG4gKiBAbmdkb2Mgb2JqZWN0XG4gKiBAbmFtZSByZXNvdXJjZUxvY2F0aW9uc01vZHVsZS5vYmplY3Q6TEFOR1VBR0VfUkVTT1VSQ0VfVVJJXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKiBSZXNvdXJjZSBVUkkgb2YgdGhlIGxhbmd1YWdlcyBSRVNUIHNlcnZpY2UuXG4gKi9cblxuLyoqXG4gKiBAbmdkb2Mgc2VydmljZVxuICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlXG4gKi9cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExhbmd1YWdlU2VydmljZSB7XG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHByb21pc2VVdGlsczogUHJvbWlzZVV0aWxzLFxuICAgICAgICBASW5qZWN0KEVWRU5UX1NFUlZJQ0UpIHByb3RlY3RlZCBldmVudFNlcnZpY2U6IElFdmVudFNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBicm93c2VyU2VydmljZTogQnJvd3NlclNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBzdG9yYWdlU2VydmljZTogSVN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgICAgICBASW5qZWN0KExBTkdVQUdFX1NFUlZJQ0VfQ09OU1RBTlRTKVxuICAgICAgICBwcm90ZWN0ZWQgbGFuZ3VhZ2VTZXJ2aWNlQ29uc3RhbnRzOiBJTGFuZ3VhZ2VTZXJ2aWNlQ29uc3RhbnRzXG4gICAgKSB7fVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNnZXRCcm93c2VyTGFuZ3VhZ2VJc29Db2RlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlcHJlY2F0ZWQgc2luY2UgMTgwOFxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogVXNlcyB0aGUgYnJvd3NlcidzIGN1cnJlbnQgbG9jYWxlIHRvIGRldGVybWluZSB0aGUgc2VsZWN0ZWQgbGFuZ3VhZ2UgSVNPIGNvZGUuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgbGFuZ3VhZ2UgSVNPIGNvZGUgb2YgdGhlIGJyb3dzZXIncyBjdXJyZW50bHkgc2VsZWN0ZWQgbG9jYWxlLlxuICAgICAqL1xuICAgIGdldEJyb3dzZXJMYW5ndWFnZUlzb0NvZGUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHdpbmRvdy5uYXZpZ2F0b3IubGFuZ3VhZ2Uuc3BsaXQoJy0nKVswXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlI2dldEJyb3dzZXJMb2NhbGVcbiAgICAgKiBAbWV0aG9kT2YgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlXG4gICAgICpcbiAgICAgKiBAZGVwcmVjYXRlZCBzaW5jZSAxODA4IC0gdXNlIGJyb3dzZXJTZXJ2aWNlIGluc3RlYWQuXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBkZXRlcm1pbmVzIHRoZSBicm93c2VyIGxvY2FsZSBpbiB0aGUgZm9ybWF0IGVuX1VTXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSB0aGUgYnJvd3NlciBsb2NhbGVcbiAgICAgKi9cbiAgICBnZXRCcm93c2VyTG9jYWxlKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmJyb3dzZXJTZXJ2aWNlLmdldEJyb3dzZXJMb2NhbGUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlI2dldFJlc29sdmVMb2NhbGVcbiAgICAgKiBAbWV0aG9kT2YgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXNvbHZlIHRoZSB1c2VyIHByZWZlcmVuY2UgdG9vbGluZyBsb2NhbGUuIEl0IGRldGVybWluZXMgaW4gdGhlXG4gICAgICogZm9sbG93aW5nIG9yZGVyOlxuICAgICAqXG4gICAgICogMS4gQ2hlY2sgaWYgdGhlIHVzZXIgaGFzIHByZXZpb3VzbHkgc2VsZWN0ZWQgdGhlIGxhbmd1YWdlXG4gICAgICogMi4gQ2hlY2sgaWYgdGhlIHVzZXIgYnJvd3NlciBsb2NhbGUgaXMgc3VwcG9ydGVkIGluIHRoZSBzeXN0ZW1cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IHRoZSBsb2NhbGVcbiAgICAgKi9cbiAgICBnZXRSZXNvbHZlTG9jYWxlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXREZWZhdWx0TGFuZ3VhZ2UoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlI2dldFJlc29sdmVMb2NhbGVJc29Db2RlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmVzb2x2ZSB0aGUgdXNlciBwcmVmZXJlbmNlIHRvb2xpbmcgbG9jYWxlIElTTyBjb2RlLiBpLmUuOiBJZiB0aGUgc2VsZWN0ZWQgdG9vbGluZyBsYW5ndWFnZSBpcyAnZW5fVVMnLFxuICAgICAqIHRoZSByZXNvbHZlZCB2YWx1ZSB3aWxsIGJlICdlbicuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byB0aGUgaXNvY29kZSBvZiB0aGUgdG9vbGluZyBsYW5ndWFnZS5cbiAgICAgKi9cbiAgICBnZXRSZXNvbHZlTG9jYWxlSXNvQ29kZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRSZXNvbHZlTG9jYWxlKCkudGhlbigocmVzb2x2ZUxvY2FsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJ0QkNQNDdUYWdUb0phdmFUYWcocmVzb2x2ZUxvY2FsZSkuc3BsaXQoJ18nKVswXTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNnZXRUb29saW5nTGFuZ3VhZ2VzXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0cmlldmVzIGEgbGlzdCBvZiBsYW5ndWFnZSBkZXNjcmlwdG9ycyB1c2luZyBSRVNUIGNhbGxzIHRvIHRoZSBpMThuIEFQSS5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPElUb29saW5nTGFuZ3VhZ2VbXT59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGFuIGFycmF5IG9mIElUb29saW5nTGFuZ3VhZ2UuXG4gICAgICovXG4gICAgQENhY2hlZCh7IGFjdGlvbnM6IFtyYXJlbHlDaGFuZ2luZ0NvbnRlbnRdIH0pXG4gICAgZ2V0VG9vbGluZ0xhbmd1YWdlcygpOiBQcm9taXNlPElUb29saW5nTGFuZ3VhZ2VbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pMThuTGFuZ3VhZ2VSZXN0U2VydmljZVxuICAgICAgICAgICAgLmdldCh7fSlcbiAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSEubGFuZ3VhZ2VzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5lcnJvcihcbiAgICAgICAgICAgICAgICAgICAgJ0xhbmd1YWdlU2VydmljZS5nZXRUb29saW5nTGFuZ3VhZ2VzKCkgLSBFcnJvciBsb2FkaW5nIHRvb2xpbmcgbGFuZ3VhZ2VzJ1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2Ujc2V0U2VsZWN0ZWRUb29saW5nTGFuZ3VhZ2VcbiAgICAgKiBAbWV0aG9kT2YgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBTZXQgdGhlIHVzZXIgcHJlZmVyZW5jZSBsYW5ndWFnZSBpbiB0aGUgc3RvcmFnZSBzZXJ2aWNlXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0lUb29saW5nTGFuZ3VhZ2V9IGxhbmd1YWdlIHRoZSBsYW5ndWFnZSBvYmplY3QgdG8gYmUgc2F2ZWQuXG4gICAgICovXG4gICAgc2V0U2VsZWN0ZWRUb29saW5nTGFuZ3VhZ2UobGFuZ3VhZ2U6IElUb29saW5nTGFuZ3VhZ2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdG9yYWdlU2VydmljZS5zZXRWYWx1ZUluTG9jYWxTdG9yYWdlKFNFTEVDVEVEX0xBTkdVQUdFLCBsYW5ndWFnZSwgZmFsc2UpO1xuICAgICAgICB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UudXNlKGxhbmd1YWdlLmlzb0NvZGUpO1xuICAgICAgICB0aGlzLnNldEFwcGxpY2F0aW9uVGl0bGUoKTtcbiAgICAgICAgdGhpcy5ldmVudFNlcnZpY2UucHVibGlzaChTV0lUQ0hfTEFOR1VBR0VfRVZFTlQsIHtcbiAgICAgICAgICAgIGlzb0NvZGU6IGxhbmd1YWdlLmlzb0NvZGVcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNyZWdpc3RlclN3aXRjaExhbmd1YWdlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmVnaXN0ZXIgYSBjYWxsYmFjayBmdW5jdGlvbiB0byB0aGUgZ2F0ZXdheSBpbiBvcmRlciB0byBzd2l0Y2ggdGhlIHRvb2xpbmcgbGFuZ3VhZ2VcbiAgICAgKi9cbiAgICByZWdpc3RlclN3aXRjaExhbmd1YWdlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmV2ZW50U2VydmljZS5zdWJzY3JpYmU8SVRvb2xpbmdMYW5ndWFnZT4oXG4gICAgICAgICAgICBTV0lUQ0hfTEFOR1VBR0VfRVZFTlQsXG4gICAgICAgICAgICAoZXZlbnRJZDogc3RyaW5nLCBsYW5ndWFnZT86IElUb29saW5nTGFuZ3VhZ2UpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFuc2xhdGVTZXJ2aWNlLmN1cnJlbnRMYW5nICE9PSBsYW5ndWFnZSEuaXNvQ29kZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UudXNlKGxhbmd1YWdlIS5pc29Db2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNjb252ZXJ0QkNQNDdUYWdUb0phdmFUYWdcbiAgICAgKiBAbWV0aG9kT2YgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBNZXRob2QgY29udmVydHMgdGhlIEJDUDQ3IGxhbmd1YWdlIHRhZyByZXByZXNlbnRpbmcgdGhlIGxvY2FsZSB0byB0aGUgZGVmYXVsdCBqYXZhIHJlcHJlc2VudGF0aW9uLlxuICAgICAqIEZvciBleGFtcGxlLCBtZXRob2QgY29udmVydHMgXCJlbi1VU1wiIHRvIFwiZW5fVVNcIi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsYW5ndWFnZVRhZyB0aGUgbGFuZ3VhZ2UgdGFnIHRvIGJlIGNvbnZlcnRlZC5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHRoZSBsYW5ndWFnZVRhZyBpbiBqYXZhIHJlcHJlc2VudGF0aW9uXG4gICAgICovXG4gICAgY29udmVydEJDUDQ3VGFnVG9KYXZhVGFnKGxhbmd1YWdlVGFnOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gISFsYW5ndWFnZVRhZyA/IGxhbmd1YWdlVGFnLnJlcGxhY2UoLy0vZywgJ18nKSA6IGxhbmd1YWdlVGFnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2UjY29udmVydEphdmFUYWdUb0JDUDQ3VGFnXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogTWV0aG9kIGNvbnZlcnRzIHRoZSBkZWZhdWx0IGphdmEgbGFuZ3VhZ2UgdGFnIHJlcHJlc2VudGluZyB0aGUgbG9jYWxlIHRvIHRoZSBCQ1A0NyByZXByZXNlbnRhdGlvbi5cbiAgICAgKiBGb3IgZXhhbXBsZSwgbWV0aG9kIGNvbnZlcnRzIFwiZW5fVVNcIiB0byBcImVuLVVTXCIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZ3VhZ2VUYWcgdGhlIGxhbmd1YWdlIHRhZyB0byBiZSBjb252ZXJ0ZWQuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSB0aGUgbGFuZ3VhZ2VUYWcgaW4gQkNQNDcgcmVwcmVzZW50YXRpb25cbiAgICAgKi9cbiAgICBjb252ZXJ0SmF2YVRhZ1RvQkNQNDdUYWcobGFuZ3VhZ2VUYWc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAhIWxhbmd1YWdlVGFnID8gbGFuZ3VhZ2VUYWcucmVwbGFjZSgvXy9nLCAnLScpIDogbGFuZ3VhZ2VUYWc7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9nZXREZWZhdWx0TGFuZ3VhZ2UoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0VmFsdWVGcm9tTG9jYWxTdG9yYWdlKFNFTEVDVEVEX0xBTkdVQUdFLCBmYWxzZSkudGhlbihcbiAgICAgICAgICAgIChsYW5nOiB7IG5hbWU6IHN0cmluZzsgaXNvQ29kZTogc3RyaW5nIH0pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbGFuZyA/IGxhbmcuaXNvQ29kZSA6IHRoaXMuYnJvd3NlclNlcnZpY2UuZ2V0QnJvd3NlckxvY2FsZSgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5icm93c2VyU2VydmljZS5nZXRCcm93c2VyTG9jYWxlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNldEFwcGxpY2F0aW9uVGl0bGUoKSB7XG4gICAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5nZXQoJ3NlLmFwcGxpY2F0aW9uLm5hbWUnKS5zdWJzY3JpYmUoKHBhZ2VUaXRsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldCBpMThuTGFuZ3VhZ2VSZXN0U2VydmljZSgpOiBJUmVzdFNlcnZpY2U8eyBsYW5ndWFnZXM6IElUb29saW5nTGFuZ3VhZ2VbXSB9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmluamVjdG9yXG4gICAgICAgICAgICAuZ2V0PElSZXN0U2VydmljZUZhY3Rvcnk+KFJlc3RTZXJ2aWNlRmFjdG9yeSlcbiAgICAgICAgICAgIC5nZXQ8eyBsYW5ndWFnZXM6IElUb29saW5nTGFuZ3VhZ2VbXSB9PihcbiAgICAgICAgICAgICAgICB0aGlzLmxhbmd1YWdlU2VydmljZUNvbnN0YW50cy5JMThOX0xBTkdVQUdFU19SRVNPVVJDRV9VUklcbiAgICAgICAgICAgICk7XG4gICAgfVxufVxuIl19