/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse, HttpRequest } from '@angular/common/http';
import { TranslateService } from '@ngx-translate/core';
import { IAlertService } from '../../../interfaces';
import { BooleanUtils } from '../../../utils';
import { clientErrorPredicate, noInternetConnectionErrorPredicate, readPredicate, retriableErrorPredicate, serverErrorPredicate, timeoutErrorPredicate, DefaultRetryStrategy, ExponentialRetryStrategy, IRetryStrategy, LinearRetryStrategy, OperationContextService } from './retries';
import { LIBRARY_NAME } from '../../../constants';
export var OPERATION_CONTEXT_TOKEN = LIBRARY_NAME + "_OPERATION_CONTEXT";
/**
 * @ngdoc service
 * @name @smartutils.services:retryInterceptor
 *
 * @description
 * The retryInterceptor provides the functionality to register a set of predicates with their associated retry strategies.
 * Each time an HTTP request fails, the service try to find a matching retry strategy for the given response.
 */
var RetryInterceptor = /** @class */ (function () {
    function RetryInterceptor(httpClient, translate, operationContextService, alertService, booleanUtils, defaultRetryStrategy, exponentialRetryStrategy, linearRetryStrategy, OPERATION_CONTEXT) {
        this.httpClient = httpClient;
        this.translate = translate;
        this.operationContextService = operationContextService;
        this.alertService = alertService;
        this.OPERATION_CONTEXT = OPERATION_CONTEXT;
        this.TRANSLATE_NAMESPACE = 'se.gracefuldegradation.';
        this.predicatesRegistry = [];
        this.requestToRetryTegistry = {};
        this.register(noInternetConnectionErrorPredicate, exponentialRetryStrategy)
            .register(booleanUtils.isAnyTruthy(clientErrorPredicate, timeoutErrorPredicate), defaultRetryStrategy)
            .register(booleanUtils.areAllTruthy(readPredicate, retriableErrorPredicate), defaultRetryStrategy)
            .register(serverErrorPredicate, exponentialRetryStrategy);
    }
    RetryInterceptor.prototype.predicate = function (request, response) {
        return this.findMatchingStrategy(request, response) !== null;
    };
    RetryInterceptor.prototype.responseError = function (request, response) {
        var retryStrategy = this.retrieveRetryStrategy(request);
        if (!retryStrategy) {
            var StrategyHolder = this.findMatchingStrategy(request, response);
            if (StrategyHolder) {
                this.alertService.showWarning({
                    message: this.translate.instant(this.TRANSLATE_NAMESPACE + 'stillworking')
                });
                retryStrategy = new StrategyHolder();
                retryStrategy.attemptCount = 0;
                this.storeRetryStrategy(request, retryStrategy);
            }
            else {
                return Promise.reject(response);
            }
        }
        return this.handleRetry(retryStrategy, request, response);
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:retryInterceptor#register
     * @methodOf @smartutils.services:retryInterceptor
     *
     * @description
     * Register a new predicate with it's associated strategyHolder.
     *
     * @param {Function} predicate This function takes the 'response' {Object} argument and an (optional) operationContext {String}. This function must return a Boolean that is true if the given response match the predicate.
     * @param {Function} retryStrategy This function will be instanciated at run-time. See {@link @smartutils.services:IRetryStrategy IRetryStrategy}.
     *
     * @return {Object} retryInterceptor The retryInterceptor service.
     *
     * @example
     * ```js
     *      var customPredicate = function(request, response, operationContext) {
     *          return response.status === 500 && operationContext === OPERATION_CONTEXT.TOOLING;
     *      };
     *      var StrategyHolder = function() {
     *          // set the firstFastRetry value to true for the retry made immediately only for the very first retry (subsequent retries will remain subject to the calculateNextDelay response)
     *          this.firstFastRetry = true;
     *      };
     *      StrategyHolder.prototype.canRetry = function() {
     *          // this function must return a {Boolean} if the given request must be retried.
     *          // use this.attemptCount value to determine if the function should return true or false
     *      };
     *      StrategyHolder.prototype.calculateNextDelay = function() {
     *          // this function must return the next delay time {Number}
     *          // use this.attemptCount value to determine the next delay value
     *      };
     *      retryInterceptor.register(customPredicate, StrategyHolder);
     * ```
     */
    RetryInterceptor.prototype.register = function (predicate, retryStrategy) {
        if (typeof predicate !== 'function') {
            throw new Error('retryInterceptor.register error: predicate must be a function');
        }
        if (typeof retryStrategy !== 'function') {
            throw new Error('retryInterceptor.register error: retryStrategy must be a function');
        }
        this.predicatesRegistry.unshift({
            predicate: predicate,
            retryStrategy: retryStrategy
        });
        return this;
    };
    /**
     * Find a matching strategy for the given response and (optional) operationContext
     * If not provided, the default operationContext is OPERATION_CONTEXT.INTERACTIVE
     *
     * @param {Object} response The http response object
     *
     * @return {Function} The matching retryStrategy
     */
    RetryInterceptor.prototype.findMatchingStrategy = function (request, response) {
        var operationContext = this.operationContextService.findOperationContext(request.url) ||
            this.OPERATION_CONTEXT.INTERACTIVE;
        var matchStrategy = this.predicatesRegistry.find(function (predicateObj) {
            return predicateObj.predicate(request, response, operationContext);
        });
        return matchStrategy ? matchStrategy.retryStrategy : null;
    };
    RetryInterceptor.prototype.handleRetry = function (retryStrategy, request, response) {
        var _this = this;
        retryStrategy.attemptCount++;
        if (retryStrategy.canRetry()) {
            var delay_1 = retryStrategy.firstFastRetry ? 0 : retryStrategy.calculateNextDelay();
            retryStrategy.firstFastRetry = false;
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    _this.httpClient
                        .request(request)
                        .toPromise()
                        .then(function (result) {
                        _this.removeRetryStrategy(request);
                        return resolve(result);
                    }, function (error) { return reject(error); });
                }, delay_1);
            });
        }
        else {
            this.alertService.showDanger({
                message: this.translate.instant(this.TRANSLATE_NAMESPACE + 'somethingwrong')
            });
            return Promise.reject(response);
        }
    };
    RetryInterceptor.prototype.storeRetryStrategy = function (request, retryStrategy) {
        this.requestToRetryTegistry[this.getRequestUUID(request)] = retryStrategy;
    };
    RetryInterceptor.prototype.removeRetryStrategy = function (request) {
        delete this.requestToRetryTegistry[this.getRequestUUID(request)];
    };
    RetryInterceptor.prototype.retrieveRetryStrategy = function (request) {
        return this.requestToRetryTegistry[this.getRequestUUID(request)];
    };
    RetryInterceptor.prototype.getRequestUUID = function (request) {
        return request.clone().toString();
    };
    RetryInterceptor.ctorParameters = function () { return [
        { type: HttpClient },
        { type: TranslateService },
        { type: OperationContextService },
        { type: IAlertService },
        { type: BooleanUtils },
        { type: undefined, decorators: [{ type: Inject, args: [DefaultRetryStrategy,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [ExponentialRetryStrategy,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [LinearRetryStrategy,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [OPERATION_CONTEXT_TOKEN,] }] }
    ]; };
    RetryInterceptor = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(5, Inject(DefaultRetryStrategy)),
        tslib_1.__param(6, Inject(ExponentialRetryStrategy)),
        tslib_1.__param(7, Inject(LinearRetryStrategy)),
        tslib_1.__param(8, Inject(OPERATION_CONTEXT_TOKEN)),
        tslib_1.__metadata("design:paramtypes", [HttpClient,
            TranslateService,
            OperationContextService,
            IAlertService,
            BooleanUtils, Object, Object, Object, Object])
    ], RetryInterceptor);
    return RetryInterceptor;
}());
export { RetryInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV0cnkuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac21hcnQvdXRpbHMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9pbnRlcmNlcHRvcnMvZXJyb3JzL3JldHJ5LmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7QUFDSCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHOUMsT0FBTyxFQUNILG9CQUFvQixFQUNwQixrQ0FBa0MsRUFDbEMsYUFBYSxFQUNiLHVCQUF1QixFQUN2QixvQkFBb0IsRUFDcEIscUJBQXFCLEVBQ3JCLG9CQUFvQixFQUNwQix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLG1CQUFtQixFQUNuQix1QkFBdUIsRUFDMUIsTUFBTSxXQUFXLENBQUM7QUFTbkIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRWxELE1BQU0sQ0FBQyxJQUFNLHVCQUF1QixHQUFNLFlBQVksdUJBQW9CLENBQUM7QUFFM0U7Ozs7Ozs7R0FPRztBQUVIO0lBVUksMEJBQ1ksVUFBc0IsRUFDdEIsU0FBMkIsRUFDM0IsdUJBQWdELEVBQ2hELFlBQTJCLEVBQ25DLFlBQTBCLEVBQ0ksb0JBQTJDLEVBQ3ZDLHdCQUErQyxFQUNwRCxtQkFBMEMsRUFDOUIsaUJBQW1DO1FBUnBFLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsNEJBQXVCLEdBQXZCLHVCQUF1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O09BZnJCLGdCQUFnQixDQXdLNUI7SUFBRCx1QkFBQztDQUFBLEFBeEtELElBd0tDO1NBeEtZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cFJlcXVlc3QgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBJQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBCb29sZWFuVXRpbHMgfSBmcm9tICcuLi8uLi8uLi91dGlscyc7XG5pbXBvcnQgeyBUeXBlZE1hcCB9IGZyb20gJy4uLy4uLy4uL2R0b3MnO1xuaW1wb3J0IHsgQ2xhc3MgfSBmcm9tICcuLi8uLi8uLi90eXBlcyc7XG5pbXBvcnQge1xuICAgIGNsaWVudEVycm9yUHJlZGljYXRlLFxuICAgIG5vSW50ZXJuZXRDb25uZWN0aW9uRXJyb3JQcmVkaWNhdGUsXG4gICAgcmVhZFByZWRpY2F0ZSxcbiAgICByZXRyaWFibGVFcnJvclByZWRpY2F0ZSxcbiAgICBzZXJ2ZXJFcnJvclByZWRpY2F0ZSxcbiAgICB0aW1lb3V0RXJyb3JQcmVkaWNhdGUsXG4gICAgRGVmYXVsdFJldHJ5U3RyYXRlZ3ksXG4gICAgRXhwb25lbnRpYWxSZXRyeVN0cmF0ZWd5LFxuICAgIElSZXRyeVN0cmF0ZWd5LFxuICAgIExpbmVhclJldHJ5U3RyYXRlZ3ksXG4gICAgT3BlcmF0aW9uQ29udGV4dFNlcnZpY2Vcbn0gZnJvbSAnLi9yZXRyaWVzJztcbmltcG9ydCB7IElIdHRwRXJyb3JJbnRlcmNlcHRvciB9IGZyb20gJy4uL2ktaHR0cC1lcnJvci5pbnRlcmNlcHRvcic7XG5cbmV4cG9ydCB0eXBlIFJldHJ5UHJlZGljYXRlID0gKFxuICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgcmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlLFxuICAgIG9wZXJhdGlvbkNvbnRleHQ/OiBzdHJpbmdcbikgPT4gYm9vbGVhbjtcblxuaW1wb3J0IHsgTElCUkFSWV9OQU1FIH0gZnJvbSAnLi4vLi4vLi4vY29uc3RhbnRzJztcblxuZXhwb3J0IGNvbnN0IE9QRVJBVElPTl9DT05URVhUX1RPS0VOID0gYCR7TElCUkFSWV9OQU1FfV9PUEVSQVRJT05fQ09OVEVYVGA7XG5cbi8qKlxuICogQG5nZG9jIHNlcnZpY2VcbiAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOnJldHJ5SW50ZXJjZXB0b3JcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqIFRoZSByZXRyeUludGVyY2VwdG9yIHByb3ZpZGVzIHRoZSBmdW5jdGlvbmFsaXR5IHRvIHJlZ2lzdGVyIGEgc2V0IG9mIHByZWRpY2F0ZXMgd2l0aCB0aGVpciBhc3NvY2lhdGVkIHJldHJ5IHN0cmF0ZWdpZXMuXG4gKiBFYWNoIHRpbWUgYW4gSFRUUCByZXF1ZXN0IGZhaWxzLCB0aGUgc2VydmljZSB0cnkgdG8gZmluZCBhIG1hdGNoaW5nIHJldHJ5IHN0cmF0ZWd5IGZvciB0aGUgZ2l2ZW4gcmVzcG9uc2UuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXRyeUludGVyY2VwdG9yPFQgPSBhbnk+IGltcGxlbWVudHMgSUh0dHBFcnJvckludGVyY2VwdG9yPFQ+IHtcbiAgICBwcml2YXRlIFRSQU5TTEFURV9OQU1FU1BBQ0UgPSAnc2UuZ3JhY2VmdWxkZWdyYWRhdGlvbi4nO1xuXG4gICAgcHJpdmF0ZSBwcmVkaWNhdGVzUmVnaXN0cnk6IHtcbiAgICAgICAgcHJlZGljYXRlOiBSZXRyeVByZWRpY2F0ZTtcbiAgICAgICAgcmV0cnlTdHJhdGVneTogQ2xhc3M8SVJldHJ5U3RyYXRlZ3k+O1xuICAgIH1bXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSByZXF1ZXN0VG9SZXRyeVRlZ2lzdHJ5OiBUeXBlZE1hcDxJUmV0cnlTdHJhdGVneT4gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgICAgIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG9wZXJhdGlvbkNvbnRleHRTZXJ2aWNlOiBPcGVyYXRpb25Db250ZXh0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IElBbGVydFNlcnZpY2UsXG4gICAgICAgIGJvb2xlYW5VdGlsczogQm9vbGVhblV0aWxzLFxuICAgICAgICBASW5qZWN0KERlZmF1bHRSZXRyeVN0cmF0ZWd5KSBkZWZhdWx0UmV0cnlTdHJhdGVneTogQ2xhc3M8SVJldHJ5U3RyYXRlZ3k+LFxuICAgICAgICBASW5qZWN0KEV4cG9uZW50aWFsUmV0cnlTdHJhdGVneSkgZXhwb25lbnRpYWxSZXRyeVN0cmF0ZWd5OiBDbGFzczxJUmV0cnlTdHJhdGVneT4sXG4gICAgICAgIEBJbmplY3QoTGluZWFyUmV0cnlTdHJhdGVneSkgbGluZWFyUmV0cnlTdHJhdGVneTogQ2xhc3M8SVJldHJ5U3RyYXRlZ3k+LFxuICAgICAgICBASW5qZWN0KE9QRVJBVElPTl9DT05URVhUX1RPS0VOKSBwcml2YXRlIE9QRVJBVElPTl9DT05URVhUOiBUeXBlZE1hcDxzdHJpbmc+XG4gICAgKSB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXIobm9JbnRlcm5ldENvbm5lY3Rpb25FcnJvclByZWRpY2F0ZSwgZXhwb25lbnRpYWxSZXRyeVN0cmF0ZWd5KVxuICAgICAgICAgICAgLnJlZ2lzdGVyKFxuICAgICAgICAgICAgICAgIGJvb2xlYW5VdGlscy5pc0FueVRydXRoeShjbGllbnRFcnJvclByZWRpY2F0ZSwgdGltZW91dEVycm9yUHJlZGljYXRlKSxcbiAgICAgICAgICAgICAgICBkZWZhdWx0UmV0cnlTdHJhdGVneVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnJlZ2lzdGVyKFxuICAgICAgICAgICAgICAgIGJvb2xlYW5VdGlscy5hcmVBbGxUcnV0aHkocmVhZFByZWRpY2F0ZSwgcmV0cmlhYmxlRXJyb3JQcmVkaWNhdGUpLFxuICAgICAgICAgICAgICAgIGRlZmF1bHRSZXRyeVN0cmF0ZWd5XG4gICAgICAgICAgICApXG4gICAgICAgICAgICAucmVnaXN0ZXIoc2VydmVyRXJyb3JQcmVkaWNhdGUsIGV4cG9uZW50aWFsUmV0cnlTdHJhdGVneSk7XG4gICAgfVxuXG4gICAgcHJlZGljYXRlKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PFQ+LCByZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZE1hdGNoaW5nU3RyYXRlZ3kocmVxdWVzdCwgcmVzcG9uc2UpICE9PSBudWxsO1xuICAgIH1cblxuICAgIHJlc3BvbnNlRXJyb3IocmVxdWVzdDogSHR0cFJlcXVlc3Q8VD4sIHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGxldCByZXRyeVN0cmF0ZWd5ID0gdGhpcy5yZXRyaWV2ZVJldHJ5U3RyYXRlZ3kocmVxdWVzdCk7XG4gICAgICAgIGlmICghcmV0cnlTdHJhdGVneSkge1xuICAgICAgICAgICAgY29uc3QgU3RyYXRlZ3lIb2xkZXIgPSB0aGlzLmZpbmRNYXRjaGluZ1N0cmF0ZWd5KHJlcXVlc3QsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGlmIChTdHJhdGVneUhvbGRlcikge1xuICAgICAgICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnNob3dXYXJuaW5nKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogdGhpcy50cmFuc2xhdGUuaW5zdGFudCh0aGlzLlRSQU5TTEFURV9OQU1FU1BBQ0UgKyAnc3RpbGx3b3JraW5nJylcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXRyeVN0cmF0ZWd5ID0gbmV3IFN0cmF0ZWd5SG9sZGVyKCk7XG4gICAgICAgICAgICAgICAgcmV0cnlTdHJhdGVneS5hdHRlbXB0Q291bnQgPSAwO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmVSZXRyeVN0cmF0ZWd5KHJlcXVlc3QsIHJldHJ5U3RyYXRlZ3kpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVzcG9uc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmhhbmRsZVJldHJ5KHJldHJ5U3RyYXRlZ3ksIHJlcXVlc3QsIHJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6cmV0cnlJbnRlcmNlcHRvciNyZWdpc3RlclxuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpyZXRyeUludGVyY2VwdG9yXG4gICAgICpcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZWdpc3RlciBhIG5ldyBwcmVkaWNhdGUgd2l0aCBpdCdzIGFzc29jaWF0ZWQgc3RyYXRlZ3lIb2xkZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkaWNhdGUgVGhpcyBmdW5jdGlvbiB0YWtlcyB0aGUgJ3Jlc3BvbnNlJyB7T2JqZWN0fSBhcmd1bWVudCBhbmQgYW4gKG9wdGlvbmFsKSBvcGVyYXRpb25Db250ZXh0IHtTdHJpbmd9LiBUaGlzIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGEgQm9vbGVhbiB0aGF0IGlzIHRydWUgaWYgdGhlIGdpdmVuIHJlc3BvbnNlIG1hdGNoIHRoZSBwcmVkaWNhdGUuXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcmV0cnlTdHJhdGVneSBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgaW5zdGFuY2lhdGVkIGF0IHJ1bi10aW1lLiBTZWUge0BsaW5rIEBzbWFydHV0aWxzLnNlcnZpY2VzOklSZXRyeVN0cmF0ZWd5IElSZXRyeVN0cmF0ZWd5fS5cbiAgICAgKlxuICAgICAqIEByZXR1cm4ge09iamVjdH0gcmV0cnlJbnRlcmNlcHRvciBUaGUgcmV0cnlJbnRlcmNlcHRvciBzZXJ2aWNlLlxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGBqc1xuICAgICAqICAgICAgdmFyIGN1c3RvbVByZWRpY2F0ZSA9IGZ1bmN0aW9uKHJlcXVlc3QsIHJlc3BvbnNlLCBvcGVyYXRpb25Db250ZXh0KSB7XG4gICAgICogICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyA9PT0gNTAwICYmIG9wZXJhdGlvbkNvbnRleHQgPT09IE9QRVJBVElPTl9DT05URVhULlRPT0xJTkc7XG4gICAgICogICAgICB9O1xuICAgICAqICAgICAgdmFyIFN0cmF0ZWd5SG9sZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgICogICAgICAgICAgLy8gc2V0IHRoZSBmaXJzdEZhc3RSZXRyeSB2YWx1ZSB0byB0cnVlIGZvciB0aGUgcmV0cnkgbWFkZSBpbW1lZGlhdGVseSBvbmx5IGZvciB0aGUgdmVyeSBmaXJzdCByZXRyeSAoc3Vic2VxdWVudCByZXRyaWVzIHdpbGwgcmVtYWluIHN1YmplY3QgdG8gdGhlIGNhbGN1bGF0ZU5leHREZWxheSByZXNwb25zZSlcbiAgICAgKiAgICAgICAgICB0aGlzLmZpcnN0RmFzdFJldHJ5ID0gdHJ1ZTtcbiAgICAgKiAgICAgIH07XG4gICAgICogICAgICBTdHJhdGVneUhvbGRlci5wcm90b3R5cGUuY2FuUmV0cnkgPSBmdW5jdGlvbigpIHtcbiAgICAgKiAgICAgICAgICAvLyB0aGlzIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGEge0Jvb2xlYW59IGlmIHRoZSBnaXZlbiByZXF1ZXN0IG11c3QgYmUgcmV0cmllZC5cbiAgICAgKiAgICAgICAgICAvLyB1c2UgdGhpcy5hdHRlbXB0Q291bnQgdmFsdWUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIHRydWUgb3IgZmFsc2VcbiAgICAgKiAgICAgIH07XG4gICAgICogICAgICBTdHJhdGVneUhvbGRlci5wcm90b3R5cGUuY2FsY3VsYXRlTmV4dERlbGF5ID0gZnVuY3Rpb24oKSB7XG4gICAgICogICAgICAgICAgLy8gdGhpcyBmdW5jdGlvbiBtdXN0IHJldHVybiB0aGUgbmV4dCBkZWxheSB0aW1lIHtOdW1iZXJ9XG4gICAgICogICAgICAgICAgLy8gdXNlIHRoaXMuYXR0ZW1wdENvdW50IHZhbHVlIHRvIGRldGVybWluZSB0aGUgbmV4dCBkZWxheSB2YWx1ZVxuICAgICAqICAgICAgfTtcbiAgICAgKiAgICAgIHJldHJ5SW50ZXJjZXB0b3IucmVnaXN0ZXIoY3VzdG9tUHJlZGljYXRlLCBTdHJhdGVneUhvbGRlcik7XG4gICAgICogYGBgXG4gICAgICovXG4gICAgcmVnaXN0ZXIocHJlZGljYXRlOiBSZXRyeVByZWRpY2F0ZSwgcmV0cnlTdHJhdGVneTogQ2xhc3M8SVJldHJ5U3RyYXRlZ3k+KTogUmV0cnlJbnRlcmNlcHRvcjxUPiB7XG4gICAgICAgIGlmICh0eXBlb2YgcHJlZGljYXRlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3JldHJ5SW50ZXJjZXB0b3IucmVnaXN0ZXIgZXJyb3I6IHByZWRpY2F0ZSBtdXN0IGJlIGEgZnVuY3Rpb24nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHJldHJ5U3RyYXRlZ3kgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncmV0cnlJbnRlcmNlcHRvci5yZWdpc3RlciBlcnJvcjogcmV0cnlTdHJhdGVneSBtdXN0IGJlIGEgZnVuY3Rpb24nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnByZWRpY2F0ZXNSZWdpc3RyeS51bnNoaWZ0KHtcbiAgICAgICAgICAgIHByZWRpY2F0ZSxcbiAgICAgICAgICAgIHJldHJ5U3RyYXRlZ3lcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBtYXRjaGluZyBzdHJhdGVneSBmb3IgdGhlIGdpdmVuIHJlc3BvbnNlIGFuZCAob3B0aW9uYWwpIG9wZXJhdGlvbkNvbnRleHRcbiAgICAgKiBJZiBub3QgcHJvdmlkZWQsIHRoZSBkZWZhdWx0IG9wZXJhdGlvbkNvbnRleHQgaXMgT1BFUkFUSU9OX0NPTlRFWFQuSU5URVJBQ1RJVkVcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSBUaGUgaHR0cCByZXNwb25zZSBvYmplY3RcbiAgICAgKlxuICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgbWF0Y2hpbmcgcmV0cnlTdHJhdGVneVxuICAgICAqL1xuICAgIHByaXZhdGUgZmluZE1hdGNoaW5nU3RyYXRlZ3koXG4gICAgICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgICAgIHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZVxuICAgICk6IENsYXNzPElSZXRyeVN0cmF0ZWd5PiB8IG51bGwge1xuICAgICAgICBjb25zdCBvcGVyYXRpb25Db250ZXh0ID1cbiAgICAgICAgICAgIHRoaXMub3BlcmF0aW9uQ29udGV4dFNlcnZpY2UuZmluZE9wZXJhdGlvbkNvbnRleHQocmVxdWVzdC51cmwpIHx8XG4gICAgICAgICAgICB0aGlzLk9QRVJBVElPTl9DT05URVhULklOVEVSQUNUSVZFO1xuICAgICAgICBjb25zdCBtYXRjaFN0cmF0ZWd5ID0gdGhpcy5wcmVkaWNhdGVzUmVnaXN0cnkuZmluZCgocHJlZGljYXRlT2JqKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcHJlZGljYXRlT2JqLnByZWRpY2F0ZShyZXF1ZXN0LCByZXNwb25zZSwgb3BlcmF0aW9uQ29udGV4dCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbWF0Y2hTdHJhdGVneSA/IG1hdGNoU3RyYXRlZ3kucmV0cnlTdHJhdGVneSA6IG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVSZXRyeShcbiAgICAgICAgcmV0cnlTdHJhdGVneTogSVJldHJ5U3RyYXRlZ3ksXG4gICAgICAgIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgICAgIHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZVxuICAgICk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHJ5U3RyYXRlZ3kuYXR0ZW1wdENvdW50Kys7XG4gICAgICAgIGlmIChyZXRyeVN0cmF0ZWd5LmNhblJldHJ5KCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGRlbGF5ID0gcmV0cnlTdHJhdGVneS5maXJzdEZhc3RSZXRyeSA/IDAgOiByZXRyeVN0cmF0ZWd5LmNhbGN1bGF0ZU5leHREZWxheSgpO1xuICAgICAgICAgICAgcmV0cnlTdHJhdGVneS5maXJzdEZhc3RSZXRyeSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgICAgICAgICAgICAgICAucmVxdWVzdChyZXF1ZXN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVSZXRyeVN0cmF0ZWd5KHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yOiBhbnkpID0+IHJlamVjdChlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSwgZGVsYXkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5zaG93RGFuZ2VyKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuVFJBTlNMQVRFX05BTUVTUEFDRSArICdzb21ldGhpbmd3cm9uZycpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChyZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0b3JlUmV0cnlTdHJhdGVneShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCByZXRyeVN0cmF0ZWd5OiBJUmV0cnlTdHJhdGVneSk6IHZvaWQge1xuICAgICAgICB0aGlzLnJlcXVlc3RUb1JldHJ5VGVnaXN0cnlbdGhpcy5nZXRSZXF1ZXN0VVVJRChyZXF1ZXN0KV0gPSByZXRyeVN0cmF0ZWd5O1xuICAgIH1cbiAgICBwcml2YXRlIHJlbW92ZVJldHJ5U3RyYXRlZ3kocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IHZvaWQge1xuICAgICAgICBkZWxldGUgdGhpcy5yZXF1ZXN0VG9SZXRyeVRlZ2lzdHJ5W3RoaXMuZ2V0UmVxdWVzdFVVSUQocmVxdWVzdCldO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmV0cmlldmVSZXRyeVN0cmF0ZWd5KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBJUmV0cnlTdHJhdGVneSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RUb1JldHJ5VGVnaXN0cnlbdGhpcy5nZXRSZXF1ZXN0VVVJRChyZXF1ZXN0KV07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZXF1ZXN0VVVJRChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoKS50b1N0cmluZygpO1xuICAgIH1cbn1cbiJdfQ==