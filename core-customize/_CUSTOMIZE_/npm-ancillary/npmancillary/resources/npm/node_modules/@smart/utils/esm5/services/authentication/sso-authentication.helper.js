/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Deferred, PromiseUtils, WindowUtils } from '../../utils';
var SSO_DIALOG_MARKER = 'sso';
var SSO_PROPERTIES;
(function (SSO_PROPERTIES) {
    SSO_PROPERTIES["SSO_CLIENT_ID"] = "SSO_CLIENT_ID";
    SSO_PROPERTIES["SSO_AUTHENTICATION_ENTRY_POINT"] = "SSO_AUTHENTICATION_ENTRY_POINT";
    SSO_PROPERTIES["SSO_LOGOUT_ENTRY_POINT"] = "SSO_LOGOUT_ENTRY_POINT";
    SSO_PROPERTIES["SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT"] = "SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT";
})(SSO_PROPERTIES || (SSO_PROPERTIES = {}));
var CHILD_SMARTEDIT_SENDING_AUTHTOKEN = 'ssoAuthenticate';
var CHILD_SMARTEDIT_SENDING_AUTH_ERROR = 'ssoAuthenticateError';
var SSODIALOG_WINDOW = 'SSODIALOG_WINDOW';
/*
 * Helper to initiate a SAML /SSO autentication sequence through a pop-up
 * (because the sequence involves auto-submiting html form at some point that causes a redirect and hence would
 * loose app context if not executed in a different window)
 * that ultimately loads the app again which in turn will detect its context and do the following:
 * - will not continue loading
 * - wil post the loginToken to the /authenticate end point to retrieve oAuth access
 * - will send back to parent (through postMessage) the retrieved oAuth access
 * - will close;
 */
var SSOAuthenticationHelper = /** @class */ (function () {
    function SSOAuthenticationHelper(windowUtils, promiseUtils, httpClient, injector) {
        this.windowUtils = windowUtils;
        this.promiseUtils = promiseUtils;
        this.httpClient = httpClient;
        this.injector = injector;
        this.logoutIframeId = 'logoutIframe';
        this.deferred = null;
        this.listenForAuthTokenBeingSentBack();
    }
    SSOAuthenticationHelper_1 = SSOAuthenticationHelper;
    /*
     * Initiates the SSO dialog through a pop-up
     */
    SSOAuthenticationHelper.prototype.launchSSODialog = function () {
        this.deferred = this.promiseUtils.defer();
        var ssoAuthenticationEntryPoint = this.injector.get(SSO_PROPERTIES.SSO_AUTHENTICATION_ENTRY_POINT) +
            this.getSSOContextPath();
        this.window.open(ssoAuthenticationEntryPoint, SSODIALOG_WINDOW, 'toolbar=no,scrollbars=no,resizable=no,top=200,left=200,width=1000,height=800');
        return this.deferred.promise;
    };
    /*
     * SSO happen in a popup window launched by AuthenticationHelper#launchSSODialog().
     * Once SSO is successful, a 'LoginToken' cookie is present, this is a pre-requisite for doing a POST to the /authenticate
     * endpoint that will return the Authorization bearer token.
     * This bearer is then sent with postMessage to the opener window, i.e. the SmartEdit application that will resume the pending 401 request.
     */
    SSOAuthenticationHelper.prototype.completeDialog = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.httpClient
                .post(_this.injector.get(SSO_PROPERTIES.SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT), { client_id: _this.injector.get(SSO_PROPERTIES.SSO_CLIENT_ID) })
                .subscribe(function (authToken) {
                _this.window.opener.postMessage({
                    eventId: CHILD_SMARTEDIT_SENDING_AUTHTOKEN,
                    authToken: authToken
                }, _this.document.location.origin);
                _this.window.close();
                resolve();
            }, function (httpErrorResponse) {
                var clonableHttpErrorResponse = {
                    error: httpErrorResponse.error,
                    status: httpErrorResponse.status
                };
                _this.window.opener.postMessage({
                    eventId: CHILD_SMARTEDIT_SENDING_AUTH_ERROR,
                    error: clonableHttpErrorResponse
                }, _this.document.location.origin);
                _this.window.close();
                reject();
            });
        });
    };
    /*
     * case of the App being a popup only meant for authentication and spun up buy the main app
     */
    SSOAuthenticationHelper.prototype.isSSODialog = function () {
        return (this.window.name === SSODIALOG_WINDOW &&
            new RegExp("[?&]" + SSO_DIALOG_MARKER).test(location.search));
    };
    /*
     * case of:
     * - the App called from another app in an SSO context and that should therefore auto-authenticate with SSO
     * - last manual authentication was with SSO
     */
    SSOAuthenticationHelper.prototype.isAutoSSOMain = function () {
        return (SSOAuthenticationHelper_1.lastAuthenticatedWithSSO ||
            (this.window.name !== SSODIALOG_WINDOW &&
                new RegExp("[?&]" + SSO_DIALOG_MARKER).test(location.search)));
    };
    SSOAuthenticationHelper.prototype.logout = function () {
        var logoutIframe = this.logoutIframe;
        if (!logoutIframe) {
            logoutIframe = this.document.createElement('iframe');
            logoutIframe.id = this.logoutIframeId;
            logoutIframe.style.display = 'none';
            this.document.body.appendChild(logoutIframe);
        }
        logoutIframe.src = this.injector.get(SSO_PROPERTIES.SSO_LOGOUT_ENTRY_POINT);
        SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = false;
        this.document.location.href = this.document.location.href.replace(this.getSSOContextPath(), this.document.location.pathname);
    };
    // context path of app in an SSO mode
    SSOAuthenticationHelper.prototype.getSSOContextPath = function () {
        return this.document.location.pathname + "?" + SSO_DIALOG_MARKER;
    };
    SSOAuthenticationHelper.prototype.listenForAuthTokenBeingSentBack = function () {
        var _this = this;
        this.window.addEventListener('message', function (event) {
            if (event.origin !== document.location.origin) {
                return;
            }
            _this.logoutIframe && _this.logoutIframe.remove();
            if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTHTOKEN) {
                SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = true;
                _this.deferred && _this.deferred.resolve(event.data.authToken);
            }
            else if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTH_ERROR) {
                _this.deferred && _this.deferred.reject(event.data.error);
            }
        }, false);
    };
    Object.defineProperty(SSOAuthenticationHelper.prototype, "window", {
        get: function () {
            return this.windowUtils.getWindow();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SSOAuthenticationHelper.prototype, "document", {
        get: function () {
            return this.window.document;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SSOAuthenticationHelper.prototype, "logoutIframe", {
        get: function () {
            return this.document.querySelector("iframe#" + this.logoutIframeId);
        },
        enumerable: true,
        configurable: true
    });
    var SSOAuthenticationHelper_1;
    // static in order to be shared by multiple instances
    SSOAuthenticationHelper.lastAuthenticatedWithSSO = false;
    SSOAuthenticationHelper.ctorParameters = function () { return [
        { type: WindowUtils },
        { type: PromiseUtils },
        { type: HttpClient },
        { type: Injector }
    ]; };
    SSOAuthenticationHelper = SSOAuthenticationHelper_1 = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [WindowUtils,
            PromiseUtils,
            HttpClient,
            Injector])
    ], SSOAuthenticationHelper);
    return SSOAuthenticationHelper;
}());
export { SSOAuthenticationHelper };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NvLWF1dGhlbnRpY2F0aW9uLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2F1dGhlbnRpY2F0aW9uL3Nzby1hdXRoZW50aWNhdGlvbi5oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVyRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFbEUsSUFBTSxpQkFBaUIsR0FBRyxLQUFLLENBQUM7QUFFaEMsSUFBSyxjQUtKO0FBTEQsV0FBSyxjQUFjO0lBQ2YsaURBQStCLENBQUE7SUFDL0IsbUZBQWlFLENBQUE7SUFDakUsbUVBQWlELENBQUE7SUFDakQsaUdBQStFLENBQUE7QUFDbkYsQ0FBQyxFQUxJLGNBQWMsS0FBZCxjQUFjLFFBS2xCO0FBRUQsSUFBTSxpQ0FBaUMsR0FBRyxpQkFBaUIsQ0FBQztBQUM1RCxJQUFNLGtDQUFrQyxHQUFHLHNCQUFzQixDQUFDO0FBRWxFLElBQU0sZ0JBQWdCLEdBQUcsa0JBQWtCLENBQUM7QUFDNUM7Ozs7Ozs7OztHQVNHO0FBRUg7SUFRSSxpQ0FDWSxXQUF3QixFQUN4QixZQUEwQixFQUMxQixVQUFzQixFQUN0QixRQUFrQjtRQUhsQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFSYixtQkFBYyxHQUFHLGNBQWMsQ0FBQztRQUV6QyxhQUFRLEdBQWdDLElBQUksQ0FBQztRQVFqRCxJQUFJLENBQUMsK0JBQStCLEVBQUUsQ0FBQztJ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LE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ2hFO2lCQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssa0NBQWtDLEVBQUU7Z0JBQ2xFLEtBQUksQ0FBQyxRQUFRLElBQUksS0FBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMzRDtRQUNMLENBQUMsRUFDRCxLQUFLLENBQ1IsQ0FBQztJQUNOLENBQUM7SUFFRCxzQkFBWSwyQ0FBTTthQUFsQjtZQUNJLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUN4QyxDQUFDOzs7T0FBQTtJQUVELHNCQUFZLDZDQUFRO2FBQXBCO1lBQ0ksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUNoQyxDQUFDOzs7T0FBQTtJQUVELHNCQUFZLGlEQUFZO2FBQXhCO1lBQ0ksT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBb0IsWUFBVSxJQUFJLENBQUMsY0FBZ0IsQ0FBQyxDQUFDO1FBQzNGLENBQUM7OztPQUFBOztJQTFKRCxxREFBcUQ7SUFDdEMsZ0RBQXdCLEdBQUcsS0FBSyxDQUFDOztnQkFPdkIsV0FBVztnQkFDVixZQUFZO2dCQUNkLFVBQVU7Z0JBQ1osUUFBUTs7SUFackIsdUJBQXVCO1FBRG5DLFVBQVUsRUFBRTtpREFVZ0IsV0FBVztZQUNWLFlBQVk7WUFDZCxVQUFVO1lBQ1osUUFBUTtPQVpyQix1QkFBdUIsQ0E0Sm5DO0lBQUQsOEJBQUM7Q0FBQSxBQTVKRCxJQTRKQztTQTVKWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxOSBTQVAgU0Ugb3IgYW4gU0FQIGFmZmlsaWF0ZSBjb21wYW55LiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogQG1vZHVsZSBzbWFydHV0aWxzXG4gKi9cbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IElBdXRoVG9rZW4gfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IERlZmVycmVkLCBQcm9taXNlVXRpbHMsIFdpbmRvd1V0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuXG5jb25zdCBTU09fRElBTE9HX01BUktFUiA9ICdzc28nO1xuXG5lbnVtIFNTT19QUk9QRVJUSUVTIHtcbiAgICBTU09fQ0xJRU5UX0lEID0gJ1NTT19DTElFTlRfSUQnLFxuICAgIFNTT19BVVRIRU5USUNBVElPTl9FTlRSWV9QT0lOVCA9ICdTU09fQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQnLFxuICAgIFNTT19MT0dPVVRfRU5UUllfUE9JTlQgPSAnU1NPX0xPR09VVF9FTlRSWV9QT0lOVCcsXG4gICAgU1NPX09BVVRIMl9BVVRIRU5USUNBVElPTl9FTlRSWV9QT0lOVCA9ICdTU09fT0FVVEgyX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UJ1xufVxuXG5jb25zdCBDSElMRF9TTUFSVEVESVRfU0VORElOR19BVVRIVE9LRU4gPSAnc3NvQXV0aGVudGljYXRlJztcbmNvbnN0IENISUxEX1NNQVJURURJVF9TRU5ESU5HX0FVVEhfRVJST1IgPSAnc3NvQXV0aGVudGljYXRlRXJyb3InO1xuXG5jb25zdCBTU09ESUFMT0dfV0lORE9XID0gJ1NTT0RJQUxPR19XSU5ET1cnO1xuLypcbiAqIEhlbHBlciB0byBpbml0aWF0ZSBhIFNBTUwgL1NTTyBhdXRlbnRpY2F0aW9uIHNlcXVlbmNlIHRocm91Z2ggYSBwb3AtdXBcbiAqIChiZWNhdXNlIHRoZSBzZXF1ZW5jZSBpbnZvbHZlcyBhdXRvLXN1Ym1pdGluZyBodG1sIGZvcm0gYXQgc29tZSBwb2ludCB0aGF0IGNhdXNlcyBhIHJlZGlyZWN0IGFuZCBoZW5jZSB3b3VsZFxuICogbG9vc2UgYXBwIGNvbnRleHQgaWYgbm90IGV4ZWN1dGVkIGluIGEgZGlmZmVyZW50IHdpbmRvdylcbiAqIHRoYXQgdWx0aW1hdGVseSBsb2FkcyB0aGUgYXBwIGFnYWluIHdoaWNoIGluIHR1cm4gd2lsbCBkZXRlY3QgaXRzIGNvbnRleHQgYW5kIGRvIHRoZSBmb2xsb3dpbmc6XG4gKiAtIHdpbGwgbm90IGNvbnRpbnVlIGxvYWRpbmdcbiAqIC0gd2lsIHBvc3QgdGhlIGxvZ2luVG9rZW4gdG8gdGhlIC9hdXRoZW50aWNhdGUgZW5kIHBvaW50IHRvIHJldHJpZXZlIG9BdXRoIGFjY2Vzc1xuICogLSB3aWxsIHNlbmQgYmFjayB0byBwYXJlbnQgKHRocm91Z2ggcG9zdE1lc3NhZ2UpIHRoZSByZXRyaWV2ZWQgb0F1dGggYWNjZXNzXG4gKiAtIHdpbGwgY2xvc2U7XG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTU09BdXRoZW50aWNhdGlvbkhlbHBlciB7XG4gICAgLy8gc3RhdGljIGluIG9yZGVyIHRvIGJlIHNoYXJlZCBieSBtdWx0aXBsZSBpbnN0YW5jZXNcbiAgICBwcml2YXRlIHN0YXRpYyBsYXN0QXV0aGVudGljYXRlZFdpdGhTU08gPSBmYWxzZTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nb3V0SWZyYW1lSWQgPSAnbG9nb3V0SWZyYW1lJztcblxuICAgIHByaXZhdGUgZGVmZXJyZWQ6IERlZmVycmVkPElBdXRoVG9rZW4+IHwgbnVsbCA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSB3aW5kb3dVdGlsczogV2luZG93VXRpbHMsXG4gICAgICAgIHByaXZhdGUgcHJvbWlzZVV0aWxzOiBQcm9taXNlVXRpbHMsXG4gICAgICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcbiAgICApIHtcbiAgICAgICAgdGhpcy5saXN0ZW5Gb3JBdXRoVG9rZW5CZWluZ1NlbnRCYWNrKCk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBJbml0aWF0ZXMgdGhlIFNTTyBkaWFsb2cgdGhyb3VnaCBhIHBvcC11cFxuICAgICAqL1xuICAgIGxhdW5jaFNTT0RpYWxvZygpOiBQcm9taXNlPElBdXRoVG9rZW4+IHtcbiAgICAgICAgdGhpcy5kZWZlcnJlZCA9IHRoaXMucHJvbWlzZVV0aWxzLmRlZmVyPElBdXRoVG9rZW4+KCk7XG5cbiAgICAgICAgY29uc3Qgc3NvQXV0aGVudGljYXRpb25FbnRyeVBvaW50ID1cbiAgICAgICAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0KFNTT19QUk9QRVJUSUVTLlNTT19BVVRIRU5USUNBVElPTl9FTlRSWV9QT0lOVCkgK1xuICAgICAgICAgICAgdGhpcy5nZXRTU09Db250ZXh0UGF0aCgpO1xuICAgICAgICB0aGlzLndpbmRvdy5vcGVuKFxuICAgICAgICAgICAgc3NvQXV0aGVudGljYXRpb25FbnRyeVBvaW50LFxuICAgICAgICAgICAgU1NPRElBTE9HX1dJTkRPVyxcbiAgICAgICAgICAgICd0b29sYmFyPW5vLHNjcm9sbGJhcnM9bm8scmVzaXphYmxlPW5vLHRvcD0yMDAsbGVmdD0yMDAsd2lkdGg9MTAwMCxoZWlnaHQ9ODAwJ1xuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRlZmVycmVkLnByb21pc2U7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBTU08gaGFwcGVuIGluIGEgcG9wdXAgd2luZG93IGxhdW5jaGVkIGJ5IEF1dGhlbnRpY2F0aW9uSGVscGVyI2xhdW5jaFNTT0RpYWxvZygpLlxuICAgICAqIE9uY2UgU1NPIGlzIHN1Y2Nlc3NmdWwsIGEgJ0xvZ2luVG9rZW4nIGNvb2tpZSBpcyBwcmVzZW50LCB0aGlzIGlzIGEgcHJlLXJlcXVpc2l0ZSBmb3IgZG9pbmcgYSBQT1NUIHRvIHRoZSAvYXV0aGVudGljYXRlXG4gICAgICogZW5kcG9pbnQgdGhhdCB3aWxsIHJldHVybiB0aGUgQXV0aG9yaXphdGlvbiBiZWFyZXIgdG9rZW4uXG4gICAgICogVGhpcyBiZWFyZXIgaXMgdGhlbiBzZW50IHdpdGggcG9zdE1lc3NhZ2UgdG8gdGhlIG9wZW5lciB3aW5kb3csIGkuZS4gdGhlIFNtYXJ0RWRpdCBhcHBsaWNhdGlvbiB0aGF0IHdpbGwgcmVzdW1lIHRoZSBwZW5kaW5nIDQwMSByZXF1ZXN0LlxuICAgICAqL1xuICAgIGNvbXBsZXRlRGlhbG9nKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgICAgICAgLnBvc3Q8SUF1dGhUb2tlbj4oXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0KFNTT19QUk9QRVJUSUVTLlNTT19PQVVUSDJfQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQpLFxuICAgICAgICAgICAgICAgICAgICB7IGNsaWVudF9pZDogdGhpcy5pbmplY3Rvci5nZXQoU1NPX1BST1BFUlRJRVMuU1NPX0NMSUVOVF9JRCkgfVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICAgICAgICAoYXV0aFRva2VuKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndpbmRvdy5vcGVuZXIucG9zdE1lc3NhZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudElkOiBDSElMRF9TTUFSVEVESVRfU0VORElOR19BVVRIVE9LRU4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhUb2tlblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5vcmlnaW5cbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndpbmRvdy5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoaHR0cEVycm9yUmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbG9uYWJsZUh0dHBFcnJvclJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBodHRwRXJyb3JSZXNwb25zZS5lcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IGh0dHBFcnJvclJlc3BvbnNlLnN0YXR1c1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud2luZG93Lm9wZW5lci5wb3N0TWVzc2FnZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50SWQ6IENISUxEX1NNQVJURURJVF9TRU5ESU5HX0FVVEhfRVJST1IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBjbG9uYWJsZUh0dHBFcnJvclJlc3BvbnNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvY3VtZW50LmxvY2F0aW9uLm9yaWdpblxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud2luZG93LmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogY2FzZSBvZiB0aGUgQXBwIGJlaW5nIGEgcG9wdXAgb25seSBtZWFudCBmb3IgYXV0aGVudGljYXRpb24gYW5kIHNwdW4gdXAgYnV5IHRoZSBtYWluIGFwcFxuICAgICAqL1xuICAgIGlzU1NPRGlhbG9nKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy53aW5kb3cubmFtZSA9PT0gU1NPRElBTE9HX1dJTkRPVyAmJlxuICAgICAgICAgICAgbmV3IFJlZ0V4cChgWz8mXSR7U1NPX0RJQUxPR19NQVJLRVJ9YCkudGVzdChsb2NhdGlvbi5zZWFyY2gpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBjYXNlIG9mOlxuICAgICAqIC0gdGhlIEFwcCBjYWxsZWQgZnJvbSBhbm90aGVyIGFwcCBpbiBhbiBTU08gY29udGV4dCBhbmQgdGhhdCBzaG91bGQgdGhlcmVmb3JlIGF1dG8tYXV0aGVudGljYXRlIHdpdGggU1NPXG4gICAgICogLSBsYXN0IG1hbnVhbCBhdXRoZW50aWNhdGlvbiB3YXMgd2l0aCBTU09cbiAgICAgKi9cbiAgICBpc0F1dG9TU09NYWluKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgU1NPQXV0aGVudGljYXRpb25IZWxwZXIubGFzdEF1dGhlbnRpY2F0ZWRXaXRoU1NPIHx8XG4gICAgICAgICAgICAodGhpcy53aW5kb3cubmFtZSAhPT0gU1NPRElBTE9HX1dJTkRPVyAmJlxuICAgICAgICAgICAgICAgIG5ldyBSZWdFeHAoYFs/Jl0ke1NTT19ESUFMT0dfTUFSS0VSfWApLnRlc3QobG9jYXRpb24uc2VhcmNoKSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBsb2dvdXQoKTogYW55IHtcbiAgICAgICAgbGV0IGxvZ291dElmcmFtZSA9IHRoaXMubG9nb3V0SWZyYW1lO1xuICAgICAgICBpZiAoIWxvZ291dElmcmFtZSkge1xuICAgICAgICAgICAgbG9nb3V0SWZyYW1lID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTtcbiAgICAgICAgICAgIGxvZ291dElmcmFtZS5pZCA9IHRoaXMubG9nb3V0SWZyYW1lSWQ7XG4gICAgICAgICAgICBsb2dvdXRJZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsb2dvdXRJZnJhbWUpO1xuICAgICAgICB9XG4gICAgICAgIGxvZ291dElmcmFtZS5zcmMgPSB0aGlzLmluamVjdG9yLmdldChTU09fUFJPUEVSVElFUy5TU09fTE9HT1VUX0VOVFJZX1BPSU5UKTtcblxuICAgICAgICBTU09BdXRoZW50aWNhdGlvbkhlbHBlci5sYXN0QXV0aGVudGljYXRlZFdpdGhTU08gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoXG4gICAgICAgICAgICB0aGlzLmdldFNTT0NvbnRleHRQYXRoKCksXG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY29udGV4dCBwYXRoIG9mIGFwcCBpbiBhbiBTU08gbW9kZVxuICAgIHByaXZhdGUgZ2V0U1NPQ29udGV4dFBhdGgoKSB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmRvY3VtZW50LmxvY2F0aW9uLnBhdGhuYW1lfT8ke1NTT19ESUFMT0dfTUFSS0VSfWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsaXN0ZW5Gb3JBdXRoVG9rZW5CZWluZ1NlbnRCYWNrKCk6IHZvaWQge1xuICAgICAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAgICAgJ21lc3NhZ2UnLFxuICAgICAgICAgICAgKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQub3JpZ2luICE9PSBkb2N1bWVudC5sb2NhdGlvbi5vcmlnaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMubG9nb3V0SWZyYW1lICYmIHRoaXMubG9nb3V0SWZyYW1lLnJlbW92ZSgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRhdGEuZXZlbnRJZCA9PT0gQ0hJTERfU01BUlRFRElUX1NFTkRJTkdfQVVUSFRPS0VOKSB7XG4gICAgICAgICAgICAgICAgICAgIFNTT0F1dGhlbnRpY2F0aW9uSGVscGVyLmxhc3RBdXRoZW50aWNhdGVkV2l0aFNTTyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJyZWQgJiYgdGhpcy5kZWZlcnJlZC5yZXNvbHZlKGV2ZW50LmRhdGEuYXV0aFRva2VuKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmRhdGEuZXZlbnRJZCA9PT0gQ0hJTERfU01BUlRFRElUX1NFTkRJTkdfQVVUSF9FUlJPUikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmVycmVkICYmIHRoaXMuZGVmZXJyZWQucmVqZWN0KGV2ZW50LmRhdGEuZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmYWxzZVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IHdpbmRvdygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2luZG93VXRpbHMuZ2V0V2luZG93KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgZG9jdW1lbnQoKTogRG9jdW1lbnQge1xuICAgICAgICByZXR1cm4gdGhpcy53aW5kb3cuZG9jdW1lbnQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgbG9nb3V0SWZyYW1lKCk6IEhUTUxJRnJhbWVFbGVtZW50IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTElGcmFtZUVsZW1lbnQ+KGBpZnJhbWUjJHt0aGlzLmxvZ291dElmcmFtZUlkfWApO1xuICAgIH1cbn1cbiJdfQ==