/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as lodash from 'lodash';
import { Injectable } from '@angular/core';
import { LogService } from '../services/log.service';
/**
 * @ngdoc service
 * @name @smartutils.services:PromiseUtils
 *
 * @description
 * utility service around ES6 Promises.
 */
var PromiseUtils = /** @class */ (function () {
    function PromiseUtils() {
        var _this = this;
        this.WAIT_TIMEOUT = 4;
        this.FAILURE_TIMEOUT = 2000;
        this.handlePromiseRejections = function (promise) {
            var oldThen = promise.then;
            var defaultFailureCallback = _this.defaultFailureCallback;
            promise.then = function (successCallback, _failureCallback) {
                var failureCallback = _failureCallback ? _failureCallback : defaultFailureCallback;
                return oldThen.call(this, successCallback, failureCallback);
            };
            return promise;
        };
        this.defaultFailureCallback = function (error) {
            if (undefined !== error && null !== error && 'canceled' !== error) {
                if (lodash.isPlainObject(error)) {
                    if (!_this.isAjaxError(error)) {
                        PromiseUtils_1.logService.error("exception caught in promise: " + JSON.stringify(error));
                    }
                }
                else if (!lodash.isBoolean(error)) {
                    PromiseUtils_1.logService.error(error);
                }
            }
            PromiseUtils_1.logService.error("defaultFailureCallback:", error);
            return Promise.reject(error);
        };
    }
    PromiseUtils_1 = PromiseUtils;
    PromiseUtils.prototype.toPromise = function (method, context) {
        return function () {
            try {
                return Promise.resolve(method.apply(context, Array.prototype.slice.call(arguments)));
            }
            catch (e) {
                PromiseUtils_1.logService.error('execution of a method that was turned into a promise failed');
                PromiseUtils_1.logService.error(e);
                return Promise.reject(e);
            }
        };
    };
    PromiseUtils.prototype.promise = function (executor) {
        return this.handlePromiseRejections(new Promise(executor));
    };
    PromiseUtils.prototype.defer = function () {
        var pResolve;
        var pReject;
        var deferred = {
            promise: this.promise(function (_resolve, _reject) {
                pResolve = _resolve;
                pReject = _reject;
            }),
            resolve: function (value) {
                pResolve(value);
            },
            reject: function (reason) {
                pReject(reason);
            }
        };
        return deferred;
    };
    PromiseUtils.prototype.sleep = function (ms) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve) { return setTimeout(resolve, ms); })];
            });
        });
    };
    PromiseUtils.prototype.isAjaxError = function (error) {
        return error.hasOwnProperty('headers');
    };
    PromiseUtils.prototype.waitOnCondition = function (condition, callback, errorMessage, elapsedTime) {
        var _this = this;
        if (elapsedTime === void 0) { elapsedTime = 0; }
        setTimeout(function () {
            if (condition()) {
                callback();
            }
            else if (elapsedTime < _this.FAILURE_TIMEOUT) {
                _this.waitOnCondition(condition, callback, errorMessage, elapsedTime + _this.WAIT_TIMEOUT);
            }
            else {
                throw new Error("PromiseUtils: " + errorMessage);
            }
        }, this.WAIT_TIMEOUT);
    };
    PromiseUtils.prototype.resolveToCallbackWhenCondition = function (condition, callback, errorMessage) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve) {
                        _this.waitOnCondition(condition, function () { return resolve(callback()); }, errorMessage ? errorMessage : 'condition for promise resolution was never met');
                    })];
            });
        });
    };
    var PromiseUtils_1;
    PromiseUtils.logService = new LogService();
    PromiseUtils = PromiseUtils_1 = tslib_1.__decorate([
        Injectable()
    ], PromiseUtils);
    return PromiseUtils;
}());
export { PromiseUtils };
export var promiseUtils = new PromiseUtils();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvbWlzZS11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInV0aWxzL3Byb21pc2UtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRztBQUNILE9BQU8sS0FBSyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBT3JEOzs7Ozs7R0FNRztBQUVIO0lBREE7UUFBQSxpQkF1SUM7UUFuSVcsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFDakIsb0JBQWUsR0FBRyxJQUFJLENBQUM7UUE2RC9CLDRCQUF1QixHQUFHLFVBQUksT0FBbUI7WUFDN0MsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztZQUM3QixJQUFNLHNCQUFzQixHQUFHLEtBQUksQ0FBQyxzQkFBc0IsQ0FBQztZQUUxRCxPQUFlLENBQUMsSUFBSSxHQUFHLFVBQ3BCLGVBQWlELEVBQ2pELGdCQUFxQjtnQkFFckIsSUFBTSxlQUFlLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQztnQkFDckYsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUUsZUFBZSxDQUFDLENBQUM7WUFDaEUsQ0FBQyxDQUFDO1lBQ0YsT0FBTyxPQUFPLENBQUM7UUFDbkIsQ0FBQyxDQUFDO1FBMENNLDJCQUFzQixHQUFHLFVBQUMsS0FBVTtZQUN4QyxJQUFJLFNBQVMsS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssSUFBSSxVQUFVLEtBQUssS0FBSyxFQUFFO2dCQUMvRCxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQzdCLElBQUksQ0FBQyxLQUFJLENBQUMsV0FBVyxD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QUNILE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQWlCLFlBQWMsQ0FBQyxDQUFDO2FBQ3BEO1FBQ0wsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUsscURBQThCLEdBQXBDLFVBQ0ksU0FBd0IsRUFDeEIsUUFBaUIsRUFDakIsWUFBcUI7Ozs7Z0JBRXJCLHNCQUFPLElBQUksT0FBTyxDQUFJLFVBQUMsT0FBTzt3QkFDMUIsS0FBSSxDQUFDLGVBQWUsQ0FDaEIsU0FBUyxFQUNULGNBQU0sT0FBQSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBbkIsQ0FBbUIsRUFDekIsWUFBWSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLGdEQUFnRCxDQUNqRixDQUFDO29CQUNOLENBQUMsQ0FBQyxFQUFDOzs7S0FDTjs7SUFwSE0sdUJBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBRDVCLFlBQVk7UUFEeEIsVUFBVSxFQUFFO09BQ0EsWUFBWSxDQXNJeEI7SUFBRCxtQkFBQztDQUFBLEFBdElELElBc0lDO1NBdElZLFlBQVk7QUF3SXpCLE1BQU0sQ0FBQyxJQUFNLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgKiBhcyBsb2Rhc2ggZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9sb2cuc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVmZXJyZWQ8VD4ge1xuICAgIHByb21pc2U6IFByb21pc2U8VD47XG4gICAgcmVzb2x2ZTogKHZhbHVlPzogVCkgPT4gdm9pZDtcbiAgICByZWplY3Q6ICh2YWx1ZT86IGFueSkgPT4gdm9pZDtcbn1cbi8qKlxuICogQG5nZG9jIHNlcnZpY2VcbiAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOlByb21pc2VVdGlsc1xuICpcbiAqIEBkZXNjcmlwdGlvblxuICogdXRpbGl0eSBzZXJ2aWNlIGFyb3VuZCBFUzYgUHJvbWlzZXMuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcm9taXNlVXRpbHMge1xuICAgIHN0YXRpYyBsb2dTZXJ2aWNlID0gbmV3IExvZ1NlcnZpY2UoKTtcblxuICAgIHByaXZhdGUgV0FJVF9USU1FT1VUID0gNDtcbiAgICBwcml2YXRlIEZBSUxVUkVfVElNRU9VVCA9IDIwMDA7XG5cbiAgICB0b1Byb21pc2U8VD4oXG4gICAgICAgIG1ldGhvZDogKC4uLmFyZ3M6IGFueVtdKSA9PiBULFxuICAgICAgICBjb250ZXh0PzogYW55XG4gICAgKTogKC4uLmlubmVyQXJnczogYW55W10pID0+IFByb21pc2U8VD4ge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZC5hcHBseShjb250ZXh0LCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgUHJvbWlzZVV0aWxzLmxvZ1NlcnZpY2UuZXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICdleGVjdXRpb24gb2YgYSBtZXRob2QgdGhhdCB3YXMgdHVybmVkIGludG8gYSBwcm9taXNlIGZhaWxlZCdcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIFByb21pc2VVdGlscy5sb2dTZXJ2aWNlLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcm9taXNlPFQ+KFxuICAgICAgICBleGVjdXRvcjogKFxuICAgICAgICAgICAgcmVzb2x2ZTogKHZhbHVlPzogVCB8IFByb21pc2VMaWtlPFQ+KSA9PiB2b2lkLFxuICAgICAgICAgICAgcmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkXG4gICAgICAgICkgPT4gdm9pZFxuICAgICk6IFByb21pc2U8VD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVQcm9taXNlUmVqZWN0aW9ucyhuZXcgUHJvbWlzZShleGVjdXRvcikpO1xuICAgIH1cblxuICAgIGRlZmVyPFQ+KCk6IERlZmVycmVkPFQ+IHtcbiAgICAgICAgbGV0IHBSZXNvbHZlOiAodmFsdWU/OiBUIHwgUHJvbWlzZUxpa2U8VD4pID0+IHZvaWQ7XG4gICAgICAgIGxldCBwUmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkO1xuXG4gICAgICAgIGNvbnN0IGRlZmVycmVkOiBEZWZlcnJlZDxUPiA9IHtcbiAgICAgICAgICAgIHByb21pc2U6IHRoaXMucHJvbWlzZShcbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIF9yZXNvbHZlOiAodmFsdWU/OiBUIHwgUHJvbWlzZUxpa2U8VD4pID0+IHZvaWQsXG4gICAgICAgICAgICAgICAgICAgIF9yZWplY3Q6IChyZWFzb24/OiBhbnkpID0+IHZvaWRcbiAgICAgICAgICAgICAgICApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcFJlc29sdmUgPSBfcmVzb2x2ZTtcbiAgICAgICAgICAgICAgICAgICAgcFJlamVjdCA9IF9yZWplY3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKSxcblxuICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZTogVCB8IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHBSZXNvbHZlKHZhbHVlKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHJlamVjdChyZWFzb246IGFueSkge1xuICAgICAgICAgICAgICAgIHBSZWplY3QocmVhc29uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gZGVmZXJyZWQ7XG4gICAgfVxuXG4gICAgYXN5bmMgc2xlZXAobXM6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbiAgICB9XG5cbiAgICBoYW5kbGVQcm9taXNlUmVqZWN0aW9ucyA9IDxUPihwcm9taXNlOiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPiA9PiB7XG4gICAgICAgIGNvbnN0IG9sZFRoZW4gPSBwcm9taXNlLnRoZW47XG4gICAgICAgIGNvbnN0IGRlZmF1bHRGYWlsdXJlQ2FsbGJhY2sgPSB0aGlzLmRlZmF1bHRGYWlsdXJlQ2FsbGJhY2s7XG5cbiAgICAgICAgKHByb21pc2UgYXMgYW55KS50aGVuID0gZnVuY3Rpb24oXG4gICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2s6ICh2YWx1ZTogVCkgPT4gVCB8IFByb21pc2VMaWtlPFQ+LFxuICAgICAgICAgICAgX2ZhaWx1cmVDYWxsYmFjazogYW55XG4gICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgZmFpbHVyZUNhbGxiYWNrID0gX2ZhaWx1cmVDYWxsYmFjayA/IF9mYWlsdXJlQ2FsbGJhY2sgOiBkZWZhdWx0RmFpbHVyZUNhbGxiYWNrO1xuICAgICAgICAgICAgcmV0dXJuIG9sZFRoZW4uY2FsbCh0aGlzLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjayk7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH07XG5cbiAgICBpc0FqYXhFcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHJldHVybiBlcnJvci5oYXNPd25Qcm9wZXJ0eSgnaGVhZGVycycpO1xuICAgIH1cblxuICAgIHdhaXRPbkNvbmRpdGlvbihcbiAgICAgICAgY29uZGl0aW9uOiAoKSA9PiBib29sZWFuLFxuICAgICAgICBjYWxsYmFjazogKCkgPT4gYW55LFxuICAgICAgICBlcnJvck1lc3NhZ2U6IHN0cmluZyxcbiAgICAgICAgZWxhcHNlZFRpbWU6IG51bWJlciA9IDBcbiAgICApIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uKCkpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlbGFwc2VkVGltZSA8IHRoaXMuRkFJTFVSRV9USU1FT1VUKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53YWl0T25Db25kaXRpb24oXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbixcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgZWxhcHNlZFRpbWUgKyB0aGlzLldBSVRfVElNRU9VVFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvbWlzZVV0aWxzOiAke2Vycm9yTWVzc2FnZX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgdGhpcy5XQUlUX1RJTUVPVVQpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc29sdmVUb0NhbGxiYWNrV2hlbkNvbmRpdGlvbjxUPihcbiAgICAgICAgY29uZGl0aW9uOiAoKSA9PiBib29sZWFuLFxuICAgICAgICBjYWxsYmFjazogKCkgPT4gVCxcbiAgICAgICAgZXJyb3JNZXNzYWdlPzogc3RyaW5nXG4gICAgKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy53YWl0T25Db25kaXRpb24oXG4gICAgICAgICAgICAgICAgY29uZGl0aW9uLFxuICAgICAgICAgICAgICAgICgpID0+IHJlc29sdmUoY2FsbGJhY2soKSksXG4gICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID8gZXJyb3JNZXNzYWdlIDogJ2NvbmRpdGlvbiBmb3IgcHJvbWlzZSByZXNvbHV0aW9uIHdhcyBuZXZlciBtZXQnXG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRlZmF1bHRGYWlsdXJlQ2FsbGJhY2sgPSAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICBpZiAodW5kZWZpbmVkICE9PSBlcnJvciAmJiBudWxsICE9PSBlcnJvciAmJiAnY2FuY2VsZWQnICE9PSBlcnJvcikge1xuICAgICAgICAgICAgaWYgKGxvZGFzaC5pc1BsYWluT2JqZWN0KGVycm9yKSkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FqYXhFcnJvcihlcnJvcikpIHtcbiAgICAgICAgICAgICAgICAgICAgUHJvbWlzZVV0aWxzLmxvZ1NlcnZpY2UuZXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgICBgZXhjZXB0aW9uIGNhdWdodCBpbiBwcm9taXNlOiAke0pTT04uc3RyaW5naWZ5KGVycm9yKX1gXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICghbG9kYXNoLmlzQm9vbGVhbihlcnJvcikpIHtcbiAgICAgICAgICAgICAgICBQcm9taXNlVXRpbHMubG9nU2VydmljZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgUHJvbWlzZVV0aWxzLmxvZ1NlcnZpY2UuZXJyb3IoYGRlZmF1bHRGYWlsdXJlQ2FsbGJhY2s6YCwgZXJyb3IpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBwcm9taXNlVXRpbHMgPSBuZXcgUHJvbWlzZVV0aWxzKCk7XG4iXX0=