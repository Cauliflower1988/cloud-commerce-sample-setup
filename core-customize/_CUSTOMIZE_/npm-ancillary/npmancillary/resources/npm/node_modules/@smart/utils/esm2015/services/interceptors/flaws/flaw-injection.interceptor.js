/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
var FlawInjectionInterceptor_1;
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { map } from 'rxjs/operators';
import { HttpUtils } from '../../../utils';
import { LogService } from '../../../services/log.service';
/*
 * interceptor that will inject flaw into outbound and inbound http calls.
 * It is mainly used to validate reliability and consitency of test frameworks
 */
/** @internal */
let FlawInjectionInterceptor = FlawInjectionInterceptor_1 = class FlawInjectionInterceptor {
    constructor(httpUtils, logService) {
        this.httpUtils = httpUtils;
        this.logService = logService;
        this.flawWindow = window;
        this.flawWindow.allRequests = 0;
        this.flawWindow.flawedRequests = 0;
        this.flawWindow.allResponses = 0;
        this.flawWindow.flawedResponses = 0;
    }
    static registerRequestFlaw(mutation) {
        this.requestMutations.push(mutation);
    }
    static registerResponseFlaw(mutation) {
        this.responseMutations.push(mutation);
    }
    intercept(request, next) {
        let result;
        if (FlawInjectionInterceptor_1.PROBABILITY !== 0 &&
            this.httpUtils.isCRUDRequest(request) &&
            !this._isGET(request)) {
            this.flawWindow.allRequests++;
            if (this._activateWithProbability(FlawInjectionInterceptor_1.PROBABILITY)) {
                this.flawWindow.flawedRequests++;
                const requestMutation = FlawInjectionInterceptor_1.requestMutations.find((mutation) => mutation.test(request));
                if (requestMutation) {
                    this.logService.error(`FLAWED REQUEST-"${request.url}`);
                    result = next.handle(requestMutation.mutate(request));
                }
            }
            result = next.handle(request);
            return result.pipe(map((event) => {
                if (event instanceof HttpResponse &&
                    this._activateWithProbability(FlawInjectionInterceptor_1.PROBABILITY)) {
                    this.flawWindow.flawedResponses++;
                    const responseMutation = FlawInjectionInterceptor_1.responseMutations.find((mutation) => mutation.test(request));
                    if (responseMutation && event instanceof HttpResponse) {
                        this.logService.error(`FLAWED RESPONSE-"${request.url}`);
                        return responseMutation.mutate(event);
                    }
                }
                return event;
            }));
        }
        else {
            return next.handle(request);
        }
    }
    _isGET(config) {
        return config.method === 'GET';
    }
    _activateWithProbability(probabilityTrue) {
        return Math.random() >= 1.0 - probabilityTrue;
    }
};
FlawInjectionInterceptor.requestMutations = [];
FlawInjectionInterceptor.responseMutations = [];
/*
 * probability of flaw occurrence ranging from 0 to 1
 */
FlawInjectionInterceptor.PROBABILITY = 0;
FlawInjectionInterceptor.ctorParameters = () => [
    { type: HttpUtils },
    { type: LogService }
];
FlawInjectionInterceptor = FlawInjectionInterceptor_1 = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [HttpUtils, LogService])
], FlawInjectionInterceptor);
export { FlawInjectionInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdy1pbmplY3Rpb24uaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac21hcnQvdXRpbHMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9pbnRlcmNlcHRvcnMvZmxhd3MvZmxhdy1pbmplY3Rpb24uaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7O0dBR0c7QUFDSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFLSCxZQUFZLEVBQ2YsTUFBTSxzQkFBc0IsQ0FBQztBQUU5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQU0zRDs7O0dBR0c7QUFDSCxnQkFBZ0I7QUFFaEIsSUFBYSx3QkFBd0IsZ0NBQXJDLE1BQWEsd0JBQXdCO0lBbUJqQyxZQUFvQixTQUFvQixFQUFVLFVBQXNCO1FBQXBELGNBQVMsR0FBVCxTQUFTLENBQVc7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3BFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxHQUFHLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBeEJELE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxRQUFxRDtRQUM1RSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxNQUFNLENBQUMsb0JBQW9C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UCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBIdHRwRXZlbnQsXG4gICAgSHR0cEhhbmRsZXIsXG4gICAgSHR0cEludGVyY2VwdG9yLFxuICAgIEh0dHBSZXF1ZXN0LFxuICAgIEh0dHBSZXNwb25zZVxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBIdHRwVXRpbHMgfSBmcm9tICcuLi8uLi8uLi91dGlscyc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuXG5leHBvcnQgdHlwZSBQcmVkaWNhdGUgPSAocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PikgPT4gYm9vbGVhbjtcbmV4cG9ydCB0eXBlIFJlcXVlc3RIYW5kbGVyID0gKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pID0+IEh0dHBSZXF1ZXN0PGFueT47XG5leHBvcnQgdHlwZSBSZXNwb25zZUhhbmRsZXIgPSAoZXZlbnQ6IEh0dHBSZXNwb25zZTxhbnk+KSA9PiBIdHRwUmVzcG9uc2U8YW55PjtcblxuLypcbiAqIGludGVyY2VwdG9yIHRoYXQgd2lsbCBpbmplY3QgZmxhdyBpbnRvIG91dGJvdW5kIGFuZCBpbmJvdW5kIGh0dHAgY2FsbHMuXG4gKiBJdCBpcyBtYWlubHkgdXNlZCB0byB2YWxpZGF0ZSByZWxpYWJpbGl0eSBhbmQgY29uc2l0ZW5jeSBvZiB0ZXN0IGZyYW1ld29ya3NcbiAqL1xuLyoqIEBpbnRlcm5hbCAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZsYXdJbmplY3Rpb25JbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gICAgc3RhdGljIHJlZ2lzdGVyUmVxdWVzdEZsYXcobXV0YXRpb246IHsgdGVzdDogUHJlZGljYXRlOyBtdXRhdGU6IFJlcXVlc3RIYW5kbGVyIH0pIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0TXV0YXRpb25zLnB1c2gobXV0YXRpb24pO1xuICAgIH1cblxuICAgIHN0YXRpYyByZWdpc3RlclJlc3BvbnNlRmxhdyhtdXRhdGlvbjogeyB0ZXN0OiBQcmVkaWNhdGU7IG11dGF0ZTogUmVzcG9uc2VIYW5kbGVyIH0pIHtcbiAgICAgICAgdGhpcy5yZXNwb25zZU11dGF0aW9ucy5wdXNoKG11dGF0aW9uKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyByZXF1ZXN0TXV0YXRpb25zOiB7IHRlc3Q6IFByZWRpY2F0ZTsgbXV0YXRlOiBSZXF1ZXN0SGFuZGxlciB9W10gPSBbXTtcbiAgICBwcml2YXRlIHN0YXRpYyByZXNwb25zZU11dGF0aW9uczogeyB0ZXN0OiBQcmVkaWNhdGU7IG11dGF0ZTogUmVzcG9uc2VIYW5kbGVyIH1bXSA9IFtdO1xuXG4gICAgLypcbiAgICAgKiBwcm9iYWJpbGl0eSBvZiBmbGF3IG9jY3VycmVuY2UgcmFuZ2luZyBmcm9tIDAgdG8gMVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIFBST0JBQklMSVRZID0gMDtcblxuICAgIHByaXZhdGUgZmxhd1dpbmRvdzogYW55O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwVXRpbHM6IEh0dHBVdGlscywgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZmxhd1dpbmRvdyA9IHdpbmRvdztcbiAgICAgICAgdGhpcy5mbGF3V2luZG93LmFsbFJlcXVlc3RzID0gMDtcbiAgICAgICAgdGhpcy5mbGF3V2luZG93LmZsYXdlZFJlcXVlc3RzID0gMDtcbiAgICAgICAgdGhpcy5mbGF3V2luZG93LmFsbFJlc3BvbnNlcyA9IDA7XG4gICAgICAgIHRoaXMuZmxhd1dpbmRvdy5mbGF3ZWRSZXNwb25zZXMgPSAwO1xuICAgIH1cblxuICAgIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj47XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgRmxhd0luamVjdGlvbkludGVyY2VwdG9yLlBST0JBQklMSVRZICE9PSAwICYmXG4gICAgICAgICAgICB0aGlzLmh0dHBVdGlscy5pc0NSVURSZXF1ZXN0KHJlcXVlc3QpICYmXG4gICAgICAgICAgICAhdGhpcy5faXNHRVQocmVxdWVzdClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB0aGlzLmZsYXdXaW5kb3cuYWxsUmVxdWVzdHMrKztcbiAgICAgICAgICAgIGlmICh0aGlzLl9hY3RpdmF0ZVdpdGhQcm9iYWJpbGl0eShGbGF3SW5qZWN0aW9uSW50ZXJjZXB0b3IuUFJPQkFCSUxJVFkpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mbGF3V2luZG93LmZsYXdlZFJlcXVlc3RzKys7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXF1ZXN0TXV0YXRpb24gPSBGbGF3SW5qZWN0aW9uSW50ZXJjZXB0b3IucmVxdWVzdE11dGF0aW9ucy5maW5kKChtdXRhdGlvbikgPT5cbiAgICAgICAgICAgICAgICAgICAgbXV0YXRpb24udGVzdChyZXF1ZXN0KVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RNdXRhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoYEZMQVdFRCBSRVFVRVNULVwiJHtyZXF1ZXN0LnVybH1gKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbmV4dC5oYW5kbGUocmVxdWVzdE11dGF0aW9uLm11dGF0ZShyZXF1ZXN0KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXN1bHQgPSBuZXh0LmhhbmRsZShyZXF1ZXN0KTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoZXZlbnQ6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hY3RpdmF0ZVdpdGhQcm9iYWJpbGl0eShGbGF3SW5qZWN0aW9uSW50ZXJjZXB0b3IuUFJPQkFCSUxJVFkpXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mbGF3V2luZG93LmZsYXdlZFJlc3BvbnNlcysrO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZU11dGF0aW9uID0gRmxhd0luamVjdGlvbkludGVyY2VwdG9yLnJlc3BvbnNlTXV0YXRpb25zLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKG11dGF0aW9uKSA9PiBtdXRhdGlvbi50ZXN0KHJlcXVlc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlTXV0YXRpb24gJiYgZXZlbnQgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoYEZMQVdFRCBSRVNQT05TRS1cIiR7cmVxdWVzdC51cmx9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlTXV0YXRpb24ubXV0YXRlKGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2lzR0VUKGNvbmZpZzogYW5ndWxhci5JUmVxdWVzdENvbmZpZykge1xuICAgICAgICByZXR1cm4gY29uZmlnLm1ldGhvZCA9PT0gJ0dFVCc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWN0aXZhdGVXaXRoUHJvYmFiaWxpdHkocHJvYmFiaWxpdHlUcnVlOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkgPj0gMS4wIC0gcHJvYmFiaWxpdHlUcnVlO1xuICAgIH1cbn1cbiJdfQ==