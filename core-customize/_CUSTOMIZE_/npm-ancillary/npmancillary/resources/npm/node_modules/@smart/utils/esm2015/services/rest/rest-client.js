/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as lodash from 'lodash';
import { HttpHeaders } from '@angular/common/http';
import { map } from 'rxjs/operators';
import { URIBuilder } from '../../utils';
/** @internal */
export class RestClient {
    constructor(httpClient, url, identifierName) {
        this.httpClient = httpClient;
        this.url = url;
        this.identifierName = identifierName;
        this.DEFAULT_HEADERS = { 'x-requested-with': 'Angular' };
        this.DEFAULT_OPTIONS = { headers: {} };
        // will activate response headers appending
        this.metadataActivated = false;
        ///////////////////////////////////////////
        /// INTERNAL METHODS NEEDED FOR GATEWAY ///
        ///////////////////////////////////////////
        this.getMethodForSingleInstance = (name) => {
            switch (name) {
                case 'getById':
                    return (id, options = this.DEFAULT_OPTIONS) => this.getById(id, options);
                case 'get':
                    return (searchParams, options = this.DEFAULT_OPTIONS) => this.get(searchParams, options);
                case 'update':
                    return (payload, options = this.DEFAULT_OPTIONS) => this.update(payload, options);
                case 'save':
                    return (payload, options = this.DEFAULT_OPTIONS) => this.save(payload, options);
                case 'patch':
                    return (payload, options = this.DEFAULT_OPTIONS) => this.patch(payload, options);
                case 'remove':
                    return (payload, options = this.DEFAULT_OPTIONS) => this.remove(payload, options);
            }
        };
        this.getMethodForArray = (name) => {
            switch (name) {
                case 'query':
                    return (params, options = this.DEFAULT_OPTIONS) => this.query(params, options);
            }
        };
    }
    getById(identifier, options = this.DEFAULT_OPTIONS) {
        return this.addHeadersToBody(this.httpClient.get(`${this.url}/${identifier}`, {
            headers: this.buildRequestHeaders(options.headers || {}),
            observe: 'response'
        })).toPromise();
    }
    get(searchParams, options = this.DEFAULT_OPTIONS) {
        const params = this.convertToTypeMapOfString(searchParams);
        return this.addHeadersToBody(this.httpClient.get(this.interpolateParamsInURL(this.url, params), {
            params: this.formatQueryString(this.determineTrueQueryStringParams(this.url, searchParams)),
            headers: this.buildRequestHeaders(options.headers || {}),
            observe: 'response'
        })).toPromise();
    }
    query(searchParams, options = this.DEFAULT_OPTIONS) {
        const params = searchParams ? this.convertToTypeMapOfString(searchParams) : searchParams;
        return this.addHeadersToBody(this.httpClient.get(this.interpolateParamsInURL(this.url, params), {
            params: this.formatQueryString(this.determineTrueQueryStringParams(this.url, searchParams)),
            headers: this.buildRequestHeaders(options.headers || {}),
            observe: 'response'
        }))
            .pipe(map((arr) => arr || []))
            .toPromise();
    }
    page(pageable, options = this.DEFAULT_OPTIONS) {
        return (this.addHeadersToBody(this.httpClient.get(this.interpolateParamsInURL(this.url, pageable), {
            params: this.formatQueryString(this.determineTrueQueryStringParams(this.url, pageable)),
            headers: this.buildRequestHeaders(options.headers || {}),
            observe: 'response'
        }))
            // force typing to accept the fact that a page is never null
            .pipe(map((arr) => arr))
            .toPromise());
    }
    update(payload, options = this.DEFAULT_OPTIONS) {
        return this.performIdentifierCheck(payload)
            .then(() => this.buildUrlWithIdentifier(payload))
            .then((url) => this.httpClient
            .put(url, payload, {
            headers: this.buildRequestHeaders(options.headers || {})
        })
            .toPromise());
    }
    save(payload, options = this.DEFAULT_OPTIONS) {
        return this.httpClient
            .post(this.interpolateParamsInURL(this.url, payload), payload, {
            headers: this.buildRequestHeaders(options.headers || {})
        })
            .toPromise();
    }
    patch(payload, options = this.DEFAULT_OPTIONS) {
        return this.performIdentifierCheck(payload)
            .then(() => this.buildUrlWithIdentifier(payload))
            .then((url) => this.httpClient
            .patch(url, payload, {
            headers: this.buildRequestHeaders(options.headers || {})
        })
            .toPromise());
    }
    remove(payload, options = this.DEFAULT_OPTIONS) {
        return this.performIdentifierCheck(payload)
            .then(() => this.buildUrlWithIdentifier(payload))
            .then((url) => this.httpClient
            .delete(url, { headers: this.buildRequestHeaders(options.headers || {}) })
            .toPromise());
    }
    activateMetadata() {
        this.metadataActivated = true;
    }
    convertToTypeMapOfString(searchParams) {
        return lodash.mapValues(searchParams, (val) => String(val));
    }
    formatQueryString(_params) {
        return this.sortByKeys(_params);
    }
    addHeadersToBody(observable) {
        return observable.pipe(map((response) => {
            const data = response.body;
            if (this.metadataActivated && data) {
                // used by @Cached annotation
                data.headers = response.headers;
            }
            return data;
        }));
    }
    /*
     * interpolation URL placeholders interpolation with potential matches in queryString
     */
    interpolateParamsInURL(_url, payload) {
        // only keep params to be found in the URI or query params
        if (payload && typeof payload !== 'string') {
            return new URIBuilder(_url)
                .replaceParams(payload)
                .sanitize()
                .build();
        }
        else {
            return _url;
        }
    }
    /*
     * remove from queryString any param needed for URL placeholders interpolation
     */
    determineTrueQueryStringParams(url, payload) {
        return typeof payload === 'object'
            ? Object.keys(payload).reduce((prev, next) => {
                if (!new RegExp(':' + next + '/').test(url) &&
                    !new RegExp(':' + next + '$').test(url) &&
                    !new RegExp(':' + next + '&').test(url) &&
                    !lodash.isNil(payload[next])) {
                    prev[next] = payload[next];
                }
                return prev;
            }, {})
            : {};
    }
    sortByKeys(obj) {
        const keys = lodash.sortBy(lodash.keys(obj), (key) => {
            return key;
        });
        return lodash.zipObject(keys, lodash.map(keys, (key) => {
            return obj[key];
        }));
    }
    performIdentifierCheck(payload) {
        const identifier = typeof payload === 'string' ? payload : payload[this.identifierName];
        if (!identifier) {
            return Promise.reject('no data was found under the ' +
                identifier +
                ' field of object ' +
                JSON.stringify(payload) +
                ', it is necessary for update and remove operations');
        }
        return Promise.resolve();
    }
    buildUrlWithIdentifier(payload) {
        const identifier = typeof payload === 'string' ? payload : payload[this.identifierName];
        let url = this.interpolateParamsInURL(`${this.url}`, payload);
        url =
            url.includes('?') || this.url.includes(':' + this.identifierName)
                ? url
                : `${url}/${identifier}`;
        return Promise.resolve(url);
    }
    buildRequestHeaders(headers) {
        return new HttpHeaders(Object.assign({}, this.DEFAULT_HEADERS, headers));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1jbGllbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac21hcnQvdXRpbHMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9yZXN0L3Jlc3QtY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUNIOzs7R0FHRztBQUNILE9BQU8sS0FBSyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFBYyxXQUFXLEVBQWdCLE1BQU0sc0JBQXNCLENBQUM7QUFFN0UsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFLekMsZ0JBQWdCO0FBQ2hCLE1BQU0sT0FBTyxVQUFVO0lBTW5CLFlBQ1ksVUFBc0IsRUFDZCxHQUFXLEVBQ25CLGNBQXNCO1FBRnRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDZCxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBQ25CLG1CQUFjLEdBQWQsY0FBYyxDQUFRO1FBUmpCLG9CQUFlLEdBQXFCLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxFQUFFLENBQUM7UUFDdEUsb0JBQWUsR0FBaUIsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDakUsMkNBQTJDO1FBQ25DLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQXdIbEMsMkNBQTJDO1FBQzNDLDJDQUEyQztRQUMzQywyQ0FBMkM7UUFFM0MsK0JBQTBCLEdBQUcsQ0FDekIsSUFBZ0UsRUFDakMsRUFBRTtZQUNqQyxRQUFRLElBQUksRUFBRTtnQkFDVixLQUFLLFNBQVM7b0JBQ1YsT0FBTyxDQUFDLEVBQVUsRUFBRSxVQUF3QixJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FDaEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ2xDLEtBQUssS0FBSztvQkFDTixPQUFPLENBQUMsWUFBMEIsRUFBRSxVQUF3QixJQUFJLENBQUMs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LEdBQUc7WUFDQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO2dCQUM3RCxDQUFDLENBQUMsR0FBRztnQkFDTCxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFFakMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxPQUF5QjtRQUNqRCxPQUFPLElBQUksV0FBVyxtQkFBTSxJQUFJLENBQUMsZUFBZSxFQUFLLE9BQU8sRUFBRyxDQUFDO0lBQ3BFLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDIwIFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgKiBhcyBsb2Rhc2ggZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQYWdlLCBQYWdlYWJsZSwgUGF5bG9hZCwgVHlwZWRNYXAgfSBmcm9tICcuLi8uLi9kdG9zJztcbmltcG9ydCB7IFVSSUJ1aWxkZXIgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBJUmVzdE9wdGlvbnMsIElSZXN0U2VydmljZSwgU2VhcmNoUGFyYW1zIH0gZnJvbSAnLi9pLXJlc3Qtc2VydmljZSc7XG5cbmV4cG9ydCB0eXBlIE9iamVjdFdpdGhIZWFkZXJzPFQ+ID0gVCAmIHsgaGVhZGVycz86IEh0dHBIZWFkZXJzIH07XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBjbGFzcyBSZXN0Q2xpZW50PFQ+IGltcGxlbWVudHMgSVJlc3RTZXJ2aWNlPFQ+IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfSEVBREVSUzogVHlwZWRNYXA8c3RyaW5nPiA9IHsgJ3gtcmVxdWVzdGVkLXdpdGgnOiAnQW5ndWxhcicgfTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IERFRkFVTFRfT1BUSU9OUzogSVJlc3RPcHRpb25zID0geyBoZWFkZXJzOiB7fSB9O1xuICAgIC8vIHdpbGwgYWN0aXZhdGUgcmVzcG9uc2UgaGVhZGVycyBhcHBlbmRpbmdcbiAgICBwcml2YXRlIG1ldGFkYXRhQWN0aXZhdGVkID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICBwdWJsaWMgcmVhZG9ubHkgdXJsOiBzdHJpbmcsXG4gICAgICAgIHByaXZhdGUgaWRlbnRpZmllck5hbWU6IHN0cmluZ1xuICAgICkge31cblxuICAgIGdldEJ5SWQ8UyBleHRlbmRzIFQgPSBUPihcbiAgICAgICAgaWRlbnRpZmllcjogc3RyaW5nLFxuICAgICAgICBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OU1xuICAgICk6IFByb21pc2U8T2JqZWN0V2l0aEhlYWRlcnM8Uz4gfCBudWxsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZEhlYWRlcnNUb0JvZHkoXG4gICAgICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0PFM+KGAke3RoaXMudXJsfS8ke2lkZW50aWZpZXJ9YCwge1xuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHRoaXMuYnVpbGRSZXF1ZXN0SGVhZGVycyhvcHRpb25zLmhlYWRlcnMgfHwge30pLFxuICAgICAgICAgICAgICAgIG9ic2VydmU6ICdyZXNwb25zZSdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICkudG9Qcm9taXNlKCk7XG4gICAgfVxuICAgIGdldDxTIGV4dGVuZHMgVCA9IFQ+KFxuICAgICAgICBzZWFyY2hQYXJhbXM6IFNlYXJjaFBhcmFtcyxcbiAgICAgICAgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlNcbiAgICApOiBQcm9taXNlPE9iamVjdFdpdGhIZWFkZXJzPFM+IHwgbnVsbD4ge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmNvbnZlcnRUb1R5cGVNYXBPZlN0cmluZyhzZWFyY2hQYXJhbXMpO1xuICAgICAgICByZXR1cm4gdGhpcy5hZGRIZWFkZXJzVG9Cb2R5KFxuICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50LmdldDxTPih0aGlzLmludGVycG9sYXRlUGFyYW1zSW5VUkwodGhpcy51cmwsIHBhcmFtcyksIHtcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHRoaXMuZm9ybWF0UXVlcnlTdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGV0ZXJtaW5lVHJ1ZVF1ZXJ5U3RyaW5nUGFyYW1zKHRoaXMudXJsLCBzZWFyY2hQYXJhbXMpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB0aGlzLmJ1aWxkUmVxdWVzdEhlYWRlcnMob3B0aW9ucy5oZWFkZXJzIHx8IHt9KSxcbiAgICAgICAgICAgICAgICBvYnNlcnZlOiAncmVzcG9uc2UnXG4gICAgICAgICAgICB9KVxuICAgICAgICApLnRvUHJvbWlzZSgpO1xuICAgIH1cbiAgICBxdWVyeTxTIGV4dGVuZHMgVCA9IFQ+KFxuICAgICAgICBzZWFyY2hQYXJhbXM/OiBTZWFyY2hQYXJhbXMsXG4gICAgICAgIG9wdGlvbnM6IElSZXN0T3B0aW9ucyA9IHRoaXMuREVGQVVMVF9PUFRJT05TXG4gICAgKTogUHJvbWlzZTxPYmplY3RXaXRoSGVhZGVyczxTW10+PiB7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHNlYXJjaFBhcmFtcyA/IHRoaXMuY29udmVydFRvVHlwZU1hcE9mU3RyaW5nKHNlYXJjaFBhcmFtcykgOiBzZWFyY2hQYXJhbXM7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZEhlYWRlcnNUb0JvZHkoXG4gICAgICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0PFNbXT4odGhpcy5pbnRlcnBvbGF0ZVBhcmFtc0luVVJMKHRoaXMudXJsLCBwYXJhbXMpLCB7XG4gICAgICAgICAgICAgICAgcGFyYW1zOiB0aGlzLmZvcm1hdFF1ZXJ5U3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRldGVybWluZVRydWVRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLnVybCwgc2VhcmNoUGFyYW1zKVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZFJlcXVlc3RIZWFkZXJzKG9wdGlvbnMuaGVhZGVycyB8fCB7fSksXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZTogJ3Jlc3BvbnNlJ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUobWFwKChhcnI6IFNbXSB8IG51bGwpID0+IGFyciB8fCBbXSkpXG4gICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgfVxuICAgIHBhZ2U8UyBleHRlbmRzIFQgPSBUPihcbiAgICAgICAgcGFnZWFibGU6IFBhZ2VhYmxlLFxuICAgICAgICBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OU1xuICAgICk6IFByb21pc2U8T2JqZWN0V2l0aEhlYWRlcnM8UGFnZTxTPj4+IHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYWRkSGVhZGVyc1RvQm9keShcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0PFBhZ2U8Uz4+KHRoaXMuaW50ZXJwb2xhdGVQYXJhbXNJblVSTCh0aGlzLnVybCwgcGFnZWFibGUpLCB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtczogdGhpcy5mb3JtYXRRdWVyeVN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGV0ZXJtaW5lVHJ1ZVF1ZXJ5U3RyaW5nUGFyYW1zKHRoaXMudXJsLCBwYWdlYWJsZSlcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZFJlcXVlc3RIZWFkZXJzKG9wdGlvbnMuaGVhZGVycyB8fCB7fSksXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmU6ICdyZXNwb25zZSdcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIC8vIGZvcmNlIHR5cGluZyB0byBhY2NlcHQgdGhlIGZhY3QgdGhhdCBhIHBhZ2UgaXMgbmV2ZXIgbnVsbFxuICAgICAgICAgICAgICAgIC5waXBlKG1hcCgoYXJyOiBQYWdlPFM+IHwgbnVsbCkgPT4gKGFyciBhcyBhbnkpIGFzIFBhZ2U8Uz4pKVxuICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICApO1xuICAgIH1cbiAgICB1cGRhdGU8UyBleHRlbmRzIFQgPSBUPihcbiAgICAgICAgcGF5bG9hZDogUGF5bG9hZCxcbiAgICAgICAgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlNcbiAgICApOiBQcm9taXNlPFM+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyZm9ybUlkZW50aWZpZXJDaGVjayhwYXlsb2FkKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5idWlsZFVybFdpdGhJZGVudGlmaWVyKHBheWxvYWQpKVxuICAgICAgICAgICAgLnRoZW4oKHVybDogc3RyaW5nKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAgICAgICAgICAgICAucHV0PFM+KHVybCwgcGF5bG9hZCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZFJlcXVlc3RIZWFkZXJzKG9wdGlvbnMuaGVhZGVycyB8fCB7fSlcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICApO1xuICAgIH1cbiAgICBzYXZlPFMgZXh0ZW5kcyBUID0gVD4oXG4gICAgICAgIHBheWxvYWQ6IFBheWxvYWQsXG4gICAgICAgIG9wdGlvbnM6IElSZXN0T3B0aW9ucyA9IHRoaXMuREVGQVVMVF9PUFRJT05TXG4gICAgKTogUHJvbWlzZTxTPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnRcbiAgICAgICAgICAgIC5wb3N0PFM+KHRoaXMuaW50ZXJwb2xhdGVQYXJhbXNJblVSTCh0aGlzLnVybCwgcGF5bG9hZCksIHBheWxvYWQsIHtcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB0aGlzLmJ1aWxkUmVxdWVzdEhlYWRlcnMob3B0aW9ucy5oZWFkZXJzIHx8IHt9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICB9XG5cbiAgICBwYXRjaDxTIGV4dGVuZHMgVCA9IFQ+KFxuICAgICAgICBwYXlsb2FkOiBQYXlsb2FkLFxuICAgICAgICBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OU1xuICAgICk6IFByb21pc2U8Uz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wZXJmb3JtSWRlbnRpZmllckNoZWNrKHBheWxvYWQpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmJ1aWxkVXJsV2l0aElkZW50aWZpZXIocGF5bG9hZCkpXG4gICAgICAgICAgICAudGhlbigodXJsOiBzdHJpbmcpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgICAgICAgICAgIC5wYXRjaDxTPih1cmwsIHBheWxvYWQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHRoaXMuYnVpbGRSZXF1ZXN0SGVhZGVycyhvcHRpb25zLmhlYWRlcnMgfHwge30pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZW1vdmUocGF5bG9hZDogc3RyaW5nIHwgUGF5bG9hZCwgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlMpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wZXJmb3JtSWRlbnRpZmllckNoZWNrKHBheWxvYWQpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmJ1aWxkVXJsV2l0aElkZW50aWZpZXIocGF5bG9hZCkpXG4gICAgICAgICAgICAudGhlbigodXJsOiBzdHJpbmcpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgICAgICAgICAgIC5kZWxldGUodXJsLCB7IGhlYWRlcnM6IHRoaXMuYnVpbGRSZXF1ZXN0SGVhZGVycyhvcHRpb25zLmhlYWRlcnMgfHwge30pIH0pXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8vIElOVEVSTkFMIE1FVEhPRFMgTkVFREVEIEZPUiBHQVRFV0FZIC8vL1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGdldE1ldGhvZEZvclNpbmdsZUluc3RhbmNlID0gKFxuICAgICAgICBuYW1lOiAnZ2V0QnlJZCcgfCAnZ2V0JyB8ICd1cGRhdGUnIHwgJ3NhdmUnIHwgJ3JlbW92ZScgfCAncGF0Y2gnXG4gICAgKTogKChwYXJhbXM6IGFueSkgPT4gUHJvbWlzZTxhbnk+KSA9PiB7XG4gICAgICAgIHN3aXRjaCAobmFtZSkge1xuICAgICAgICAgICAgY2FzZSAnZ2V0QnlJZCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIChpZDogc3RyaW5nLCBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OUykgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRCeUlkKGlkLCBvcHRpb25zKTtcbiAgICAgICAgICAgIGNhc2UgJ2dldCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIChzZWFyY2hQYXJhbXM6IFNlYXJjaFBhcmFtcywgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlMpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0KHNlYXJjaFBhcmFtcywgb3B0aW9ucyk7XG4gICAgICAgICAgICBjYXNlICd1cGRhdGUnOlxuICAgICAgICAgICAgICAgIHJldHVybiAocGF5bG9hZDogUGF5bG9hZCwgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlMpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHBheWxvYWQsIG9wdGlvbnMpO1xuICAgICAgICAgICAgY2FzZSAnc2F2ZSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIChwYXlsb2FkOiBQYXlsb2FkLCBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OUykgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKHBheWxvYWQsIG9wdGlvbnMpO1xuICAgICAgICAgICAgY2FzZSAncGF0Y2gnOlxuICAgICAgICAgICAgICAgIHJldHVybiAocGF5bG9hZDogUGF5bG9hZCwgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlMpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGF0Y2gocGF5bG9hZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICBjYXNlICdyZW1vdmUnOlxuICAgICAgICAgICAgICAgIHJldHVybiAocGF5bG9hZDogc3RyaW5nIHwgUGF5bG9hZCwgb3B0aW9uczogSVJlc3RPcHRpb25zID0gdGhpcy5ERUZBVUxUX09QVElPTlMpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKHBheWxvYWQsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBnZXRNZXRob2RGb3JBcnJheSA9IChuYW1lOiAncXVlcnknKTogKChwYXJhbXM6IFNlYXJjaFBhcmFtcykgPT4gUHJvbWlzZTxUW10gfCBudWxsPikgPT4ge1xuICAgICAgICBzd2l0Y2ggKG5hbWUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3F1ZXJ5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gKHBhcmFtczogU2VhcmNoUGFyYW1zLCBvcHRpb25zOiBJUmVzdE9wdGlvbnMgPSB0aGlzLkRFRkFVTFRfT1BUSU9OUykgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShwYXJhbXMsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBhY3RpdmF0ZU1ldGFkYXRhKCk6IHZvaWQge1xuICAgICAgICB0aGlzLm1ldGFkYXRhQWN0aXZhdGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbnZlcnRUb1R5cGVNYXBPZlN0cmluZyhzZWFyY2hQYXJhbXM6IFNlYXJjaFBhcmFtcyk6IFR5cGVkTWFwPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gbG9kYXNoLm1hcFZhbHVlcyhzZWFyY2hQYXJhbXMsICh2YWw6IGFueSkgPT4gU3RyaW5nKHZhbCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0UXVlcnlTdHJpbmcoXG4gICAgICAgIF9wYXJhbXM6IFNlYXJjaFBhcmFtcyB8IFBhZ2VhYmxlXG4gICAgKToge1xuICAgICAgICBbcGFyYW06IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIH0ge1xuICAgICAgICByZXR1cm4gdGhpcy5zb3J0QnlLZXlzKF9wYXJhbXMpO1xuICAgIH1cbiAgICBwcml2YXRlIGFkZEhlYWRlcnNUb0JvZHk8Qm9keVR5cGU+KFxuICAgICAgICBvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxCb2R5VHlwZT4+XG4gICAgKTogT2JzZXJ2YWJsZTxPYmplY3RXaXRoSGVhZGVyczxCb2R5VHlwZT4gfCBudWxsPiB7XG4gICAgICAgIHJldHVybiBvYnNlcnZhYmxlLnBpcGUoXG4gICAgICAgICAgICBtYXAoKHJlc3BvbnNlOiBIdHRwUmVzcG9uc2U8T2JqZWN0V2l0aEhlYWRlcnM8Qm9keVR5cGU+PikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXNwb25zZS5ib2R5O1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubWV0YWRhdGFBY3RpdmF0ZWQgJiYgZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAvLyB1c2VkIGJ5IEBDYWNoZWQgYW5ub3RhdGlvblxuICAgICAgICAgICAgICAgICAgICBkYXRhLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBpbnRlcnBvbGF0aW9uIFVSTCBwbGFjZWhvbGRlcnMgaW50ZXJwb2xhdGlvbiB3aXRoIHBvdGVudGlhbCBtYXRjaGVzIGluIHF1ZXJ5U3RyaW5nXG4gICAgICovXG4gICAgcHJpdmF0ZSBpbnRlcnBvbGF0ZVBhcmFtc0luVVJMKF91cmw6IHN0cmluZywgcGF5bG9hZD86IHN0cmluZyB8IFR5cGVkTWFwPGFueT4pOiBzdHJpbmcge1xuICAgICAgICAvLyBvbmx5IGtlZXAgcGFyYW1zIHRvIGJlIGZvdW5kIGluIHRoZSBVUkkgb3IgcXVlcnkgcGFyYW1zXG4gICAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBVUklCdWlsZGVyKF91cmwpXG4gICAgICAgICAgICAgICAgLnJlcGxhY2VQYXJhbXMocGF5bG9hZClcbiAgICAgICAgICAgICAgICAuc2FuaXRpemUoKVxuICAgICAgICAgICAgICAgIC5idWlsZCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIF91cmw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKlxuICAgICAqIHJlbW92ZSBmcm9tIHF1ZXJ5U3RyaW5nIGFueSBwYXJhbSBuZWVkZWQgZm9yIFVSTCBwbGFjZWhvbGRlcnMgaW50ZXJwb2xhdGlvblxuICAgICAqL1xuICAgIHByaXZhdGUgZGV0ZXJtaW5lVHJ1ZVF1ZXJ5U3RyaW5nUGFyYW1zKFxuICAgICAgICB1cmw6IHN0cmluZyxcbiAgICAgICAgcGF5bG9hZD86IHN0cmluZyB8IFR5cGVkTWFwPGFueT5cbiAgICApOiBUeXBlZE1hcDxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHR5cGVvZiBwYXlsb2FkID09PSAnb2JqZWN0J1xuICAgICAgICAgICAgPyBPYmplY3Qua2V5cyhwYXlsb2FkKS5yZWR1Y2UoKHByZXY6IFBheWxvYWQsIG5leHQ6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICFuZXcgUmVnRXhwKCc6JyArIG5leHQgKyAnLycpLnRlc3QodXJsKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICFuZXcgUmVnRXhwKCc6JyArIG5leHQgKyAnJCcpLnRlc3QodXJsKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICFuZXcgUmVnRXhwKCc6JyArIG5leHQgKyAnJicpLnRlc3QodXJsKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICFsb2Rhc2guaXNOaWwocGF5bG9hZFtuZXh0XSlcbiAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgIHByZXZbbmV4dF0gPSBwYXlsb2FkW25leHRdO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXY7XG4gICAgICAgICAgICAgIH0sIHt9KVxuICAgICAgICAgICAgOiB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNvcnRCeUtleXMob2JqOiBUeXBlZE1hcDxhbnk+KSB7XG4gICAgICAgIGNvbnN0IGtleXMgPSBsb2Rhc2guc29ydEJ5KGxvZGFzaC5rZXlzKG9iaiksIChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGtleTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGxvZGFzaC56aXBPYmplY3QoXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgbG9kYXNoLm1hcChrZXlzLCAoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2tleV07XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGVyZm9ybUlkZW50aWZpZXJDaGVjayhwYXlsb2FkOiBzdHJpbmcgfCBQYXlsb2FkKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0eXBlb2YgcGF5bG9hZCA9PT0gJ3N0cmluZycgPyBwYXlsb2FkIDogcGF5bG9hZFt0aGlzLmlkZW50aWZpZXJOYW1lXTtcblxuICAgICAgICBpZiAoIWlkZW50aWZpZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChcbiAgICAgICAgICAgICAgICAnbm8gZGF0YSB3YXMgZm91bmQgdW5kZXIgdGhlICcgK1xuICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyICtcbiAgICAgICAgICAgICAgICAgICAgJyBmaWVsZCBvZiBvYmplY3QgJyArXG4gICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHBheWxvYWQpICtcbiAgICAgICAgICAgICAgICAgICAgJywgaXQgaXMgbmVjZXNzYXJ5IGZvciB1cGRhdGUgYW5kIHJlbW92ZSBvcGVyYXRpb25zJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkVXJsV2l0aElkZW50aWZpZXIocGF5bG9hZDogc3RyaW5nIHwgUGF5bG9hZCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0eXBlb2YgcGF5bG9hZCA9PT0gJ3N0cmluZycgPyBwYXlsb2FkIDogcGF5bG9hZFt0aGlzLmlkZW50aWZpZXJOYW1lXTtcbiAgICAgICAgbGV0IHVybCA9IHRoaXMuaW50ZXJwb2xhdGVQYXJhbXNJblVSTChgJHt0aGlzLnVybH1gLCBwYXlsb2FkKTtcblxuICAgICAgICB1cmwgPVxuICAgICAgICAgICAgdXJsLmluY2x1ZGVzKCc/JykgfHwgdGhpcy51cmwuaW5jbHVkZXMoJzonICsgdGhpcy5pZGVudGlmaWVyTmFtZSlcbiAgICAgICAgICAgICAgICA/IHVybFxuICAgICAgICAgICAgICAgIDogYCR7dXJsfS8ke2lkZW50aWZpZXJ9YDtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVybCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFJlcXVlc3RIZWFkZXJzKGhlYWRlcnM6IFR5cGVkTWFwPHN0cmluZz4pOiBIdHRwSGVhZGVycyB7XG4gICAgICAgIHJldHVybiBuZXcgSHR0cEhlYWRlcnMoeyAuLi50aGlzLkRFRkFVTFRfSEVBREVSUywgLi4uaGVhZGVycyB9KTtcbiAgICB9XG59XG4iXX0=