import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Component, HostBinding, Inject, Optional } from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { HttpClient, HttpErrorResponse, HttpHeaders, HttpResponse } from '@angular/common/http';
import { ModalRef } from '@fundamental-ngx/core';
import { StringUtils, UrlUtils } from '../../utils';
import { LogService } from '../../services/log.service';
import { IAuthToken, ILoginData, ILoginModalFeedback, ISessionService, IStorageService } from '../../interfaces';
import { SSOAuthenticationHelper } from '../../services/authentication/sso-authentication.helper';
import { DEFAULT_AUTHENTICATION_ENTRY_POINT } from '../../constants';
import { LoginDialogResourceProvider } from './login-dialog-resource-provider';
var LoginDialogComponent = /** @class */ (function () {
    function LoginDialogComponent(modalRef, logService, httpClient, sessionService, storageService, stringUtils, urlUtils, ssoAuthenticationHelper, resource) {
        var _this = this;
        this.modalRef = modalRef;
        this.logService = logService;
        this.httpClient = httpClient;
        this.sessionService = sessionService;
        this.storageService = storageService;
        this.stringUtils = stringUtils;
        this.urlUtils = urlUtils;
        this.ssoAuthenticationHelper = ssoAuthenticationHelper;
        this.resource = resource;
        this.hostClass = true;
        this.data = null;
        this.authURIKey = '';
        this.authURI = '';
        this.isFullScreen = false;
        this.ssoEnabled = false;
        this.form = new FormGroup({
            username: new FormControl('', Validators.required),
            password: new FormControl('', Validators.required)
        });
        this.signinWithSSO = function () {
            _this.form.setErrors(null);
            return _this.ssoAuthenticationHelper
                .launchSSODialog()
                .then(function (data) { return _this.storeAccessToken(data); }, function (error) { return _this.APIAuthenticationFailureReportFactory(error); })
                .then(function (userHasChanged) { return _this.acceptUser(userHasChanged); });
        };
        this.sendCredentials = function (payload) {
            return _this.httpClient
                .request('POST', _this.authURI, {
                headers: new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded'),
                body: _this.urlUtils.getQueryString(payload).replace('?', ''),
                observe: 'response'
            })
                .toPromise();
        };
    }
    LoginDialogComponent.prototype.ngOnInit = function () {
        this.data = this.modalRef.data || {};
        this.authURI = this.data.authURI;
        this.isFullScreen = this.data.isFullScreen;
        this.ssoEnabled = this.data.ssoEnabled && this.isMainEndPoint();
        this.storageService.removeAuthToken(this.authURI);
        this.authURIKey = btoa(this.authURI).replace(/=/g, '');
        if (this.ssoAuthenticationHelper.isAutoSSOMain()) {
            this.signinWithSSO();
        }
    };
    LoginDialogComponent.prototype.signinWithCredentials = function () {
        var _this = this;
        this.form.setErrors(null);
        if (this.hasRequiredCredentialsError()) {
            this.form.setErrors({
                credentialsRequiredError: 'se.logindialogform.username.and.password.required'
            });
            return Promise.reject();
        }
        var payload = tslib_1.__assign({}, (this.data.clientCredentials || {}), { username: this.form.get('username').value, password: this.form.get('password').value, grant_type: 'password' });
        return this.sendCredentials(payload)
            .then(function (response) {
            return _this.storeAccessToken(response);
        }, function (error) { return _this.APIAuthenticationFailureReportFactory(error); })
            .then(function (hasUserChanged) { return _this.acceptUser(hasUserChanged); });
    };
    LoginDialogComponent.prototype.isMainEndPoint = function () {
        return DEFAULT_AUTHENTICATION_ENTRY_POINT === this.authURI;
    };
    LoginDialogComponent.prototype.storeAccessToken = function (response) {
        var token = response instanceof HttpResponse ? response.body : response;
        this.storageService.storeAuthToken(this.authURI, token);
        this.logService.debug("API Authentication Success: " + this.authURI);
        return this.isMainEndPoint()
            ? this.sessionService.hasUserChanged()
            : Promise.resolve(false);
    };
    LoginDialogComponent.prototype.APIAuthenticationFailureReportFactory = function (error) {
        this.logService.debug("API Authentication Failure: " + this.authURI + " status: " + error.status);
        this.form.setErrors({
            asyncValidationError: (error.error && this.stringUtils.sanitize(error.error.error_description)) ||
                'se.logindialogform.oauth.error.default'
        });
        return Promise.reject(error);
    };
    LoginDialogComponent.prototype.acceptUser = function (userHasChanged) {
        this.modalRef.close({
            userHasChanged: userHasChanged
        });
        if (this.isMainEndPoint()) {
            this.sessionService.setCurrentUsername();
        }
        return Promise.resolve({ userHasChanged: userHasChanged });
    };
    LoginDialogComponent.prototype.hasRequiredCredentialsError = function () {
        var username = this.form.get('username');
        var password = this.form.get('password');
        return ((username.errors && username.errors.required) ||
            (password.errors && password.errors.required));
    };
    LoginDialogComponent.ctorParameters = function () { return [
        { type: ModalRef },
        { type: LogService },
        { type: HttpClient },
        { type: ISessionService },
        { type: IStorageService },
        { type: StringUtils },
        { type: UrlUtils },
        { type: SSOAuthenticationHelper },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LoginDialogResourceProvider,] }] }
    ]; };
    tslib_1.__decorate([
        HostBinding('class.su-login-dialog'),
        tslib_1.__metadata("design:type", Boolean)
    ], LoginDialogComponent.prototype, "hostClass", void 0);
    LoginDialogComponent = tslib_1.__decorate([
        Component({
            selector: 'su-login-dialog',
            template: "<div class=\"su-login\">\n    <div class=\"su-login--wrapper\">\n        <div\n            class=\"su-login--logo-wrapper\"\n            [ngClass]=\"{ 'su-login--logo-wrapper_full': !isFullScreen }\"\n        >\n            <img *ngIf=\"resource?.topLogoURL\" [src]=\"resource?.topLogoURL\" class=\"su-login--logo\" />\n            <span class=\"su-login--logo-text\" translate=\"se.application.name\"> </span>\n        </div>\n        <form\n            autocomplete=\"off\"\n            novalidate\n            [formGroup]=\"form\"\n            (submit)=\"signinWithCredentials()\"\n            class=\"su-login--form\"\n        >\n            <div class=\"su-login--auth-message\" *ngIf=\"isFullScreen\">\n                <div translate=\"se.logindialogform.reauth.message1\"></div>\n                <div translate=\"se.logindialogform.reauth.message2\"></div>\n            </div>\n\n            <!--Validation Errors-->\n            <div *ngIf=\"form.errors\" class=\"su-login--form-group\">\n                <fd-alert\n                    type=\"error\"\n                    class=\"su-login--alert-error\"\n                    id=\"invalidError\"\n                    [dismissible]=\"false\"\n                >\n                    <ng-container *ngIf=\"form.errors?.credentialsRequiredError\">\n                        {{ form.errors.credentialsRequiredError | translate }}\n                    </ng-container>\n\n                    <ng-container *ngIf=\"form.errors?.asyncValidationError\">\n                        {{ form.errors.asyncValidationError | translate }}\n                    </ng-container>\n                </fd-alert>\n            </div>\n\n            <div class=\"su-login--form-group\">\n                <input\n                    fd-form-control\n                    type=\"text\"\n                    id=\"username_{{ authURIKey }}\"\n                    name=\"username\"\n                    formControlName=\"username\"\n                    placeholder=\"{{ 'se.authentication.form.input.username' | translate }}\"\n                    autofocus\n                    autocomplete=\"username\"\n                />\n            </div>\n            <div class=\"su-login--form-group\">\n                <input\n                    fd-form-control\n                    type=\"password\"\n                    id=\"password_{{ authURIKey }}\"\n                    name=\"password\"\n                    placeholder=\"{{ 'se.authentication.form.input.password' | translate }}\"\n                    formControlName=\"password\"\n                    autocomplete=\"current-password\"\n                    required\n                />\n            </div>\n            <div class=\"su-login--form-group\">\n                <su-language-dropdown class=\"su-login-language\"></su-language-dropdown>\n            </div>\n            <button\n                fd-button\n                options=\"emphasized\"\n                class=\"su-login--btn\"\n                id=\"submit_{{ authURIKey }}\"\n                name=\"submit\"\n                type=\"submit\"\n                translate=\"se.authentication.form.button.submit\"\n            ></button>\n        </form>\n        <form\n            *ngIf=\"ssoEnabled\"\n            class=\"su-login--form-sso\"\n            name=\"loginDialogFormSSO\"\n            novalidate\n            (submit)=\"signinWithSSO()\"\n        >\n            <button\n                fd-button\n                options=\"emphasized\"\n                class=\"fd-button--emphasized su-login--btn\"\n                id=\"submitSSO_{{ authURIKey }}\"\n                name=\"submitSSO\"\n                type=\"submit\"\n                translate=\"se.authentication.form.button.submit.sso\"\n            ></button>\n        </form>\n    </div>\n</div>\n<img\n    *ngIf=\"resource?.bottomLogoURL\"\n    [src]=\"resource?.bottomLogoURL\"\n    class=\"su-login--logo__best-run\"\n/>\n",
            styles: [".su-login{width:500px;min-height:440px;box-shadow:0 1px 4px 0 rgba(0,0,0,.1);background-color:#fff;border-radius:4px;border:1px solid rgba(0,0,0,.2);padding:20px;margin:0 auto}.su-login--wrapper{padding:40px 100px;width:100%}.su-login--form-group{margin-bottom:20px}.su-login--form-sso{margin-top:20px}.su-login--logo-wrapper{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center}.su-login--logo-wrapper.su-login--logo-wrapper_full{padding-bottom:45px}.su-login--logo{height:44px}.su-login--logo-text{font-family:\"72\",web,\"Open Sans\",sans-serif;font-size:1.7142857143rem;line-height:1.3333333333;padding-left:16px;color:#32363a;font-weight:700}.su-login--logo__best-run{position:absolute;bottom:30px;left:30px}.su-login--btn{font-size:1rem;line-height:1.4285714286;font-weight:400;width:100%}.su-login--auth-message{padding-top:20px;padding-bottom:20px;font-size:1rem;line-height:1.4285714286;font-weight:400}.su-login--alert-error{margin-bottom:0;box-shadow:none}"]
        }),
        tslib_1.__param(8, Optional()), tslib_1.__param(8, Inject(LoginDialogResourceProvider)),
        tslib_1.__metadata("design:paramtypes", [ModalRef,
            LogService,
            HttpClient,
            ISessionService,
            IStorageService,
            StringUtils,
            UrlUtils,
            SSOAuthenticationHelper, Object])
    ], LoginDialogComponent);
    return LoginDialogComponent;
}());
export { LoginDialogComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4tZGlhbG9nLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvbG9naW4tZGlhbG9nL2xvZ2luLWRpYWxvZy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRztBQUNIOzs7R0FHRztBQUNILE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakYsT0FBTyxFQUFtQixXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUNILFVBQVUsRUFDVixVQUFVLEVBQ1YsbUJBQW1CLEVBQ25CLGVBQWUsRUFDZixlQUFlLEVBQ2xCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0seURBQXlELENBQUM7QUFDbEcsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDckUsT0FBTyxFQUF1QiwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBYXBHO0lBYUksOEJBQ1ksUUFBa0IsRUFDbEIsVUFBc0IsRUFDdEIsVUFBc0IsRUFDdEIsY0FBK0IsRUFDL0IsY0FBK0IsRUFDL0IsV0FBd0IsRUFDeEIsUUFBa0IsRUFDbEIsdUJBQWdELEVBQ0EsUUFBNkI7UUFUekYsaUJBVUk7UUFUUSxh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QU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLGNBQWMsZ0JBQUEsRUFBRSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLDBEQUEyQixHQUFuQztRQUNJLElBQU0sUUFBUSxHQUFvQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQW9CLENBQUM7UUFDL0UsSUFBTSxRQUFRLEdBQW9CLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBb0IsQ0FBQztRQUUvRSxPQUFPLENBQ0gsQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1lBQzdDLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUNoRCxDQUFDO0lBQ04sQ0FBQzs7Z0JBNUhxQixRQUFRO2dCQUNOLFVBQVU7Z0JBQ1YsVUFBVTtnQkFDTixlQUFlO2dCQUNmLGVBQWU7Z0JBQ2xCLFdBQVc7Z0JBQ2QsUUFBUTtnQkFDTyx1QkFBdUI7Z0RBQ3ZELFFBQVEsWUFBSSxNQUFNLFNBQUMsMkJBQTJCOztJQXJCYjtRQUFyQyxXQUFXLENBQUMsdUJBQXVCLENBQUM7OzJEQUEyQjtJQUR2RCxvQkFBb0I7UUFMaEMsU0FBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLGlCQUFpQjtZQUUzQiwwMkhBQTRDOztTQUMvQyxDQUFDO1FBdUJPLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLDJCQUEyQixDQUFDLENBQUE7aURBUjlCLFFBQVE7WUFDTixVQUFVO1lBQ1YsVUFBVTtZQUNOLGVBQWU7WUFDZixlQUFlO1lBQ2xCLFdBQVc7WUFDZCxRQUFRO1lBQ08sdUJBQXVCO09BckJuRCxvQkFBb0IsQ0EySWhDO0lBQUQsMkJBQUM7Q0FBQSxBQTNJRCxJQTJJQztTQTNJWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAyMCBTQVAgU0Ugb3IgYW4gU0FQIGFmZmlsaWF0ZSBjb21wYW55LiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogQG1vZHVsZSBzbWFydHV0aWxzXG4gKi9cbi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuaW1wb3J0IHsgQ29tcG9uZW50LCBIb3N0QmluZGluZywgSW5qZWN0LCBPbkluaXQsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIEZvcm1Db250cm9sLCBGb3JtR3JvdXAsIFZhbGlkYXRvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSwgSHR0cEhlYWRlcnMsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE1vZGFsUmVmIH0gZnJvbSAnQGZ1bmRhbWVudGFsLW5neC9jb3JlJztcblxuaW1wb3J0IHsgU3RyaW5nVXRpbHMsIFVybFV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2xvZy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gICAgSUF1dGhUb2tlbixcbiAgICBJTG9naW5EYXRhLFxuICAgIElMb2dpbk1vZGFsRmVlZGJhY2ssXG4gICAgSVNlc3Npb25TZXJ2aWNlLFxuICAgIElTdG9yYWdlU2VydmljZVxufSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFNTT0F1dGhlbnRpY2F0aW9uSGVscGVyIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvYXV0aGVudGljYXRpb24vc3NvLWF1dGhlbnRpY2F0aW9uLmhlbHBlcic7XG5pbXBvcnQgeyBERUZBVUxUX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IExvZ2luRGlhbG9nUmVzb3VyY2UsIExvZ2luRGlhbG9nUmVzb3VyY2VQcm92aWRlciB9IGZyb20gJy4vbG9naW4tZGlhbG9nLXJlc291cmNlLXByb3ZpZGVyJztcblxuaW50ZXJmYWNlIElSZXF1ZXN0UGF5bG9hZCB7XG4gICAgdXNlcm5hbWU6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICAgIGdyYW50X3R5cGU6IHN0cmluZztcbn1cblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdzdS1sb2dpbi1kaWFsb2cnLFxuICAgIHN0eWxlVXJsczogWycuL2xvZ2luLWRpYWxvZy5jb21wb25lbnQuc2NzcyddLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9sb2dpbi1kaWFsb2cuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIExvZ2luRGlhbG9nQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzLnN1LWxvZ2luLWRpYWxvZycpIGhvc3RDbGFzczogYm9vbGVhbiA9IHRydWU7XG5cbiAgICBwdWJsaWMgZGF0YTogSUxvZ2luRGF0YSA9IChudWxsIGFzIHVua25vd24pIGFzIElMb2dpbkRhdGE7XG4gICAgcHVibGljIGF1dGhVUklLZXk6IHN0cmluZyA9ICcnO1xuICAgIHB1YmxpYyBhdXRoVVJJOiBzdHJpbmcgPSAnJztcbiAgICBwdWJsaWMgaXNGdWxsU2NyZWVuOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHVibGljIHNzb0VuYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgZm9ybTogRm9ybUdyb3VwID0gbmV3IEZvcm1Hcm91cCh7XG4gICAgICAgIHVzZXJuYW1lOiBuZXcgRm9ybUNvbnRyb2woJycsIFZhbGlkYXRvcnMucmVxdWlyZWQpLFxuICAgICAgICBwYXNzd29yZDogbmV3IEZvcm1Db250cm9sKCcnLCBWYWxpZGF0b3JzLnJlcXVpcmVkKVxuICAgIH0pO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgbW9kYWxSZWY6IE1vZGFsUmVmLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICAgICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTogSVNlc3Npb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHN0b3JhZ2VTZXJ2aWNlOiBJU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc3RyaW5nVXRpbHM6IFN0cmluZ1V0aWxzLFxuICAgICAgICBwcml2YXRlIHVybFV0aWxzOiBVcmxVdGlscyxcbiAgICAgICAgcHJpdmF0ZSBzc29BdXRoZW50aWNhdGlvbkhlbHBlcjogU1NPQXV0aGVudGljYXRpb25IZWxwZXIsXG4gICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTG9naW5EaWFsb2dSZXNvdXJjZVByb3ZpZGVyKSBwdWJsaWMgcmVzb3VyY2U6IExvZ2luRGlhbG9nUmVzb3VyY2VcbiAgICApIHt9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5tb2RhbFJlZi5kYXRhIHx8IHt9O1xuXG4gICAgICAgIHRoaXMuYXV0aFVSSSA9IHRoaXMuZGF0YS5hdXRoVVJJO1xuXG4gICAgICAgIHRoaXMuaXNGdWxsU2NyZWVuID0gdGhpcy5kYXRhLmlzRnVsbFNjcmVlbiBhcyBib29sZWFuO1xuICAgICAgICB0aGlzLnNzb0VuYWJsZWQgPSAodGhpcy5kYXRhLnNzb0VuYWJsZWQgYXMgYm9vbGVhbikgJiYgdGhpcy5pc01haW5FbmRQb2ludCgpO1xuXG4gICAgICAgIHRoaXMuc3RvcmFnZVNlcnZpY2UucmVtb3ZlQXV0aFRva2VuKHRoaXMuYXV0aFVSSSk7XG5cbiAgICAgICAgdGhpcy5hdXRoVVJJS2V5ID0gYnRvYSh0aGlzLmF1dGhVUkkpLnJlcGxhY2UoLz0vZywgJycpO1xuXG4gICAgICAgIGlmICh0aGlzLnNzb0F1dGhlbnRpY2F0aW9uSGVscGVyLmlzQXV0b1NTT01haW4oKSkge1xuICAgICAgICAgICAgdGhpcy5zaWduaW5XaXRoU1NPKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2lnbmluV2l0aFNTTyA9ICgpOiBQcm9taXNlPElMb2dpbk1vZGFsRmVlZGJhY2s+ID0+IHtcbiAgICAgICAgdGhpcy5mb3JtLnNldEVycm9ycyhudWxsKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5zc29BdXRoZW50aWNhdGlvbkhlbHBlclxuICAgICAgICAgICAgLmxhdW5jaFNTT0RpYWxvZygpXG4gICAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgICAgICAoZGF0YTogSUF1dGhUb2tlbikgPT4gdGhpcy5zdG9yZUFjY2Vzc1Rva2VuKGRhdGEpLFxuICAgICAgICAgICAgICAgIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMuQVBJQXV0aGVudGljYXRpb25GYWlsdXJlUmVwb3J0RmFjdG9yeShlcnJvcilcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC50aGVuKCh1c2VySGFzQ2hhbmdlZDogYm9vbGVhbikgPT4gdGhpcy5hY2NlcHRVc2VyKHVzZXJIYXNDaGFuZ2VkKSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBzaWduaW5XaXRoQ3JlZGVudGlhbHMoKTogUHJvbWlzZTxJTG9naW5Nb2RhbEZlZWRiYWNrPiB7XG4gICAgICAgIHRoaXMuZm9ybS5zZXRFcnJvcnMobnVsbCk7XG5cbiAgICAgICAgaWYgKHRoaXMuaGFzUmVxdWlyZWRDcmVkZW50aWFsc0Vycm9yKCkpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybS5zZXRFcnJvcnMoe1xuICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzUmVxdWlyZWRFcnJvcjogJ3NlLmxvZ2luZGlhbG9nZm9ybS51c2VybmFtZS5hbmQucGFzc3dvcmQucmVxdWlyZWQnXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgICAgICAgLi4uKHRoaXMuZGF0YS5jbGllbnRDcmVkZW50aWFscyB8fCB7fSksXG4gICAgICAgICAgICB1c2VybmFtZTogKHRoaXMuZm9ybS5nZXQoJ3VzZXJuYW1lJykgYXMgRm9ybUNvbnRyb2wpLnZhbHVlLFxuICAgICAgICAgICAgcGFzc3dvcmQ6ICh0aGlzLmZvcm0uZ2V0KCdwYXNzd29yZCcpIGFzIEZvcm1Db250cm9sKS52YWx1ZSxcbiAgICAgICAgICAgIGdyYW50X3R5cGU6ICdwYXNzd29yZCdcbiAgICAgICAgfSBhcyBJUmVxdWVzdFBheWxvYWQ7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZENyZWRlbnRpYWxzKHBheWxvYWQpXG4gICAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgICAgICAocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxJQXV0aFRva2VuPiB8IElBdXRoVG9rZW4pID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmVBY2Nlc3NUb2tlbihyZXNwb25zZSksXG4gICAgICAgICAgICAgICAgKGVycm9yKSA9PiB0aGlzLkFQSUF1dGhlbnRpY2F0aW9uRmFpbHVyZVJlcG9ydEZhY3RvcnkoZXJyb3IpXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudGhlbigoaGFzVXNlckNoYW5nZWQ6IGJvb2xlYW4pID0+IHRoaXMuYWNjZXB0VXNlcihoYXNVc2VyQ2hhbmdlZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNNYWluRW5kUG9pbnQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBERUZBVUxUX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UID09PSB0aGlzLmF1dGhVUkk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdG9yZUFjY2Vzc1Rva2VuKFxuICAgICAgICByZXNwb25zZTogSHR0cFJlc3BvbnNlPElBdXRoVG9rZW4+IHwgSUF1dGhUb2tlblxuICAgICk6IFByb21pc2VMaWtlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgdG9rZW4gPSByZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSA/IHJlc3BvbnNlLmJvZHkgOiByZXNwb25zZTtcbiAgICAgICAgdGhpcy5zdG9yYWdlU2VydmljZS5zdG9yZUF1dGhUb2tlbih0aGlzLmF1dGhVUkksIHRva2VuIGFzIElBdXRoVG9rZW4pO1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZGVidWcoYEFQSSBBdXRoZW50aWNhdGlvbiBTdWNjZXNzOiAke3RoaXMuYXV0aFVSSX1gKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNNYWluRW5kUG9pbnQoKVxuICAgICAgICAgICAgPyB0aGlzLnNlc3Npb25TZXJ2aWNlLmhhc1VzZXJDaGFuZ2VkKClcbiAgICAgICAgICAgIDogUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNlbmRDcmVkZW50aWFscyA9IChwYXlsb2FkOiBJUmVxdWVzdFBheWxvYWQpOiBQcm9taXNlPEh0dHBSZXNwb25zZTxJQXV0aFRva2VuPj4gPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgICAucmVxdWVzdDxJQXV0aFRva2VuPignUE9TVCcsIHRoaXMuYXV0aFVSSSwge1xuICAgICAgICAgICAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycygpLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpLFxuICAgICAgICAgICAgICAgIGJvZHk6IHRoaXMudXJsVXRpbHMuZ2V0UXVlcnlTdHJpbmcocGF5bG9hZCkucmVwbGFjZSgnPycsICcnKSxcbiAgICAgICAgICAgICAgICBvYnNlcnZlOiAncmVzcG9uc2UnXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIEFQSUF1dGhlbnRpY2F0aW9uRmFpbHVyZVJlcG9ydEZhY3RvcnkoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogUHJvbWlzZTxuZXZlcj4ge1xuICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZGVidWcoXG4gICAgICAgICAgICBgQVBJIEF1dGhlbnRpY2F0aW9uIEZhaWx1cmU6ICR7dGhpcy5hdXRoVVJJfSBzdGF0dXM6ICR7ZXJyb3Iuc3RhdHVzfWBcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLmZvcm0uc2V0RXJyb3JzKHtcbiAgICAgICAgICAgIGFzeW5jVmFsaWRhdGlvbkVycm9yOlxuICAgICAgICAgICAgICAgIChlcnJvci5lcnJvciAmJiB0aGlzLnN0cmluZ1V0aWxzLnNhbml0aXplKGVycm9yLmVycm9yLmVycm9yX2Rlc2NyaXB0aW9uKSkgfHxcbiAgICAgICAgICAgICAgICAnc2UubG9naW5kaWFsb2dmb3JtLm9hdXRoLmVycm9yLmRlZmF1bHQnXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhY2NlcHRVc2VyKHVzZXJIYXNDaGFuZ2VkOiBib29sZWFuKTogUHJvbWlzZTxJTG9naW5Nb2RhbEZlZWRiYWNrPiB7XG4gICAgICAgIHRoaXMubW9kYWxSZWYuY2xvc2Uoe1xuICAgICAgICAgICAgdXNlckhhc0NoYW5nZWRcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0aGlzLmlzTWFpbkVuZFBvaW50KCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvblNlcnZpY2Uuc2V0Q3VycmVudFVzZXJuYW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHVzZXJIYXNDaGFuZ2VkIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzUmVxdWlyZWRDcmVkZW50aWFsc0Vycm9yKCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB1c2VybmFtZTogQWJzdHJhY3RDb250cm9sID0gdGhpcy5mb3JtLmdldCgndXNlcm5hbWUnKSBhcyBBYnN0cmFjdENvbnRyb2w7XG4gICAgICAgIGNvbnN0IHBhc3N3b3JkOiBBYnN0cmFjdENvbnRyb2wgPSB0aGlzLmZvcm0uZ2V0KCdwYXNzd29yZCcpIGFzIEFic3RyYWN0Q29udHJvbDtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgKHVzZXJuYW1lLmVycm9ycyAmJiB1c2VybmFtZS5lcnJvcnMucmVxdWlyZWQpIHx8XG4gICAgICAgICAgICAocGFzc3dvcmQuZXJyb3JzICYmIHBhc3N3b3JkLmVycm9ycy5yZXF1aXJlZClcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=