/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Injectable } from '@angular/core';
import { Deferred, PromiseUtils, WindowUtils } from '../../../utils';
import { LogService } from '../../log.service';
/** @internal */
var CacheEngine = /** @class */ (function () {
    function CacheEngine(windowUtils, promiseUtils, logService) {
        this.windowUtils = windowUtils;
        this.promiseUtils = promiseUtils;
        this.logService = logService;
        this.cachedItemsRegistry = [];
        this.startBackgroundMonitoringJob();
    }
    CacheEngine_1 = CacheEngine;
    CacheEngine.prototype.addItem = function (item, cacheTiming, refresh) {
        if (this.getItemIndex(item) === -1) {
            this.cachedItemsRegistry.push({
                item: item,
                cacheTiming: cacheTiming,
                refresh: refresh,
                completed: false,
                processing: false,
                defer: this.promiseUtils.defer()
            });
        }
        else {
            this.logService.warn("CacheEngine - item already exist for id: " + item.id);
        }
    };
    CacheEngine.prototype.getItemById = function (id) {
        var match = this.cachedItemsRegistry.find(function (obj) { return obj.item.id === id; });
        return match ? match.item : null;
    };
    CacheEngine.prototype.handle = function (item) {
        var obj = this.cachedItemsRegistry[this.getItemIndex(item)];
        if (obj.completed && !this.hasExpired(item)) {
            obj.defer.resolve(item.cache);
        }
        else if (!obj.processing) {
            obj.processing = true;
            this.refreshCache(obj);
        }
        return obj.defer.promise;
    };
    CacheEngine.prototype.evict = function () {
        var _this = this;
        var tags = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            tags[_i] = arguments[_i];
        }
        tags.forEach(function (tag) {
            _this.cachedItemsRegistry
                .filter(function (obj) { return obj.item.evictionTags.indexOf(tag) > -1; })
                .forEach(function (obj) { return _this.cachedItemsRegistry.splice(_this.getItemIndex(obj.item), 1); });
        });
    };
    // regularly go though cache data and call prebound methods to refresh data when needed.
    CacheEngine.prototype.startBackgroundMonitoringJob = function () {
        var _this = this;
        this.windowUtils.runIntervalOutsideAngular(function () {
            return Promise.all(_this.cachedItemsRegistry
                .filter(function (obj) { return _this.needRefresh(obj.item); })
                .map(function (obj) { return _this.refreshCache(obj); }));
        }, CacheEngine_1.BACKGROUND_REFRESH_INTERVAL);
    };
    CacheEngine.prototype.refreshCache = function (obj) {
        var _this = this;
        return obj.refresh().then(function (value) {
            // TODO: read value.metadata to refresh expiry/refresh ages.
            obj.cacheTiming.setAge(obj.item);
            obj.item.cache = value;
            obj.item.timestamp = new Date().getTime();
            obj.completed = true;
            obj.processing = false;
            obj.defer.resolve(value);
        }, function (e) {
            _this.logService.debug("CacheEngine - unable to refresh cache for id: " + obj.item.id, e);
            delete obj.item.cache;
            obj.defer.resolve(e);
        });
    };
    CacheEngine.prototype.hasExpired = function (item) {
        return item.timestamp + item.expirationAge <= new Date().getTime();
    };
    CacheEngine.prototype.needRefresh = function (item) {
        return item.timestamp + item.refreshAge <= new Date().getTime();
    };
    CacheEngine.prototype.getItemIndex = function (item) {
        return this.cachedItemsRegistry.findIndex(function (o) { return o.item.id === item.id; });
    };
    var CacheEngine_1;
    CacheEngine.BACKGROUND_REFRESH_INTERVAL = 10000;
    CacheEngine.ctorParameters = function () { return [
        { type: WindowUtils },
        { type: PromiseUtils },
        { type: LogService }
    ]; };
    CacheEngine = CacheEngine_1 = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [WindowUtils,
            PromiseUtils,
            LogService])
    ], CacheEngine);
    return CacheEngine;
}());
export { CacheEngine };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtZW5naW5lLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNtYXJ0L3V0aWxzLyIsInNvdXJjZXMiOlsic2VydmljZXMvY2FjaGUvZW5naW5lL2NhY2hlLWVuZ2luZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHO0FBQ0gsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFjL0MsZ0JBQWdCO0FBRWhCO0lBSUkscUJBQ1ksV0FBd0IsRUFDeEIsWUFBMEIsRUFDMUIsVUFBc0I7UUFGdEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUwxQix3QkFBbUIsR0FBeUIsRUFBRSxDQUFDO1FBT25ELElBQUksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO0lBQ3hDLENBQUM7b0JBVlEsV0FBVztJQVliLDZCQUFPLEdBQWQsVUFDSSxJQUFxQixFQUNyQixXQUF5QixFQUN6QixPQUE0QjtRQUU1QixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDaEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQztnQkFDMUIsSUFBSSxNQUFBO2dCQUNKLFdBQVcsYUFBQTtnQkFDWCxPQUFPLFNBQUE7Z0JBQ1AsU0FBUyxFQUFFLEtBQUs7Z0JBQ2hCLFVBQVUsRUFBRSxLQUFLO2dCQUNqQixLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUU7YUFDbkMsQ0FBQyxDQUFDO1NBQ047YUFBTTtZQUNILElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLDhDQUE0QyxJQUFJLENBQUMsRUFB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LFdBQVcsQ0FtR3ZCO0lBQUQsa0JBQUM7Q0FBQSxBQW5HRCxJQW1HQztTQW5HWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEZWZlcnJlZCwgUHJvbWlzZVV0aWxzLCBXaW5kb3dVdGlscyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9sb2cuc2VydmljZSc7XG5cbmltcG9ydCB7IElDYWNoZUl0ZW0sIElDYWNoZVRpbWluZywgSU1ldGFkYXRhIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGludGVyZmFjZSBJQ2FjaGVJdGVtUmVnaXN0cnkge1xuICAgIGl0ZW06IElDYWNoZUl0ZW08YW55PjtcbiAgICBjYWNoZVRpbWluZzogSUNhY2hlVGltaW5nO1xuICAgIGNvbXBsZXRlZDogYm9vbGVhbjtcbiAgICBwcm9jZXNzaW5nOiBib29sZWFuO1xuICAgIGRlZmVyOiBEZWZlcnJlZDxhbnk+O1xuICAgIHJlZnJlc2g8VD4oKTogUHJvbWlzZTxUPjtcbn1cblxuLyoqIEBpbnRlcm5hbCAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhY2hlRW5naW5lIHtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEJBQ0tHUk9VTkRfUkVGUkVTSF9JTlRFUlZBTDogbnVtYmVyID0gMTAwMDA7XG4gICAgcHJpdmF0ZSBjYWNoZWRJdGVtc1JlZ2lzdHJ5OiBJQ2FjaGVJdGVtUmVnaXN0cnlbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgd2luZG93VXRpbHM6IFdpbmRvd1V0aWxzLFxuICAgICAgICBwcml2YXRlIHByb21pc2VVdGlsczogUHJvbWlzZVV0aWxzLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2VcbiAgICApIHtcbiAgICAgICAgdGhpcy5zdGFydEJhY2tncm91bmRNb25pdG9yaW5nSm9iKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEl0ZW0oXG4gICAgICAgIGl0ZW06IElDYWNoZUl0ZW08YW55PixcbiAgICAgICAgY2FjaGVUaW1pbmc6IElDYWNoZVRpbWluZyxcbiAgICAgICAgcmVmcmVzaDogPFQ+KCkgPT4gUHJvbWlzZTxUPlxuICAgICk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5nZXRJdGVtSW5kZXgoaXRlbSkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnkucHVzaCh7XG4gICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICBjYWNoZVRpbWluZyxcbiAgICAgICAgICAgICAgICByZWZyZXNoLFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgZGVmZXI6IHRoaXMucHJvbWlzZVV0aWxzLmRlZmVyKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLndhcm4oYENhY2hlRW5naW5lIC0gaXRlbSBhbHJlYWR5IGV4aXN0IGZvciBpZDogJHtpdGVtLmlkfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldEl0ZW1CeUlkKGlkOiBzdHJpbmcpOiBJQ2FjaGVJdGVtPGFueT4gfCBudWxsIHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnkuZmluZCgob2JqKSA9PiBvYmouaXRlbS5pZCA9PT0gaWQpO1xuICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaC5pdGVtIDogbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgaGFuZGxlPFQ+KGl0ZW06IElDYWNoZUl0ZW08YW55Pik6IFByb21pc2U8VD4ge1xuICAgICAgICBjb25zdCBvYmogPSB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnlbdGhpcy5nZXRJdGVtSW5kZXgoaXRlbSldO1xuICAgICAgICBpZiAob2JqLmNvbXBsZXRlZCAmJiAhdGhpcy5oYXNFeHBpcmVkKGl0ZW0pKSB7XG4gICAgICAgICAgICBvYmouZGVmZXIucmVzb2x2ZShpdGVtLmNhY2hlKTtcbiAgICAgICAgfSBlbHNlIGlmICghb2JqLnByb2Nlc3NpbmcpIHtcbiAgICAgICAgICAgIG9iai5wcm9jZXNzaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaENhY2hlKG9iaik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9iai5kZWZlci5wcm9taXNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBldmljdCguLi50YWdzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICB0YWdzLmZvckVhY2goKHRhZykgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5XG4gICAgICAgICAgICAgICAgLmZpbHRlcigob2JqKSA9PiBvYmouaXRlbS5ldmljdGlvblRhZ3MuaW5kZXhPZih0YWcpID4gLTEpXG4gICAgICAgICAgICAgICAgLmZvckVhY2goKG9iaikgPT4gdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5LnNwbGljZSh0aGlzLmdldEl0ZW1JbmRleChvYmouaXRlbSksIDEpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gcmVndWxhcmx5IGdvIHRob3VnaCBjYWNoZSBkYXRhIGFuZCBjYWxsIHByZWJvdW5kIG1ldGhvZHMgdG8gcmVmcmVzaCBkYXRhIHdoZW4gbmVlZGVkLlxuICAgIHByb3RlY3RlZCBzdGFydEJhY2tncm91bmRNb25pdG9yaW5nSm9iKCk6IHZvaWQge1xuICAgICAgICB0aGlzLndpbmRvd1V0aWxzLnJ1bkludGVydmFsT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVkSXRlbXNSZWdpc3RyeVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChvYmopID0+IHRoaXMubmVlZFJlZnJlc2gob2JqLml0ZW0pKVxuICAgICAgICAgICAgICAgICAgICAubWFwKChvYmopID0+IHRoaXMucmVmcmVzaENhY2hlKG9iaikpXG4gICAgICAgICAgICApO1xuICAgICAgICB9LCBDYWNoZUVuZ2luZS5CQUNLR1JPVU5EX1JFRlJFU0hfSU5URVJWQUwpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCByZWZyZXNoQ2FjaGU8VD4ob2JqOiBJQ2FjaGVJdGVtUmVnaXN0cnkpOiBQcm9taXNlPFQgfCB2b2lkPiB7XG4gICAgICAgIHJldHVybiBvYmoucmVmcmVzaDxJTWV0YWRhdGE+KCkudGhlbihcbiAgICAgICAgICAgICh2YWx1ZTogSU1ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gVE9ETzogcmVhZCB2YWx1ZS5tZXRhZGF0YSB0byByZWZyZXNoIGV4cGlyeS9yZWZyZXNoIGFnZXMuXG4gICAgICAgICAgICAgICAgb2JqLmNhY2hlVGltaW5nLnNldEFnZShvYmouaXRlbSk7XG4gICAgICAgICAgICAgICAgb2JqLml0ZW0uY2FjaGUgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBvYmouaXRlbS50aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBvYmouY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBvYmoucHJvY2Vzc2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIG9iai5kZWZlci5yZXNvbHZlKHZhbHVlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmRlYnVnKFxuICAgICAgICAgICAgICAgICAgICBgQ2FjaGVFbmdpbmUgLSB1bmFibGUgdG8gcmVmcmVzaCBjYWNoZSBmb3IgaWQ6ICR7b2JqLml0ZW0uaWR9YCxcbiAgICAgICAgICAgICAgICAgICAgZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9iai5pdGVtLmNhY2hlO1xuICAgICAgICAgICAgICAgIG9iai5kZWZlci5yZXNvbHZlKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzRXhwaXJlZChpdGVtOiBJQ2FjaGVJdGVtPGFueT4pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGl0ZW0udGltZXN0YW1wICsgaXRlbS5leHBpcmF0aW9uQWdlIDw9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbmVlZFJlZnJlc2goaXRlbTogSUNhY2hlSXRlbTxhbnk+KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBpdGVtLnRpbWVzdGFtcCArIGl0ZW0ucmVmcmVzaEFnZSA8PSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEl0ZW1JbmRleChpdGVtOiBJQ2FjaGVJdGVtPGFueT4pOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5LmZpbmRJbmRleCgobykgPT4gby5pdGVtLmlkID09PSBpdGVtLmlkKTtcbiAgICB9XG59XG4iXX0=