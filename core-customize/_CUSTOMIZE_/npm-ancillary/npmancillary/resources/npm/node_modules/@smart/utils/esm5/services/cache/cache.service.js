/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as lodash from 'lodash';
import { Inject, Injectable } from '@angular/core';
import { FunctionsUtils, StringUtils } from '../../utils';
import { LogService } from '../log.service';
import { CacheEngine, DefaultCacheTiming, ICacheItem, ICacheTiming, IMetadata } from './engine';
import { EVENT_SERVICE } from '../../constants';
/**
 * @ngdoc service
 * @name @smartutils.services:CacheService
 * @description
 * Service to which the {@link @smartutils.object:@Cached @Cached} and {@link @smartutils.object:@InvalidateCache @InvalidateCache} annotations delegate to perform service method level caching.
 * It is not handled explicitly except for its evict method.
 */
var CacheService = /** @class */ (function () {
    function CacheService(logService, stringUtils, functionsUtils, eventService, cacheEngine) {
        this.logService = logService;
        this.stringUtils = stringUtils;
        this.functionsUtils = functionsUtils;
        this.eventService = eventService;
        this.cacheEngine = cacheEngine;
        this.predicatesRegistry = [];
        this.eventListeners = [];
        this.defaultCacheTiming = new DefaultCacheTiming(24 * 60 * 60 * 1000, 12 * 60 * 60 * 1000);
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:CacheService#register
     * @methodOf @smartutils.services:CacheService
     *
     * @description
     * Register a new predicate with it's associated cacheTiming.
     * Each time the @Cache annotation is handled, the CacheService try to find a matching cacheTiming for the given cacheActions.
     *
     * @param {ICachePredicate} test This function takes the cacheActions {@link @smartutils.object:CacheAction CacheAction} argument, and must return a Boolean that is true if the given cacheActions match the predicate.
     * @param {ICacheTiming} cacheTiming This function is used to call setAge(item: ICacheItem<any>) on the cached item.
     *
     * @return {CacheService} CacheService The CacheService instance.
     *
     * @example
     * ```ts
     * export class CustomCacheTiming implements ICacheTiming {
     * 	private expirationAge: number;
     * 	private refreshAge: number;
     *  constructor(expirationAge: number, refreshAge: number) {
     * 		// The cached response is discarded if it is older than the expiration age.
     * 		this.expirationAge = expirationAge;
     * 		// maximum age for the cached response to be considered "fresh."
     * 		this.refreshAge = refreshAge;
     * 	}
     * 	setAge(item: ICacheItem<any>): void {
     * 		item.expirationAge = this.expirationAge;
     * 		item.refreshAge = this.refreshAge;
     * 	}
     * 	};
     * 	const customCacheTiming = new CustomCacheTiming(30 * 60000, 15 * 60000);
     * 	const customContentPredicate: ICachePredicate = (cacheActions: CacheAction[]) => {
     * 		return cacheActions.find((cacheAction) => cacheAction.name === 'CUSTOM_TAG') !== null;
     * 	};
     * this.register(customContentPredicate, customCacheTiming);
     * ```
     */
    CacheService.prototype.register = function (test, cacheTiming) {
        this.predicatesRegistry.unshift({
            test: test,
            cacheTiming: cacheTiming
        });
        return this;
    };
    /**
     * public method but only meant to be used by @Cache annotation
     */
    CacheService.prototype.handle = function (service, methodName, preboundMethod, invocationArguments, cacheActions, tags) {
        var constructorName = this.functionsUtils.getInstanceConstructorName(service);
        var cachedItemId = window.btoa(constructorName + methodName) +
            this.stringUtils.encode(invocationArguments);
        var _item = this.cacheEngine.getItemById(cachedItemId);
        var item;
        if (!_item) {
            var partialItem = _item || {
                id: cachedItemId,
                timestamp: new Date().getTime(),
                evictionTags: this.collectEventNamesFromTags(tags),
                cache: null
            };
            var cacheTiming = this.findCacheTimingByCacheActions(cacheActions);
            if (!cacheTiming) {
                throw new Error('CacheService::handle - No predicate match.');
            }
            item = cacheTiming.setAge(partialItem);
            this.cacheEngine.addItem(item, cacheTiming, preboundMethod.bind.apply(preboundMethod, tslib_1.__spread([undefined], Array.prototype.slice.call(invocationArguments))));
            this.listenForEvictionByTags(tags);
        }
        else {
            item = _item;
        }
        return this.cacheEngine.handle(item);
    };
    /**
     * @ngdoc method
     * @name @smartutils.services:CacheService#evict
     * @methodOf  @smartutils.services:CacheService
     * @description
     * Will evict the entire cache of all methods of all services referencing either directly or indirectly the given {@link @smartutils.object:EvictionTag EvictionTags}
     * @param {...EvictionTag[]} evictionTags the {@link @smartutils.object:EvictionTag EvictionTags}
     */
    CacheService.prototype.evict = function () {
        var _a;
        var _this = this;
        var evictionTags = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            evictionTags[_i] = arguments[_i];
        }
        var tags = this.collectEventNamesFromTags(evictionTags);
        (_a = this.cacheEngine).evict.apply(_a, tslib_1.__spread(tags));
        tags.forEach(function (tag) { return _this.eventService.publish(tag); });
    };
    CacheService.prototype.listenForEvictionByTags = function (tags) {
        var _this = this;
        this.collectEventNamesFromTags(tags)
            .filter(function (eventId) {
            return _this.eventListeners.indexOf(eventId) === -1;
        })
            .forEach(function (eventId) {
            _this.logService.debug("registering event listener " + eventId);
            _this.eventListeners.push(eventId);
            _this.eventService.subscribe(eventId, function (evt, data) {
                _this.logService.debug("cleaning cache on event " + eventId);
                _this.cacheEngine.evict(eventId);
                return Promise.resolve({});
            });
        });
    };
    CacheService.prototype.collectEventNamesFromTags = function (tags) {
        var _this = this;
        if (tags && tags.length) {
            return lodash.union.apply(lodash, tslib_1.__spread(tags.map(function (t) { return _this.collectEventNamesFromTag(t); })));
        }
        else {
            return [];
        }
    };
    CacheService.prototype.collectEventNamesFromTag = function (tag) {
        var _this = this;
        return lodash.union.apply(lodash, tslib_1.__spread([[tag.event]], (tag.relatedTags ? tag.relatedTags.map(function (t) { return _this.collectEventNamesFromTag(t); }) : [])));
    };
    CacheService.prototype.findCacheTimingByCacheActions = function (cacheActions) {
        var predicate = this.predicatesRegistry.find(function (cacheTimingPredicate) { return cacheTimingPredicate.test(cacheActions); });
        return predicate ? predicate.cacheTiming : this.defaultCacheTiming;
    };
    CacheService.ctorParameters = function () { return [
        { type: LogService },
        { type: StringUtils },
        { type: FunctionsUtils },
        { type: undefined, decorators: [{ type: Inject, args: [EVENT_SERVICE,] }] },
        { type: CacheEngine }
    ]; };
    CacheService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(3, Inject(EVENT_SERVICE)),
        tslib_1.__metadata("design:paramtypes", [LogService,
            StringUtils,
            FunctionsUtils, Object, CacheEngine])
    ], CacheService);
    return CacheService;
}());
export { CacheService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2NhY2hlL2NhY2hlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRztBQUNILE9BQU8sS0FBSyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5ELE9BQU8sRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc1QyxPQUFPLEVBQUUsV0FBVyxFQUFFLGtCQUFrQixFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWhHLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQVVoRDs7Ozs7O0dBTUc7QUFFSDtJQU1JLHNCQUNZLFVBQXNCLEVBQ3RCLFdBQXdCLEVBQ3hCLGNBQThCLEVBQ1AsWUFBMkIsRUFDbEQsV0FBd0I7UUFKeEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDUCxpQkFBWSxHQUFaLFlBQVksQ0FBZTtRQUNsRCxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQVY1Qix1QkFBa0IsR0FBeUIsRUFBRSxDQUFDO1FBQzlDLG1CQUFjLEdBQWEsRUFBRSxDQUFDO1FBRTlCLHVCQUFrQixHQUFHLElBQUksa0JBQWtCLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBUTNGLENBQUM7SUFFSjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O09Bb0NHO0lBQ0ksK0JBQVEsR0FBZixVQUFnQixJQUFxQixFQUFFLFdBQXlCO1FBQzVELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7WUFDNUIsSUFBSSxNQUFBO1lBQ0osV0FBVyxhQUFBO1NBQ2QsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksNkJBQU0sR0FBYixVQUNJLE9BQVksRUFDWixVQUFrQixFQUNsQixjQUE4QyxFQUM5QyxtQkFBMEIsRUFDMUIsWUFBMkIsRUFDM0IsSUFBbUI7UUFFbkIsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRixJQUFNLFlBQVksR0FDZCxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxVQUFVLENBQUM7WUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUVqRCxJQUFNLEtBQUssR0FBMkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakYsSUFBSSxJQUFxQixDQUFDO1FBRTFCLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDUixJQUFNLFdBQVcsR0FHYixLQUFLLElBQUk7Z0JBQ1QsRUFBRSxFQUFFLFlBQVk7Z0JBQ2hCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRTtnQkFDL0IsWUFBWSxFQUFFLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUM7Z0JBQ2xELEtBQUssRUFBRSxJQUFJO2FBQ2QsQ0FBQztZQUVGLElBQU0sV0FBVyxHQUF3QixJQUFJLENBQUMsNkJBQTZCLENBQ3ZFLFlBQVksQ0FDZixDQUFDO1lBQ0YsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7YUFDakU7WUFDRCxJQUFJLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUV2QyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLGNBQWMsQ0FBQyxJQUFJLE9BQW5CLGNBQWMsb0JBQ3RELFNBQVMsR0FDTixLQUFLLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsRUFDNUIsQ0FBQyxDQUFDO1lBRTVCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN0QzthQUFNO1lBQ0gsSUFBSSxHQUFHLEtBQUssQ0FBQztTQUNoQjtRQUVELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSSw0QkFBSyxHQUFaOztRQUFBLGlCQUlDO1FBSlksc0JBQThCO2FBQTlCLFVBQThCLEVBQTlCLHFCQUE4QixFQUE5QixJQUE4QjtZQUE5QixpQ0FBOEI7O1FBQ3ZDLElBQU0sSUFBSSxHQUFhLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNwRSxDQUFBLEtBQUEsSUFBSSxDQUFDLFdBQVcsQ0FBQSxDQUFDLEtBQUssNEJBQUksSUFBSSxHQUFFO1FBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQyxHQUFHLElBQUssT0FBQSxLQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBOUIsQ0FBOEIsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFUyw4Q0FBdUIsR0FBakMsVUFBa0MsSUFBbUI7UUFBckQsaUJBY0M7UUFiRyxJQUFJLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDO2FBQy9CLE1BQU0sQ0FBQyxVQUFDLE9BQU87WUFDWixPQUFPLEtBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQzthQUNELE9BQU8sQ0FBQyxVQUFDLE9BQU87WUFDYixLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxnQ0FBOEIsT0FBUyxDQUFDLENBQUM7WUFDL0QsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEMsS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFVBQUMsR0FBVyxFQUFFLElBQWdCO2dCQUMvRCxLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyw2QkFBMkIsT0FBUyxDQUFDLENBQUM7Z0JBQzVELEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNoQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQVksRUFBRSxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFUyxnREFBeUIsR0FBbkMsVUFBb0MsSUFBbUI7UUFBdkQsaUJBTUM7UUFMRyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3JCLE9BQU8sTUFBTSxDQUFDLEtBQUssT0FBWixNQUFNLG1CQUFVLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxLQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDLEVBQWhDLENBQWdDLENBQUMsR0FBRTtTQUM3RTthQUFNO1lBQ0gsT0FBTyxFQUFFLENBQUM7U0FDYjtJQUNMLENBQUM7SUFFUywrQ0FBd0IsR0FBbEMsVUFBbUMsR0FBZ0I7UUFBbkQsaUJBS0M7UUFKRyxPQUFPLE1BQU0sQ0FBQyxLQUFLLE9BQVosTUFBTSxvQkFDVCxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FDUixDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBQyxJQUFLLE9BQUEsS0FBSSxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQyxFQUFoQyxDQUFnQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUMxRjtJQUNOLENBQUM7SUFFUyxvREFBNkIsR0FBdkMsVUFBd0MsWUFBMkI7UUFDL0QsSUFBTSxTQUFTLEdBQW1DLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQzFFLFVBQUMsb0JBQW9CLElBQUssT0FBQSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQXZDLENBQXVDLENBQ3BFLENBQUM7UUFDRixPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ3ZFLENBQUM7O2dCQXpKdUIsVUFBVTtnQkFDVCxXQUFXO2dCQUNSLGNBQWM7Z0RBQ3JDLE1BQU0sU0FBQyxhQUFhO2dCQUNBLFdBQVc7O0lBWDNCLFlBQVk7UUFEeEIsVUFBVSxFQUFFO1FBV0osbUJBQUEsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFBO2lEQUhGLFVBQVU7WUFDVCxXQUFXO1lBQ1IsY0FBYyxVQUVqQixXQUFXO09BWDNCLFlBQVksQ0FpS3hCO0lBQUQsbUJBQUM7Q0FBQSxBQWpLRCxJQWlLQztTQWpLWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgKiBhcyBsb2Rhc2ggZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ2xvbmVhYmxlIH0gZnJvbSAnLi4vLi4vZHRvcyc7XG5pbXBvcnQgeyBGdW5jdGlvbnNVdGlscywgU3RyaW5nVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2FjaGVBY3Rpb24gfSBmcm9tICcuL2NhY2hlLWFjdGlvbic7XG5pbXBvcnQgeyBFdmljdGlvblRhZyB9IGZyb20gJy4vZXZpY3Rpb24tdGFnJztcbmltcG9ydCB7IENhY2hlRW5naW5lLCBEZWZhdWx0Q2FjaGVUaW1pbmcsIElDYWNoZUl0ZW0sIElDYWNoZVRpbWluZywgSU1ldGFkYXRhIH0gZnJvbSAnLi9lbmdpbmUnO1xuaW1wb3J0IHsgSUV2ZW50U2VydmljZSB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgRVZFTlRfU0VSVklDRSB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5cbmV4cG9ydCB0eXBlIElDYWNoZVByZWRpY2F0ZSA9IChjYWNoZUFjdGlvbnM6IENhY2hlQWN0aW9uW10pID0+IGJvb2xlYW47XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmludGVyZmFjZSBJUHJlZGljYXRlUmVnaXN0cnkge1xuICAgIHRlc3Q6IElDYWNoZVByZWRpY2F0ZTtcbiAgICBjYWNoZVRpbWluZzogSUNhY2hlVGltaW5nO1xufVxuXG4vKipcbiAqIEBuZ2RvYyBzZXJ2aWNlXG4gKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpDYWNoZVNlcnZpY2VcbiAqIEBkZXNjcmlwdGlvblxuICogU2VydmljZSB0byB3aGljaCB0aGUge0BsaW5rIEBzbWFydHV0aWxzLm9iamVjdDpAQ2FjaGVkIEBDYWNoZWR9IGFuZCB7QGxpbmsgQHNtYXJ0dXRpbHMub2JqZWN0OkBJbnZhbGlkYXRlQ2FjaGUgQEludmFsaWRhdGVDYWNoZX0gYW5ub3RhdGlvbnMgZGVsZWdhdGUgdG8gcGVyZm9ybSBzZXJ2aWNlIG1ldGhvZCBsZXZlbCBjYWNoaW5nLlxuICogSXQgaXMgbm90IGhhbmRsZWQgZXhwbGljaXRseSBleGNlcHQgZm9yIGl0cyBldmljdCBtZXRob2QuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDYWNoZVNlcnZpY2Uge1xuICAgIHByaXZhdGUgcHJlZGljYXRlc1JlZ2lzdHJ5OiBJUHJlZGljYXRlUmVnaXN0cnlbXSA9IFtdO1xuICAgIHByaXZhdGUgZXZlbnRMaXN0ZW5lcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBwcml2YXRlIGRlZmF1bHRDYWNoZVRpbWluZyA9IG5ldyBEZWZhdWx0Q2FjaGVUaW1pbmcoMjQgKiA2MCAqIDYwICogMTAwMCwgMTIgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBsb2dTZXJ2aWNlOiBMb2dTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHN0cmluZ1V0aWxzOiBTdHJpbmdVdGlscyxcbiAgICAgICAgcHJpdmF0ZSBmdW5jdGlvbnNVdGlsczogRnVuY3Rpb25zVXRpbHMsXG4gICAgICAgIEBJbmplY3QoRVZFTlRfU0VSVklDRSkgcHJpdmF0ZSBldmVudFNlcnZpY2U6IElFdmVudFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY2FjaGVFbmdpbmU6IENhY2hlRW5naW5lXG4gICAgKSB7fVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkNhY2hlU2VydmljZSNyZWdpc3RlclxuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpDYWNoZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJlZ2lzdGVyIGEgbmV3IHByZWRpY2F0ZSB3aXRoIGl0J3MgYXNzb2NpYXRlZCBjYWNoZVRpbWluZy5cbiAgICAgKiBFYWNoIHRpbWUgdGhlIEBDYWNoZSBhbm5vdGF0aW9uIGlzIGhhbmRsZWQsIHRoZSBDYWNoZVNlcnZpY2UgdHJ5IHRvIGZpbmQgYSBtYXRjaGluZyBjYWNoZVRpbWluZyBmb3IgdGhlIGdpdmVuIGNhY2hlQWN0aW9ucy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SUNhY2hlUHJlZGljYXRlfSB0ZXN0IFRoaXMgZnVuY3Rpb24gdGFrZXMgdGhlIGNhY2hlQWN0aW9ucyB7QGxpbmsgQHNtYXJ0dXRpbHMub2JqZWN0OkNhY2hlQWN0aW9uIENhY2hlQWN0aW9ufSBhcmd1bWVudCwgYW5kIG11c3QgcmV0dXJuIGEgQm9vbGVhbiB0aGF0IGlzIHRydWUgaWYgdGhlIGdpdmVuIGNhY2hlQWN0aW9ucyBtYXRjaCB0aGUgcHJlZGljYXRlLlxuICAgICAqIEBwYXJhbSB7SUNhY2hlVGltaW5nfSBjYWNoZVRpbWluZyBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gY2FsbCBzZXRBZ2UoaXRlbTogSUNhY2hlSXRlbTxhbnk+KSBvbiB0aGUgY2FjaGVkIGl0ZW0uXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtDYWNoZVNlcnZpY2V9IENhY2hlU2VydmljZSBUaGUgQ2FjaGVTZXJ2aWNlIGluc3RhbmNlLlxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBgYGB0c1xuICAgICAqIGV4cG9ydCBjbGFzcyBDdXN0b21DYWNoZVRpbWluZyBpbXBsZW1lbnRzIElDYWNoZVRpbWluZyB7XG4gICAgICogXHRwcml2YXRlIGV4cGlyYXRpb25BZ2U6IG51bWJlcjtcbiAgICAgKiBcdHByaXZhdGUgcmVmcmVzaEFnZTogbnVtYmVyO1xuICAgICAqICBjb25zdHJ1Y3RvcihleHBpcmF0aW9uQWdlOiBudW1iZXIsIHJlZnJlc2hBZ2U6IG51bWJlcikge1xuICAgICAqIFx0XHQvLyBUaGUgY2FjaGVkIHJlc3BvbnNlIGlzIGRpc2NhcmRlZCBpZiBpdCBpcyBvbGRlciB0aGFuIHRoZSBleHBpcmF0aW9uIGFnZS5cbiAgICAgKiBcdFx0dGhpcy5leHBpcmF0aW9uQWdlID0gZXhwaXJhdGlvbkFnZTtcbiAgICAgKiBcdFx0Ly8gbWF4aW11bSBhZ2UgZm9yIHRoZSBjYWNoZWQgcmVzcG9uc2UgdG8gYmUgY29uc2lkZXJlZCBcImZyZXNoLlwiXG4gICAgICogXHRcdHRoaXMucmVmcmVzaEFnZSA9IHJlZnJlc2hBZ2U7XG4gICAgICogXHR9XG4gICAgICogXHRzZXRBZ2UoaXRlbTogSUNhY2hlSXRlbTxhbnk+KTogdm9pZCB7XG4gICAgICogXHRcdGl0ZW0uZXhwaXJhdGlvbkFnZSA9IHRoaXMuZXhwaXJhdGlvbkFnZTtcbiAgICAgKiBcdFx0aXRlbS5yZWZyZXNoQWdlID0gdGhpcy5yZWZyZXNoQWdlO1xuICAgICAqIFx0fVxuICAgICAqIFx0fTtcbiAgICAgKiBcdGNvbnN0IGN1c3RvbUNhY2hlVGltaW5nID0gbmV3IEN1c3RvbUNhY2hlVGltaW5nKDMwICogNjAwMDAsIDE1ICogNjAwMDApO1xuICAgICAqIFx0Y29uc3QgY3VzdG9tQ29udGVudFByZWRpY2F0ZTogSUNhY2hlUHJlZGljYXRlID0gKGNhY2hlQWN0aW9uczogQ2FjaGVBY3Rpb25bXSkgPT4ge1xuICAgICAqIFx0XHRyZXR1cm4gY2FjaGVBY3Rpb25zLmZpbmQoKGNhY2hlQWN0aW9uKSA9PiBjYWNoZUFjdGlvbi5uYW1lID09PSAnQ1VTVE9NX1RBRycpICE9PSBudWxsO1xuICAgICAqIFx0fTtcbiAgICAgKiB0aGlzLnJlZ2lzdGVyKGN1c3RvbUNvbnRlbnRQcmVkaWNhdGUsIGN1c3RvbUNhY2hlVGltaW5nKTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVnaXN0ZXIodGVzdDogSUNhY2hlUHJlZGljYXRlLCBjYWNoZVRpbWluZzogSUNhY2hlVGltaW5nKTogQ2FjaGVTZXJ2aWNlIHtcbiAgICAgICAgdGhpcy5wcmVkaWNhdGVzUmVnaXN0cnkudW5zaGlmdCh7XG4gICAgICAgICAgICB0ZXN0LFxuICAgICAgICAgICAgY2FjaGVUaW1pbmdcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHB1YmxpYyBtZXRob2QgYnV0IG9ubHkgbWVhbnQgdG8gYmUgdXNlZCBieSBAQ2FjaGUgYW5ub3RhdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBoYW5kbGU8VCBleHRlbmRzIElNZXRhZGF0YT4oXG4gICAgICAgIHNlcnZpY2U6IGFueSxcbiAgICAgICAgbWV0aG9kTmFtZTogc3RyaW5nLFxuICAgICAgICBwcmVib3VuZE1ldGhvZDogKC4uLmFyZ3M6IGFueVtdKSA9PiBQcm9taXNlPFQ+LFxuICAgICAgICBpbnZvY2F0aW9uQXJndW1lbnRzOiBhbnlbXSxcbiAgICAgICAgY2FjaGVBY3Rpb25zOiBDYWNoZUFjdGlvbltdLFxuICAgICAgICB0YWdzOiBFdmljdGlvblRhZ1tdXG4gICAgKTogUHJvbWlzZTxUPiB7XG4gICAgICAgIGNvbnN0IGNvbnN0cnVjdG9yTmFtZSA9IHRoaXMuZnVuY3Rpb25zVXRpbHMuZ2V0SW5zdGFuY2VDb25zdHJ1Y3Rvck5hbWUoc2VydmljZSk7XG4gICAgICAgIGNvbnN0IGNhY2hlZEl0ZW1JZDogc3RyaW5nID1cbiAgICAgICAgICAgIHdpbmRvdy5idG9hKGNvbnN0cnVjdG9yTmFtZSArIG1ldGhvZE5hbWUpICtcbiAgICAgICAgICAgIHRoaXMuc3RyaW5nVXRpbHMuZW5jb2RlKGludm9jYXRpb25Bcmd1bWVudHMpO1xuXG4gICAgICAgIGNvbnN0IF9pdGVtOiBJQ2FjaGVJdGVtPGFueT4gfCBudWxsID0gdGhpcy5jYWNoZUVuZ2luZS5nZXRJdGVtQnlJZChjYWNoZWRJdGVtSWQpO1xuICAgICAgICBsZXQgaXRlbTogSUNhY2hlSXRlbTxhbnk+O1xuXG4gICAgICAgIGlmICghX2l0ZW0pIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnRpYWxJdGVtOiBQaWNrPFxuICAgICAgICAgICAgICAgIElDYWNoZUl0ZW08YW55PixcbiAgICAgICAgICAgICAgICAnaWQnIHwgJ3RpbWVzdGFtcCcgfCAnZXZpY3Rpb25UYWdzJyB8ICdjYWNoZSdcbiAgICAgICAgICAgID4gPSBfaXRlbSB8fCB7XG4gICAgICAgICAgICAgICAgaWQ6IGNhY2hlZEl0ZW1JZCxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuICAgICAgICAgICAgICAgIGV2aWN0aW9uVGFnczogdGhpcy5jb2xsZWN0RXZlbnROYW1lc0Zyb21UYWdzKHRhZ3MpLFxuICAgICAgICAgICAgICAgIGNhY2hlOiBudWxsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBjYWNoZVRpbWluZzogSUNhY2hlVGltaW5nIHwgbnVsbCA9IHRoaXMuZmluZENhY2hlVGltaW5nQnlDYWNoZUFjdGlvbnMoXG4gICAgICAgICAgICAgICAgY2FjaGVBY3Rpb25zXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKCFjYWNoZVRpbWluZykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGVTZXJ2aWNlOjpoYW5kbGUgLSBObyBwcmVkaWNhdGUgbWF0Y2guJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpdGVtID0gY2FjaGVUaW1pbmcuc2V0QWdlKHBhcnRpYWxJdGVtKTtcblxuICAgICAgICAgICAgdGhpcy5jYWNoZUVuZ2luZS5hZGRJdGVtKGl0ZW0sIGNhY2hlVGltaW5nLCBwcmVib3VuZE1ldGhvZC5iaW5kKFxuICAgICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAuLi5BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChpbnZvY2F0aW9uQXJndW1lbnRzKVxuICAgICAgICAgICAgKSBhcyAoPEc+KCkgPT4gUHJvbWlzZTxHPikpO1xuXG4gICAgICAgICAgICB0aGlzLmxpc3RlbkZvckV2aWN0aW9uQnlUYWdzKHRhZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXRlbSA9IF9pdGVtO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVFbmdpbmUuaGFuZGxlKGl0ZW0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpDYWNoZVNlcnZpY2UjZXZpY3RcbiAgICAgKiBAbWV0aG9kT2YgIEBzbWFydHV0aWxzLnNlcnZpY2VzOkNhY2hlU2VydmljZVxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFdpbGwgZXZpY3QgdGhlIGVudGlyZSBjYWNoZSBvZiBhbGwgbWV0aG9kcyBvZiBhbGwgc2VydmljZXMgcmVmZXJlbmNpbmcgZWl0aGVyIGRpcmVjdGx5IG9yIGluZGlyZWN0bHkgdGhlIGdpdmVuIHtAbGluayBAc21hcnR1dGlscy5vYmplY3Q6RXZpY3Rpb25UYWcgRXZpY3Rpb25UYWdzfVxuICAgICAqIEBwYXJhbSB7Li4uRXZpY3Rpb25UYWdbXX0gZXZpY3Rpb25UYWdzIHRoZSB7QGxpbmsgQHNtYXJ0dXRpbHMub2JqZWN0OkV2aWN0aW9uVGFnIEV2aWN0aW9uVGFnc31cbiAgICAgKi9cbiAgICBwdWJsaWMgZXZpY3QoLi4uZXZpY3Rpb25UYWdzOiBFdmljdGlvblRhZ1tdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHRhZ3M6IHN0cmluZ1tdID0gdGhpcy5jb2xsZWN0RXZlbnROYW1lc0Zyb21UYWdzKGV2aWN0aW9uVGFncyk7XG4gICAgICAgIHRoaXMuY2FjaGVFbmdpbmUuZXZpY3QoLi4udGFncyk7XG4gICAgICAgIHRhZ3MuZm9yRWFjaCgodGFnKSA9PiB0aGlzLmV2ZW50U2VydmljZS5wdWJsaXNoKHRhZykpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBsaXN0ZW5Gb3JFdmljdGlvbkJ5VGFncyh0YWdzOiBFdmljdGlvblRhZ1tdKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY29sbGVjdEV2ZW50TmFtZXNGcm9tVGFncyh0YWdzKVxuICAgICAgICAgICAgLmZpbHRlcigoZXZlbnRJZCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50TGlzdGVuZXJzLmluZGV4T2YoZXZlbnRJZCkgPT09IC0xO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5mb3JFYWNoKChldmVudElkKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmRlYnVnKGByZWdpc3RlcmluZyBldmVudCBsaXN0ZW5lciAke2V2ZW50SWR9YCk7XG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycy5wdXNoKGV2ZW50SWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRTZXJ2aWNlLnN1YnNjcmliZShldmVudElkLCAoZXZ0OiBzdHJpbmcsIGRhdGE/OiBDbG9uZWFibGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmRlYnVnKGBjbGVhbmluZyBjYWNoZSBvbiBldmVudCAke2V2ZW50SWR9YCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVFbmdpbmUuZXZpY3QoZXZlbnRJZCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmU8Q2xvbmVhYmxlPih7fSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY29sbGVjdEV2ZW50TmFtZXNGcm9tVGFncyh0YWdzOiBFdmljdGlvblRhZ1tdKTogc3RyaW5nW10ge1xuICAgICAgICBpZiAodGFncyAmJiB0YWdzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIGxvZGFzaC51bmlvbiguLi50YWdzLm1hcCgodCkgPT4gdGhpcy5jb2xsZWN0RXZlbnROYW1lc0Zyb21UYWcodCkpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBjb2xsZWN0RXZlbnROYW1lc0Zyb21UYWcodGFnOiBFdmljdGlvblRhZyk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIGxvZGFzaC51bmlvbihcbiAgICAgICAgICAgIFt0YWcuZXZlbnRdLFxuICAgICAgICAgICAgLi4uKHRhZy5yZWxhdGVkVGFncyA/IHRhZy5yZWxhdGVkVGFncy5tYXAoKHQpID0+IHRoaXMuY29sbGVjdEV2ZW50TmFtZXNGcm9tVGFnKHQpKSA6IFtdKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBmaW5kQ2FjaGVUaW1pbmdCeUNhY2hlQWN0aW9ucyhjYWNoZUFjdGlvbnM6IENhY2hlQWN0aW9uW10pOiBJQ2FjaGVUaW1pbmcgfCBudWxsIHtcbiAgICAgICAgY29uc3QgcHJlZGljYXRlOiBJUHJlZGljYXRlUmVnaXN0cnkgfCB1bmRlZmluZWQgPSB0aGlzLnByZWRpY2F0ZXNSZWdpc3RyeS5maW5kKFxuICAgICAgICAgICAgKGNhY2hlVGltaW5nUHJlZGljYXRlKSA9PiBjYWNoZVRpbWluZ1ByZWRpY2F0ZS50ZXN0KGNhY2hlQWN0aW9ucylcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHByZWRpY2F0ZSA/IHByZWRpY2F0ZS5jYWNoZVRpbWluZyA6IHRoaXMuZGVmYXVsdENhY2hlVGltaW5nO1xuICAgIH1cbn1cbiJdfQ==