/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
import { TranslateService } from '@ngx-translate/core';
import { Inject, Injectable, Injector } from '@angular/core';
import { EVENT_SERVICE, LANGUAGE_SERVICE_CONSTANTS, SELECTED_LANGUAGE, SWITCH_LANGUAGE_EVENT } from '../constants';
import { IEventService, ILanguageServiceConstants, IStorageService } from '../interfaces';
import { BrowserService } from './browser';
import { rarelyChangingContent, Cached } from './cache';
import { LogService } from './log.service';
import { RestServiceFactory } from './rest';
import { PromiseUtils } from '../utils';
/**
 * @ngdoc object
 * @name resourceLocationsModule.object:LANGUAGE_RESOURCE_URI
 *
 * @description
 * Resource URI of the languages REST service.
 */
/**
 * @ngdoc service
 * @name @smartutils.services:LanguageService
 */
let LanguageService = class LanguageService {
    constructor(logService, translateService, promiseUtils, eventService, browserService, storageService, injector, languageServiceConstants) {
        this.logService = logService;
        this.translateService = translateService;
        this.promiseUtils = promiseUtils;
        this.eventService = eventService;
        this.browserService = browserService;
        this.storageService = storageService;
        this.injector = injector;
        this.languageServiceConstants = languageServiceConstants;
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getBrowserLanguageIsoCode
     * @methodOf @smartutils.services:LanguageService
     *
     * @deprecated since 1808
     *
     * @description
     * Uses the browser's current locale to determine the selected language ISO code.
     *
     * @returns {String} The language ISO code of the browser's currently selected locale.
     */
    getBrowserLanguageIsoCode() {
        return window.navigator.language.split('-')[0];
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getBrowserLocale
     * @methodOf @smartutils.services:LanguageService
     *
     * @deprecated since 1808 - use browserService instead.
     *
     * @description
     * determines the browser locale in the format en_US
     *
     * @returns {string} the browser locale
     */
    getBrowserLocale() {
        return this.browserService.getBrowserLocale();
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getResolveLocale
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Resolve the user preference tooling locale. It determines in the
     * following order:
     *
     * 1. Check if the user has previously selected the language
     * 2. Check if the user browser locale is supported in the system
     *
     * @returns {Promise<string>} the locale
     */
    getResolveLocale() {
        return this._getDefaultLanguage();
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getResolveLocaleIsoCode
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Resolve the user preference tooling locale ISO code. i.e.: If the selected tooling language is 'en_US',
     * the resolved value will be 'en'.
     *
     * @returns {Promise<string>} A promise that resolves to the isocode of the tooling language.
     */
    getResolveLocaleIsoCode() {
        return this.getResolveLocale().then((resolveLocale) => {
            return this.convertBCP47TagToJavaTag(resolveLocale).split('_')[0];
        });
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#getToolingLanguages
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Retrieves a list of language descriptors using REST calls to the i18n API.
     *
     * @returns {Promise<IToolingLanguage[]>} A promise that resolves to an array of IToolingLanguage.
     */
    getToolingLanguages() {
        return this.i18nLanguageRestService
            .get({})
            .then((response) => {
            return response.languages;
        })
            .catch((error) => {
            this.logService.error('LanguageService.getToolingLanguages() - Error loading tooling languages');
            return Promise.reject(error);
        });
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#setSelectedToolingLanguage
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Set the user preference language in the storage service
     *
     * @param {IToolingLanguage} language the language object to be saved.
     */
    setSelectedToolingLanguage(language) {
        this.storageService.setValueInLocalStorage(SELECTED_LANGUAGE, language, false);
        this.translateService.use(language.isoCode);
        this.setApplicationTitle();
        this.eventService.publish(SWITCH_LANGUAGE_EVENT, {
            isoCode: language.isoCode
        });
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#registerSwitchLanguage
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Register a callback function to the gateway in order to switch the tooling language
     */
    registerSwitchLanguage() {
        this.eventService.subscribe(SWITCH_LANGUAGE_EVENT, (eventId, language) => {
            if (this.translateService.currentLang !== language.isoCode) {
                this.translateService.use(language.isoCode);
            }
        });
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#convertBCP47TagToJavaTag
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Method converts the BCP47 language tag representing the locale to the default java representation.
     * For example, method converts "en-US" to "en_US".
     *
     * @param {string} languageTag the language tag to be converted.
     *
     * @returns {string} the languageTag in java representation
     */
    convertBCP47TagToJavaTag(languageTag) {
        return !!languageTag ? languageTag.replace(/-/g, '_') : languageTag;
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:LanguageService#convertJavaTagToBCP47Tag
     * @methodOf @smartutils.services:LanguageService
     *
     * @description
     * Method converts the default java language tag representing the locale to the BCP47 representation.
     * For example, method converts "en_US" to "en-US".
     *
     * @param {string} languageTag the language tag to be converted.
     *
     * @returns {string} the languageTag in BCP47 representation
     */
    convertJavaTagToBCP47Tag(languageTag) {
        return !!languageTag ? languageTag.replace(/_/g, '-') : languageTag;
    }
    _getDefaultLanguage() {
        return this.storageService.getValueFromLocalStorage(SELECTED_LANGUAGE, false).then((lang) => {
            return lang ? lang.isoCode : this.browserService.getBrowserLocale();
        }, () => {
            return this.browserService.getBrowserLocale();
        });
    }
    setApplicationTitle() {
        this.translateService.get('se.application.name').subscribe((pageTitle) => {
            document.title = pageTitle;
        });
    }
    get i18nLanguageRestService() {
        return this.injector
            .get(RestServiceFactory)
            .get(this.languageServiceConstants.I18N_LANGUAGES_RESOURCE_URI);
    }
};
LanguageService.ctorParameters = () => [
    { type: LogService },
    { type: TranslateService },
    { type: PromiseUtils },
    { type: undefined, decorators: [{ type: Inject, args: [EVENT_SERVICE,] }] },
    { type: BrowserService },
    { type: IStorageService },
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [LANGUAGE_SERVICE_CONSTANTS,] }] }
];
tslib_1.__decorate([
    Cached({ actions: [rarelyChangingContent] }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", Promise)
], LanguageService.prototype, "getToolingLanguages", null);
LanguageService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(3, Inject(EVENT_SERVICE)),
    tslib_1.__param(7, Inject(LANGUAGE_SERVICE_CONSTANTS)),
    tslib_1.__metadata("design:paramtypes", [LogService,
        TranslateService,
        PromiseUtils, Object, BrowserService,
        IStorageService,
        Injector, Object])
], LanguageService);
export { LanguageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2xhbmd1YWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQ0gsYUFBYSxFQUNiLDBCQUEwQixFQUMxQixpQkFBaUIsRUFDakIscUJBQXFCLEVBQ3hCLE1BQU0sY0FBYyxDQUFDO0FBRXRCLE9BQU8sRUFBRSxhQUFhLEVBQUUseUJBQXlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDM0MsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBcUMsa0JBQWtCLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQXFCeEM7Ozs7OztHQU1HO0FBRUg7OztHQUdHO0FBR0gsSUFBYSxlQUFlLEdBQTVCLE1BQWEsZUFBZTtJQUN4QixZQUNjLFVBQXNCLEVBQ3RCLGdCQUFrQyxFQUNsQyxZQUEwQixFQUNILFlBQTJCLEVBQ2xELGNBQThCLEVBQzlCLGNBQStCLEVBQy9CLFFBQWtCLEVBRWxCLHdCQUFtRDtRQVJuRCxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDSCxpQkFBWSxHQUFaLFlBQVksQ0FBZTtRQUNs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QUFlO0lBRDNCLFVBQVUsRUFBRTtJQU1KLG1CQUFBLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUlyQixtQkFBQSxNQUFNLENBQUMsMEJBQTBCLENBQUMsQ0FBQTs2Q0FQYixVQUFVO1FBQ0osZ0JBQWdCO1FBQ3BCLFlBQVksVUFFVixjQUFjO1FBQ2QsZUFBZTtRQUNyQixRQUFRO0dBUnZCLGVBQWUsQ0F5TTNCO1NBek1ZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxOSBTQVAgU0Ugb3IgYW4gU0FQIGFmZmlsaWF0ZSBjb21wYW55LiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogQG1vZHVsZSBzbWFydHV0aWxzXG4gKi9cblxuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBFVkVOVF9TRVJWSUNFLFxuICAgIExBTkdVQUdFX1NFUlZJQ0VfQ09OU1RBTlRTLFxuICAgIFNFTEVDVEVEX0xBTkdVQUdFLFxuICAgIFNXSVRDSF9MQU5HVUFHRV9FVkVOVFxufSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgUGF5bG9hZCB9IGZyb20gJy4uL2R0b3MnO1xuaW1wb3J0IHsgSUV2ZW50U2VydmljZSwgSUxhbmd1YWdlU2VydmljZUNvbnN0YW50cywgSVN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBCcm93c2VyU2VydmljZSB9IGZyb20gJy4vYnJvd3Nlcic7XG5pbXBvcnQgeyByYXJlbHlDaGFuZ2luZ0NvbnRlbnQsIENhY2hlZCB9IGZyb20gJy4vY2FjaGUnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJy4vbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgSVJlc3RTZXJ2aWNlLCBJUmVzdFNlcnZpY2VGYWN0b3J5LCBSZXN0U2VydmljZUZhY3RvcnkgfSBmcm9tICcuL3Jlc3QnO1xuaW1wb3J0IHsgUHJvbWlzZVV0aWxzIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vKipcbiAqIEBuZ2RvYyBpbnRlcmZhY2VcbiAqIEBuYW1lIEBzbWFydHV0aWxzLmludGVyZmFjZXM6SUxhbmd1YWdlXG4gKiBAZGVzY3JpcHRpb25cbiAqIEludGVyZmFjZSBmb3IgbGFuZ3VhZ2UgaW5mb3JtYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJTGFuZ3VhZ2UgZXh0ZW5kcyBQYXlsb2FkIHtcbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgaXNvY29kZTogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBuYXRpdmVOYW1lOiBzdHJpbmc7XG4gICAgcmVxdWlyZWQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVRvb2xpbmdMYW5ndWFnZSBleHRlbmRzIFBheWxvYWQge1xuICAgIGlzb0NvZGU6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG59XG5cbi8qKlxuICogQG5nZG9jIG9iamVjdFxuICogQG5hbWUgcmVzb3VyY2VMb2NhdGlvbnNNb2R1bGUub2JqZWN0OkxBTkdVQUdFX1JFU09VUkNFX1VSSVxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogUmVzb3VyY2UgVVJJIG9mIHRoZSBsYW5ndWFnZXMgUkVTVCBzZXJ2aWNlLlxuICovXG5cbi8qKlxuICogQG5nZG9jIHNlcnZpY2VcbiAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICovXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMYW5ndWFnZVNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgbG9nU2VydmljZTogTG9nU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBwcm9taXNlVXRpbHM6IFByb21pc2VVdGlscyxcbiAgICAgICAgQEluamVjdChFVkVOVF9TRVJWSUNFKSBwcm90ZWN0ZWQgZXZlbnRTZXJ2aWNlOiBJRXZlbnRTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgYnJvd3NlclNlcnZpY2U6IEJyb3dzZXJTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgc3RvcmFnZVNlcnZpY2U6IElTdG9yYWdlU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3RvcixcbiAgICAgICAgQEluamVjdChMQU5HVUFHRV9TRVJWSUNFX0NPTlNUQU5UUylcbiAgICAgICAgcHJvdGVjdGVkIGxhbmd1YWdlU2VydmljZUNvbnN0YW50czogSUxhbmd1YWdlU2VydmljZUNvbnN0YW50c1xuICAgICkge31cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2UjZ2V0QnJvd3Nlckxhbmd1YWdlSXNvQ29kZVxuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXByZWNhdGVkIHNpbmNlIDE4MDhcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFVzZXMgdGhlIGJyb3dzZXIncyBjdXJyZW50IGxvY2FsZSB0byBkZXRlcm1pbmUgdGhlIHNlbGVjdGVkIGxhbmd1YWdlIElTTyBjb2RlLlxuICAgICAqXG4gICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIGxhbmd1YWdlIElTTyBjb2RlIG9mIHRoZSBicm93c2VyJ3MgY3VycmVudGx5IHNlbGVjdGVkIGxvY2FsZS5cbiAgICAgKi9cbiAgICBnZXRCcm93c2VyTGFuZ3VhZ2VJc29Db2RlKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB3aW5kb3cubmF2aWdhdG9yLmxhbmd1YWdlLnNwbGl0KCctJylbMF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNnZXRCcm93c2VyTG9jYWxlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlcHJlY2F0ZWQgc2luY2UgMTgwOCAtIHVzZSBicm93c2VyU2VydmljZSBpbnN0ZWFkLlxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogZGV0ZXJtaW5lcyB0aGUgYnJvd3NlciBsb2NhbGUgaW4gdGhlIGZvcm1hdCBlbl9VU1xuICAgICAqXG4gICAgICogQHJldHVybnMge3N0cmluZ30gdGhlIGJyb3dzZXIgbG9jYWxlXG4gICAgICovXG4gICAgZ2V0QnJvd3NlckxvY2FsZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5icm93c2VyU2VydmljZS5nZXRCcm93c2VyTG9jYWxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNnZXRSZXNvbHZlTG9jYWxlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmVzb2x2ZSB0aGUgdXNlciBwcmVmZXJlbmNlIHRvb2xpbmcgbG9jYWxlLiBJdCBkZXRlcm1pbmVzIGluIHRoZVxuICAgICAqIGZvbGxvd2luZyBvcmRlcjpcbiAgICAgKlxuICAgICAqIDEuIENoZWNrIGlmIHRoZSB1c2VyIGhhcyBwcmV2aW91c2x5IHNlbGVjdGVkIHRoZSBsYW5ndWFnZVxuICAgICAqIDIuIENoZWNrIGlmIHRoZSB1c2VyIGJyb3dzZXIgbG9jYWxlIGlzIHN1cHBvcnRlZCBpbiB0aGUgc3lzdGVtXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSB0aGUgbG9jYWxlXG4gICAgICovXG4gICAgZ2V0UmVzb2x2ZUxvY2FsZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0RGVmYXVsdExhbmd1YWdlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZSNnZXRSZXNvbHZlTG9jYWxlSXNvQ29kZVxuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJlc29sdmUgdGhlIHVzZXIgcHJlZmVyZW5jZSB0b29saW5nIGxvY2FsZSBJU08gY29kZS4gaS5lLjogSWYgdGhlIHNlbGVjdGVkIHRvb2xpbmcgbGFuZ3VhZ2UgaXMgJ2VuX1VTJyxcbiAgICAgKiB0aGUgcmVzb2x2ZWQgdmFsdWUgd2lsbCBiZSAnZW4nLlxuICAgICAqXG4gICAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gdGhlIGlzb2NvZGUgb2YgdGhlIHRvb2xpbmcgbGFuZ3VhZ2UuXG4gICAgICovXG4gICAgZ2V0UmVzb2x2ZUxvY2FsZUlzb0NvZGUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVzb2x2ZUxvY2FsZSgpLnRoZW4oKHJlc29sdmVMb2NhbGU6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udmVydEJDUDQ3VGFnVG9KYXZhVGFnKHJlc29sdmVMb2NhbGUpLnNwbGl0KCdfJylbMF07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2UjZ2V0VG9vbGluZ0xhbmd1YWdlc1xuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHJpZXZlcyBhIGxpc3Qgb2YgbGFuZ3VhZ2UgZGVzY3JpcHRvcnMgdXNpbmcgUkVTVCBjYWxscyB0byB0aGUgaTE4biBBUEkuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxJVG9vbGluZ0xhbmd1YWdlW10+fSBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhbiBhcnJheSBvZiBJVG9vbGluZ0xhbmd1YWdlLlxuICAgICAqL1xuICAgIEBDYWNoZWQoeyBhY3Rpb25zOiBbcmFyZWx5Q2hhbmdpbmdDb250ZW50XSB9KVxuICAgIGdldFRvb2xpbmdMYW5ndWFnZXMoKTogUHJvbWlzZTxJVG9vbGluZ0xhbmd1YWdlW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaTE4bkxhbmd1YWdlUmVzdFNlcnZpY2VcbiAgICAgICAgICAgIC5nZXQoe30pXG4gICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UhLmxhbmd1YWdlcztcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuZXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICdMYW5ndWFnZVNlcnZpY2UuZ2V0VG9vbGluZ0xhbmd1YWdlcygpIC0gRXJyb3IgbG9hZGluZyB0b29saW5nIGxhbmd1YWdlcydcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlI3NldFNlbGVjdGVkVG9vbGluZ0xhbmd1YWdlXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogU2V0IHRoZSB1c2VyIHByZWZlcmVuY2UgbGFuZ3VhZ2UgaW4gdGhlIHN0b3JhZ2Ugc2VydmljZVxuICAgICAqXG4gICAgICogQHBhcmFtIHtJVG9vbGluZ0xhbmd1YWdlfSBsYW5ndWFnZSB0aGUgbGFuZ3VhZ2Ugb2JqZWN0IHRvIGJlIHNhdmVkLlxuICAgICAqL1xuICAgIHNldFNlbGVjdGVkVG9vbGluZ0xhbmd1YWdlKGxhbmd1YWdlOiBJVG9vbGluZ0xhbmd1YWdlKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3RvcmFnZVNlcnZpY2Uuc2V0VmFsdWVJbkxvY2FsU3RvcmFnZShTRUxFQ1RFRF9MQU5HVUFHRSwgbGFuZ3VhZ2UsIGZhbHNlKTtcbiAgICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLnVzZShsYW5ndWFnZS5pc29Db2RlKTtcbiAgICAgICAgdGhpcy5zZXRBcHBsaWNhdGlvblRpdGxlKCk7XG4gICAgICAgIHRoaXMuZXZlbnRTZXJ2aWNlLnB1Ymxpc2goU1dJVENIX0xBTkdVQUdFX0VWRU5ULCB7XG4gICAgICAgICAgICBpc29Db2RlOiBsYW5ndWFnZS5pc29Db2RlXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2UjcmVnaXN0ZXJTd2l0Y2hMYW5ndWFnZVxuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJlZ2lzdGVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gdG8gdGhlIGdhdGV3YXkgaW4gb3JkZXIgdG8gc3dpdGNoIHRoZSB0b29saW5nIGxhbmd1YWdlXG4gICAgICovXG4gICAgcmVnaXN0ZXJTd2l0Y2hMYW5ndWFnZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ldmVudFNlcnZpY2Uuc3Vic2NyaWJlPElUb29saW5nTGFuZ3VhZ2U+KFxuICAgICAgICAgICAgU1dJVENIX0xBTkdVQUdFX0VWRU5ULFxuICAgICAgICAgICAgKGV2ZW50SWQ6IHN0cmluZywgbGFuZ3VhZ2U/OiBJVG9vbGluZ0xhbmd1YWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhbnNsYXRlU2VydmljZS5jdXJyZW50TGFuZyAhPT0gbGFuZ3VhZ2UhLmlzb0NvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLnVzZShsYW5ndWFnZSEuaXNvQ29kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBuZ2RvYyBtZXRob2RcbiAgICAgKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2UjY29udmVydEJDUDQ3VGFnVG9KYXZhVGFnXG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLnNlcnZpY2VzOkxhbmd1YWdlU2VydmljZVxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogTWV0aG9kIGNvbnZlcnRzIHRoZSBCQ1A0NyBsYW5ndWFnZSB0YWcgcmVwcmVzZW50aW5nIHRoZSBsb2NhbGUgdG8gdGhlIGRlZmF1bHQgamF2YSByZXByZXNlbnRhdGlvbi5cbiAgICAgKiBGb3IgZXhhbXBsZSwgbWV0aG9kIGNvbnZlcnRzIFwiZW4tVVNcIiB0byBcImVuX1VTXCIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZ3VhZ2VUYWcgdGhlIGxhbmd1YWdlIHRhZyB0byBiZSBjb252ZXJ0ZWQuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSB0aGUgbGFuZ3VhZ2VUYWcgaW4gamF2YSByZXByZXNlbnRhdGlvblxuICAgICAqL1xuICAgIGNvbnZlcnRCQ1A0N1RhZ1RvSmF2YVRhZyhsYW5ndWFnZVRhZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuICEhbGFuZ3VhZ2VUYWcgPyBsYW5ndWFnZVRhZy5yZXBsYWNlKC8tL2csICdfJykgOiBsYW5ndWFnZVRhZztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuc2VydmljZXM6TGFuZ3VhZ2VTZXJ2aWNlI2NvbnZlcnRKYXZhVGFnVG9CQ1A0N1RhZ1xuICAgICAqIEBtZXRob2RPZiBAc21hcnR1dGlscy5zZXJ2aWNlczpMYW5ndWFnZVNlcnZpY2VcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIE1ldGhvZCBjb252ZXJ0cyB0aGUgZGVmYXVsdCBqYXZhIGxhbmd1YWdlIHRhZyByZXByZXNlbnRpbmcgdGhlIGxvY2FsZSB0byB0aGUgQkNQNDcgcmVwcmVzZW50YXRpb24uXG4gICAgICogRm9yIGV4YW1wbGUsIG1ldGhvZCBjb252ZXJ0cyBcImVuX1VTXCIgdG8gXCJlbi1VU1wiLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGxhbmd1YWdlVGFnIHRoZSBsYW5ndWFnZSB0YWcgdG8gYmUgY29udmVydGVkLlxuICAgICAqXG4gICAgICogQHJldHVybnMge3N0cmluZ30gdGhlIGxhbmd1YWdlVGFnIGluIEJDUDQ3IHJlcHJlc2VudGF0aW9uXG4gICAgICovXG4gICAgY29udmVydEphdmFUYWdUb0JDUDQ3VGFnKGxhbmd1YWdlVGFnOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gISFsYW5ndWFnZVRhZyA/IGxhbmd1YWdlVGFnLnJlcGxhY2UoL18vZywgJy0nKSA6IGxhbmd1YWdlVGFnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBfZ2V0RGVmYXVsdExhbmd1YWdlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlRnJvbUxvY2FsU3RvcmFnZShTRUxFQ1RFRF9MQU5HVUFHRSwgZmFsc2UpLnRoZW4oXG4gICAgICAgICAgICAobGFuZzogeyBuYW1lOiBzdHJpbmc7IGlzb0NvZGU6IHN0cmluZyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxhbmcgPyBsYW5nLmlzb0NvZGUgOiB0aGlzLmJyb3dzZXJTZXJ2aWNlLmdldEJyb3dzZXJMb2NhbGUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnJvd3NlclNlcnZpY2UuZ2V0QnJvd3NlckxvY2FsZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXRBcHBsaWNhdGlvblRpdGxlKCkge1xuICAgICAgICB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuZ2V0KCdzZS5hcHBsaWNhdGlvbi5uYW1lJykuc3Vic2NyaWJlKChwYWdlVGl0bGU6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXQgaTE4bkxhbmd1YWdlUmVzdFNlcnZpY2UoKTogSVJlc3RTZXJ2aWNlPHsgbGFuZ3VhZ2VzOiBJVG9vbGluZ0xhbmd1YWdlW10gfT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pbmplY3RvclxuICAgICAgICAgICAgLmdldDxJUmVzdFNlcnZpY2VGYWN0b3J5PihSZXN0U2VydmljZUZhY3RvcnkpXG4gICAgICAgICAgICAuZ2V0PHsgbGFuZ3VhZ2VzOiBJVG9vbGluZ0xhbmd1YWdlW10gfT4oXG4gICAgICAgICAgICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2VDb25zdGFudHMuSTE4Tl9MQU5HVUFHRVNfUkVTT1VSQ0VfVVJJXG4gICAgICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==