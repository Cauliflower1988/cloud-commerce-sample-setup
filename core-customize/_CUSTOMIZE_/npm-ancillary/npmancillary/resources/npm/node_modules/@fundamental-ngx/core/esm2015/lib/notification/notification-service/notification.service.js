/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NotificationComponent } from '../notification/notification.component';
import { NotificationContainer } from '../notification-utils/notification-container';
import { NotificationConfig } from '../notification-utils/notification-config';
import { NotificationRef } from '../notification-utils/notification-ref';
import { DynamicComponentService } from '../../utils/dynamic-component/dynamic-component.service';
import { NotificationGroupComponent } from '../notification-group/notification-group.component';
export class NotificationService {
    /**
     * @param {?} dynamicComponentService
     */
    constructor(dynamicComponentService) {
        this.dynamicComponentService = dynamicComponentService;
        this.notifications = [];
    }
    /**
     * Opens an alert component with a content of type TemplateRef, Component Type or Configuration Object
     * @param {?} content Content of the alert component, or NotificationDefault object.
     * @param {?=} notificationConfig Configuration of the notification component.
     * @param {?=} notificationGroup Configuration of the notification component.
     * @return {?}
     */
    open(content, notificationConfig = new NotificationConfig(), notificationGroup) {
        // Reassigning Object And Service
        /** @type {?} */
        const notificationService = new NotificationRef();
        notificationConfig = Object.assign(new NotificationConfig(), notificationConfig);
        notificationService.data = notificationConfig.data;
        if (notificationService.data) {
            notificationService.data.type = notificationConfig.type;
        }
        // Create Container if it doesn't exist
        if (!this.containerRef) {
            this.containerRef = this.dynamicComponentService.createDynamicComponent(content, NotificationContainer, notificationConfig);
        }
        // Pass Container reference to config
        notificationConfig.container = this.containerRef.location.nativeElement;
        /** @type {?} */
        let notificationComponentRef;
        if (notificationGroup) {
            // If there is group Pass group reference as a container
            notificationConfig.container = notificationGroup.location.nativeElement;
            // Create Notification Component
            notificationComponentRef = this.dynamicComponentService.createDynamicComponent(content, NotificationComponent, notificationConfig, [notificationService]);
            // Add To array
            this.notifications.push({
                notificationComponent: notificationComponentRef,
                notificationGroup: notificationGroup
            });
        }
        else {
            // Create Notification Component
            notificationComponentRef = this.dynamicComponentService.createDynamicComponent(content, NotificationComponent, notificationConfig, [notificationService]);
            // Add To array
            this.notifications.push({
                notificationComponent: notificationComponentRef,
            });
        }
        /** @type {?} */
        const defaultBehaviourOnClose = (/**
         * @return {?}
         */
        () => {
            this.destroyNotificationComponent(notificationComponentRef);
            refSub.unsubscribe();
            refGroupSub.unsubscribe();
        });
        /** @type {?} */
        const defaultBehaviourOnGroupClose = (/**
         * @return {?}
         */
        () => {
            this.destroyWholeGroup(notificationComponentRef);
            refGroupSub.unsubscribe();
            refSub.unsubscribe();
        });
        /** @type {?} */
        const refSub = notificationService.afterClosed
            .subscribe(defaultBehaviourOnClose, defaultBehaviourOnClose);
        /** @type {?} */
        const refGroupSub = notificationService.afterClosedGroup
            .subscribe(defaultBehaviourOnGroupClose, defaultBehaviourOnGroupClose);
        return notificationService;
    }
    /**
     * Method to remove all of notifications from this service instance
     * @return {?}
     */
    destroyAll() {
        this.notifications.forEach((/**
         * @param {?} notification
         * @return {?}
         */
        notification => {
            this.destroyNotificationComponent(notification.notificationComponent);
        }));
    }
    /**
     * Method that informs if there is any notification opened in this service instance
     * @return {?}
     */
    isAnyOpened() {
        return this.notifications && this.notifications.length > 0;
    }
    /**
     * Method to create Notification Group
     * @param {?=} notificationConfig
     * @return {?}
     */
    createNotificationGroup(notificationConfig = new NotificationConfig()) {
        // Reassign Config Object
        notificationConfig = Object.assign(new NotificationConfig(), notificationConfig);
        if (!this.containerRef) {
            // Create Container Component
            this.containerRef = this.dynamicComponentService.createDynamicComponent(null, NotificationContainer, notificationConfig);
        }
        // Pass Container reference as a config container
        notificationConfig.container = this.containerRef.location.nativeElement;
        // Create and return notification Group component reference
        return this.dynamicComponentService.createDynamicComponent(null, NotificationGroupComponent, notificationConfig);
    }
    /**
     * @private
     * @param {?} notification
     * @return {?}
     */
    destroyWholeGroup(notification) {
        // Find Notification Group assigned to this Notification Component
        /** @type {?} */
        const arrayRef = this.notifications.find((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationComponent === notification));
        if (arrayRef.notificationGroup) {
            // Find Any other Components, that are in this group
            /** @type {?} */
            const arrayToDelete = this.notifications
                .filter((/**
             * @param {?} _notification
             * @return {?}
             */
            _notification => _notification.notificationGroup === arrayRef.notificationGroup));
            // Destroy every single component, that are in the group
            arrayToDelete.forEach((/**
             * @param {?} _notification
             * @return {?}
             */
            _notification => this.destroyNotificationComponent(_notification.notificationComponent)));
        }
    }
    /**
     * @private
     * @param {?} notification
     * @return {?}
     */
    destroyNotificationComponent(notification) {
        // Find Notification component in the array.
        /** @type {?} */
        const arrayRef = this.notifications.find((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationComponent === notification));
        /** @type {?} */
        const indexOf = this.notifications.indexOf(arrayRef);
        // Check the amount of component within the group
        /** @type {?} */
        const amountOfComponentsWithThisGroup = this.notifications.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item.notificationGroup && item.notificationGroup === arrayRef.notificationGroup));
        // If it's the only one component that is in the group, remove group component.
        if (amountOfComponentsWithThisGroup.length === 1) {
            this.dynamicComponentService.destroyComponent(arrayRef.notificationGroup);
        }
        // Destroy Component
        this.dynamicComponentService.destroyComponent(arrayRef.notificationComponent);
        // Remove it from Array
        this.notifications[indexOf] = null;
        this.notifications = this.notifications.filter((/**
         * @param {?} item
         * @return {?}
         */
        item => item !== null && item !== undefined));
        // If there is no other notification Components, just remove container.
        if (this.notifications.length === 0) {
            this.dynamicComponentService.destroyComponent(this.containerRef);
            this.containerRef = null;
        }
    }
}
NotificationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NotificationService.ctorParameters = () => [
    { type: DynamicComponentService }
];
if (false) {
    /** @type {?} */
    NotificationService.prototype.notifications;
    /** @type {?} */
    NotificationService.prototype.containerRef;
    /**
     * @type {?}
     * @private
     */
    NotificationService.prototype.dynamicComponentService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZnVuZGFtZW50YWwtbmd4L2NvcmUvIiwic291cmNlcyI6WyJsaWIvbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi1zZXJ2aWNlL25vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDNUUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDL0UsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sOENBQThDLENBQUM7QUFDckYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHlEQUF5RCxDQUFDO0FBQ2xHLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG9EQUFvRCxDQUFDO0FBSWhHLE1BQU0sT0FBTyxtQkFBbUI7Ozs7SUFTNUIsWUFDWSx1QkFBZ0Q7UUFBaEQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQVJyRCxrQkFBYSxHQUdkLEVBQUUsQ0FBQztJQU1OLENBQUM7Ozs7Ozs7O0lBUUcsSUFBSSxDQUNQLE9BQTJELEVBQzNELHFCQUF5QyxJQUFJLGtCQUFrQixFQUFFLEVBQ2pFLGlCQUE0RDs7O2NBSXRELG1CQUFtQixHQUFvQixJQUFJLGVBQWUsRUFBRTtRQUNsRSxrQkFBa0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksa0JBQWtCLEVBQUUsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBQ2pGLG1CQUFtQixDQUFDLElBQUksR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7UUFDbkQsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7WUFDMUIsbUJBQW1CLENBQUMs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R0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU07Ozs7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUNyRSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixLQUFLLFFBQVEsQ0FBQyxpQkFBaUIsRUFDbEY7UUFFRCwrRUFBK0U7UUFDL0UsSUFBSSwrQkFBK0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUM3RTtRQUVELG9CQUFvQjtRQUNwQixJQUFJLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFFOUUsdUJBQXVCO1FBQ3ZCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNOzs7O1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEtBQUssSUFBSSxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUMsQ0FBQztRQUU1Rix1RUFBdUU7UUFDdkUsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDakMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNqRSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUM1QjtJQUVMLENBQUM7OztZQXRMSixVQUFVOzs7O1lBSkYsdUJBQXVCOzs7O0lBTzVCLDRDQUdTOztJQUNULDJDQUF5RDs7Ozs7SUFJckQsc0RBQXdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29tcG9uZW50IH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29udGFpbmVyIH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uLXV0aWxzL25vdGlmaWNhdGlvbi1jb250YWluZXInO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29uZmlnIH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uLXV0aWxzL25vdGlmaWNhdGlvbi1jb25maWcnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uUmVmIH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uLXV0aWxzL25vdGlmaWNhdGlvbi1yZWYnO1xuaW1wb3J0IHsgRHluYW1pY0NvbXBvbmVudFNlcnZpY2UgfSBmcm9tICcuLi8uLi91dGlscy9keW5hbWljLWNvbXBvbmVudC9keW5hbWljLWNvbXBvbmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkdyb3VwQ29tcG9uZW50IH0gZnJvbSAnLi4vbm90aWZpY2F0aW9uLWdyb3VwL25vdGlmaWNhdGlvbi1ncm91cC5jb21wb25lbnQnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uRGVmYXVsdCB9IGZyb20gJy4uL25vdGlmaWNhdGlvbi11dGlscy9ub3RpZmljYXRpb24tZGVmYXVsdCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcblxuICAgIHB1YmxpYyBub3RpZmljYXRpb25zOiB7XG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbXBvbmVudDogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkNvbXBvbmVudD4sXG4gICAgICAgIG5vdGlmaWNhdGlvbkdyb3VwPzogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkdyb3VwQ29tcG9uZW50PlxuICAgIH1bXSA9IFtdO1xuICAgIHB1YmxpYyBjb250YWluZXJSZWY6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db250YWluZXI+O1xuXG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBkeW5hbWljQ29tcG9uZW50U2VydmljZTogRHluYW1pY0NvbXBvbmVudFNlcnZpY2VcbiAgICApIHt9XG5cbiAgICAvKipcbiAgICAgKiBPcGVucyBhbiBhbGVydCBjb21wb25lbnQgd2l0aCBhIGNvbnRlbnQgb2YgdHlwZSBUZW1wbGF0ZVJlZiwgQ29tcG9uZW50IFR5cGUgb3IgQ29uZmlndXJhdGlvbiBPYmplY3RcbiAgICAgKiBAcGFyYW0gY29udGVudCBDb250ZW50IG9mIHRoZSBhbGVydCBjb21wb25lbnQsIG9yIE5vdGlmaWNhdGlvbkRlZmF1bHQgb2JqZWN0LlxuICAgICAqIEBwYXJhbSBub3RpZmljYXRpb25Db25maWcgQ29uZmlndXJhdGlvbiBvZiB0aGUgbm90aWZpY2F0aW9uIGNvbXBvbmVudC5cbiAgICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uR3JvdXAgQ29uZmlndXJhdGlvbiBvZiB0aGUgbm90aWZpY2F0aW9uIGNvbXBvbmVudC5cbiAgICAgKi9cbiAgICBwdWJsaWMgb3BlbihcbiAgICAgICAgY29udGVudDogVGVtcGxhdGVSZWY8YW55PiB8IFR5cGU8YW55PiB8IE5vdGlmaWNhdGlvbkRlZmF1bHQsXG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZzogTm90aWZpY2F0aW9uQ29uZmlnID0gbmV3IE5vdGlmaWNhdGlvbkNvbmZpZygpLFxuICAgICAgICBub3RpZmljYXRpb25Hcm91cD86IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudD5cbiAgICApOiBOb3RpZmljYXRpb25SZWYge1xuXG4gICAgICAgIC8vIFJlYXNzaWduaW5nIE9iamVjdCBBbmQgU2VydmljZVxuICAgICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlOiBOb3RpZmljYXRpb25SZWYgPSBuZXcgTm90aWZpY2F0aW9uUmVmKCk7XG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZyA9IE9iamVjdC5hc3NpZ24obmV3IE5vdGlmaWNhdGlvbkNvbmZpZygpLCBub3RpZmljYXRpb25Db25maWcpO1xuICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLmRhdGEgPSBub3RpZmljYXRpb25Db25maWcuZGF0YTtcbiAgICAgICAgaWYgKG5vdGlmaWNhdGlvblNlcnZpY2UuZGF0YSkge1xuICAgICAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5kYXRhLnR5cGUgPSBub3RpZmljYXRpb25Db25maWcudHlwZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBDb250YWluZXIgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyUmVmKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclJlZiA9IHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuY3JlYXRlRHluYW1pY0NvbXBvbmVudChjb250ZW50LCBOb3RpZmljYXRpb25Db250YWluZXIsIG5vdGlmaWNhdGlvbkNvbmZpZyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXNzIENvbnRhaW5lciByZWZlcmVuY2UgdG8gY29uZmlnXG4gICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5jb250YWluZXIgPSB0aGlzLmNvbnRhaW5lclJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xuICAgICAgICBsZXQgbm90aWZpY2F0aW9uQ29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8Tm90aWZpY2F0aW9uQ29tcG9uZW50PjtcbiAgICAgICAgaWYgKG5vdGlmaWNhdGlvbkdyb3VwKSB7XG5cbiAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIGdyb3VwIFBhc3MgZ3JvdXAgcmVmZXJlbmNlIGFzIGEgY29udGFpbmVyXG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuY29udGFpbmVyID0gbm90aWZpY2F0aW9uR3JvdXAubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcblxuICAgICAgICAgICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbiBDb21wb25lbnRcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZiA9IHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuY3JlYXRlRHluYW1pY0NvbXBvbmVudChcbiAgICAgICAgICAgICAgICBjb250ZW50LFxuICAgICAgICAgICAgICAgIE5vdGlmaWNhdGlvbkNvbXBvbmVudCxcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcsXG4gICAgICAgICAgICAgICAgW25vdGlmaWNhdGlvblNlcnZpY2VdXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBBZGQgVG8gYXJyYXlcbiAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25Db21wb25lbnQ6IG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZixcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb25Hcm91cDogbm90aWZpY2F0aW9uR3JvdXBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvLyBDcmVhdGUgTm90aWZpY2F0aW9uIENvbXBvbmVudFxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29tcG9uZW50UmVmID0gdGhpcy5keW5hbWljQ29tcG9uZW50U2VydmljZS5jcmVhdGVEeW5hbWljQ29tcG9uZW50KFxuICAgICAgICAgICAgICAgIGNvbnRlbnQsXG4gICAgICAgICAgICAgICAgTm90aWZpY2F0aW9uQ29tcG9uZW50LFxuICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZyxcbiAgICAgICAgICAgICAgICBbbm90aWZpY2F0aW9uU2VydmljZV1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBUbyBhcnJheVxuICAgICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25zLnB1c2goe1xuICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbXBvbmVudDogbm90aWZpY2F0aW9uQ29tcG9uZW50UmVmLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZWZhdWx0QmVoYXZpb3VyT25DbG9zZSA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveU5vdGlmaWNhdGlvbkNvbXBvbmVudChub3RpZmljYXRpb25Db21wb25lbnRSZWYpO1xuICAgICAgICAgICAgcmVmU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICByZWZHcm91cFN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGRlZmF1bHRCZWhhdmlvdXJPbkdyb3VwQ2xvc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRlc3Ryb3lXaG9sZUdyb3VwKG5vdGlmaWNhdGlvbkNvbXBvbmVudFJlZik7XG4gICAgICAgICAgICByZWZHcm91cFN1Yi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgcmVmU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVmU3ViID0gbm90aWZpY2F0aW9uU2VydmljZS5hZnRlckNsb3NlZFxuICAgICAgICAgICAgLnN1YnNjcmliZShkZWZhdWx0QmVoYXZpb3VyT25DbG9zZSwgZGVmYXVsdEJlaGF2aW91ck9uQ2xvc2UpXG4gICAgICAgIDtcblxuICAgICAgICBjb25zdCByZWZHcm91cFN1YiA9IG5vdGlmaWNhdGlvblNlcnZpY2UuYWZ0ZXJDbG9zZWRHcm91cFxuICAgICAgICAgICAgLnN1YnNjcmliZShkZWZhdWx0QmVoYXZpb3VyT25Hcm91cENsb3NlLCBkZWZhdWx0QmVoYXZpb3VyT25Hcm91cENsb3NlKVxuICAgICAgICA7XG5cbiAgICAgICAgcmV0dXJuIG5vdGlmaWNhdGlvblNlcnZpY2U7XG4gICAgfVxuXG4gICAgLyoqIE1ldGhvZCB0byByZW1vdmUgYWxsIG9mIG5vdGlmaWNhdGlvbnMgZnJvbSB0aGlzIHNlcnZpY2UgaW5zdGFuY2UgKi9cbiAgICBwdWJsaWMgZGVzdHJveUFsbCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb25zLmZvckVhY2gobm90aWZpY2F0aW9uID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveU5vdGlmaWNhdGlvbkNvbXBvbmVudChub3RpZmljYXRpb24ubm90aWZpY2F0aW9uQ29tcG9uZW50KTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvKiogTWV0aG9kIHRoYXQgaW5mb3JtcyBpZiB0aGVyZSBpcyBhbnkgbm90aWZpY2F0aW9uIG9wZW5lZCBpbiB0aGlzIHNlcnZpY2UgaW5zdGFuY2UgKi9cbiAgICBwdWJsaWMgaXNBbnlPcGVuZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbnMgJiYgdGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCA+IDA7XG4gICAgfVxuXG4gICAgLyoqIE1ldGhvZCB0byBjcmVhdGUgTm90aWZpY2F0aW9uIEdyb3VwICovXG4gICAgcHVibGljIGNyZWF0ZU5vdGlmaWNhdGlvbkdyb3VwIChcbiAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnOiBOb3RpZmljYXRpb25Db25maWcgPSBuZXcgTm90aWZpY2F0aW9uQ29uZmlnKCksXG4gICAgKTogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkdyb3VwQ29tcG9uZW50PiB7XG5cbiAgICAgICAgLy8gUmVhc3NpZ24gQ29uZmlnIE9iamVjdFxuICAgICAgICBub3RpZmljYXRpb25Db25maWcgPSBPYmplY3QuYXNzaWduKG5ldyBOb3RpZmljYXRpb25Db25maWcoKSwgbm90aWZpY2F0aW9uQ29uZmlnKTtcblxuICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyUmVmKSB7XG5cbiAgICAgICAgICAgIC8vIENyZWF0ZSBDb250YWluZXIgQ29tcG9uZW50XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclJlZiA9IHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuY3JlYXRlRHluYW1pY0NvbXBvbmVudChcbiAgICAgICAgICAgICAgICBudWxsLCBOb3RpZmljYXRpb25Db250YWluZXIsIG5vdGlmaWNhdGlvbkNvbmZpZ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBhc3MgQ29udGFpbmVyIHJlZmVyZW5jZSBhcyBhIGNvbmZpZyBjb250YWluZXJcbiAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLmNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGFuZCByZXR1cm4gbm90aWZpY2F0aW9uIEdyb3VwIGNvbXBvbmVudCByZWZlcmVuY2VcbiAgICAgICAgcmV0dXJuIHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuY3JlYXRlRHluYW1pY0NvbXBvbmVudFxuICAgICAgICAgICAgPE5vdGlmaWNhdGlvbkdyb3VwQ29tcG9uZW50PihudWxsLCBOb3RpZmljYXRpb25Hcm91cENvbXBvbmVudCwgbm90aWZpY2F0aW9uQ29uZmlnKVxuICAgICAgICA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZXN0cm95V2hvbGVHcm91cChub3RpZmljYXRpb246IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+KTogdm9pZCB7XG5cbiAgICAgICAgLy8gRmluZCBOb3RpZmljYXRpb24gR3JvdXAgYXNzaWduZWQgdG8gdGhpcyBOb3RpZmljYXRpb24gQ29tcG9uZW50XG4gICAgICAgIGNvbnN0IGFycmF5UmVmID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbmQoaXRlbSA9PiBpdGVtLm5vdGlmaWNhdGlvbkNvbXBvbmVudCA9PT0gbm90aWZpY2F0aW9uKTtcbiAgICAgICAgaWYgKGFycmF5UmVmLm5vdGlmaWNhdGlvbkdyb3VwKSB7XG5cbiAgICAgICAgICAgIC8vIEZpbmQgQW55IG90aGVyIENvbXBvbmVudHMsIHRoYXQgYXJlIGluIHRoaXMgZ3JvdXBcbiAgICAgICAgICAgIGNvbnN0IGFycmF5VG9EZWxldGUgPSB0aGlzLm5vdGlmaWNhdGlvbnNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKF9ub3RpZmljYXRpb24gPT4gX25vdGlmaWNhdGlvbi5ub3RpZmljYXRpb25Hcm91cCA9PT0gYXJyYXlSZWYubm90aWZpY2F0aW9uR3JvdXApXG4gICAgICAgICAgICA7XG5cbiAgICAgICAgICAgIC8vIERlc3Ryb3kgZXZlcnkgc2luZ2xlIGNvbXBvbmVudCwgdGhhdCBhcmUgaW4gdGhlIGdyb3VwXG4gICAgICAgICAgICBhcnJheVRvRGVsZXRlLmZvckVhY2goX25vdGlmaWNhdGlvbiA9PiB0aGlzLmRlc3Ryb3lOb3RpZmljYXRpb25Db21wb25lbnQoX25vdGlmaWNhdGlvbi5ub3RpZmljYXRpb25Db21wb25lbnQpKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZXN0cm95Tm90aWZpY2F0aW9uQ29tcG9uZW50KG5vdGlmaWNhdGlvbjogQ29tcG9uZW50UmVmPE5vdGlmaWNhdGlvbkNvbXBvbmVudD4pOiB2b2lkIHtcblxuICAgICAgICAvLyBGaW5kIE5vdGlmaWNhdGlvbiBjb21wb25lbnQgaW4gdGhlIGFycmF5LlxuICAgICAgICBjb25zdCBhcnJheVJlZiA9IHRoaXMubm90aWZpY2F0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5ub3RpZmljYXRpb25Db21wb25lbnQgPT09IG5vdGlmaWNhdGlvbik7XG4gICAgICAgIGNvbnN0IGluZGV4T2YgPSB0aGlzLm5vdGlmaWNhdGlvbnMuaW5kZXhPZihhcnJheVJlZik7XG5cbiAgICAgICAgLy8gQ2hlY2sgdGhlIGFtb3VudCBvZiBjb21wb25lbnQgd2l0aGluIHRoZSBncm91cFxuICAgICAgICBjb25zdCBhbW91bnRPZkNvbXBvbmVudHNXaXRoVGhpc0dyb3VwID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbHRlcihpdGVtID0+XG4gICAgICAgICAgICBpdGVtLm5vdGlmaWNhdGlvbkdyb3VwICYmIGl0ZW0ubm90aWZpY2F0aW9uR3JvdXAgPT09IGFycmF5UmVmLm5vdGlmaWNhdGlvbkdyb3VwXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gSWYgaXQncyB0aGUgb25seSBvbmUgY29tcG9uZW50IHRoYXQgaXMgaW4gdGhlIGdyb3VwLCByZW1vdmUgZ3JvdXAgY29tcG9uZW50LlxuICAgICAgICBpZiAoYW1vdW50T2ZDb21wb25lbnRzV2l0aFRoaXNHcm91cC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuZGVzdHJveUNvbXBvbmVudChhcnJheVJlZi5ub3RpZmljYXRpb25Hcm91cCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEZXN0cm95IENvbXBvbmVudFxuICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmRlc3Ryb3lDb21wb25lbnQoYXJyYXlSZWYubm90aWZpY2F0aW9uQ29tcG9uZW50KTtcblxuICAgICAgICAvLyBSZW1vdmUgaXQgZnJvbSBBcnJheVxuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnNbaW5kZXhPZl0gPSBudWxsO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSB0aGlzLm5vdGlmaWNhdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbSAhPT0gbnVsbCAmJiBpdGVtICE9PSB1bmRlZmluZWQpO1xuXG4gICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIG90aGVyIG5vdGlmaWNhdGlvbiBDb21wb25lbnRzLCBqdXN0IHJlbW92ZSBjb250YWluZXIuXG4gICAgICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmRlc3Ryb3lDb21wb25lbnQodGhpcy5jb250YWluZXJSZWYpO1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWYgPSBudWxsO1xuICAgICAgICB9XG5cbiAgICB9XG59XG4iXX0=