/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Inject, Injectable, Injector } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { from, Observable } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { HttpUtils } from '../../utils';
import { IAuthenticationService, IAuthToken, IStorageService } from '../../interfaces';
import { GET_REQUESTS_ON_HOLD_MAP } from './errors/unauthorized-error.interceptor';
import { I18N_RESOURCE_URI_TOKEN } from '../../constants';
/**
 * @ngdoc service
 * @name @smartutils.httpAuthInterceptor
 *
 * @description
 * Makes it possible to perform global authentication by intercepting requests before they are forwarded to the server
 * and responses before they are forwarded to the application code.
 *
 */
var HttpAuthInterceptor = /** @class */ (function () {
    function HttpAuthInterceptor(authenticationService, injector, httpUtils, I18N_RESOURCE_URI) {
        this.authenticationService = authenticationService;
        this.injector = injector;
        this.httpUtils = httpUtils;
        this.I18N_RESOURCE_URI = I18N_RESOURCE_URI;
    }
    /**
     * @ngdoc method
     * @name @smartutils.httpAuthInterceptor#request
     * @methodOf @smartutils.httpAuthInterceptor
     *
     * @description
     * Interceptor method which gets called with a http config object, intercepts any request made using httpClient service.
     * A call to any REST resource will be intercepted by this method, which then adds an authentication token to the request
     * and then forwards it to the REST resource.
     *
     */
    HttpAuthInterceptor.prototype.intercept = function (request, next) {
        var _this = this;
        if (!request.url.includes(this.I18N_RESOURCE_URI) &&
            this.httpUtils.isCRUDRequest(request)) {
            if (this.httpUtils.isGET(request) && GET_REQUESTS_ON_HOLD_MAP[request.url]) {
                return new Observable(function (obj) {
                    GET_REQUESTS_ON_HOLD_MAP[request.url].then(function (body) {
                        obj.next(new HttpResponse({ status: 200, body: body }));
                    });
                });
            }
            return from(this.authenticationService.filterEntryPoints(request.url)).pipe(switchMap(function (entryPoints) {
                if (entryPoints && entryPoints.length) {
                    return from(_this.injector.get(IStorageService).getAuthToken(entryPoints[0])).pipe(switchMap(function (authToken) {
                        if (authToken) {
                            var authReq = request.clone({
                                headers: request.headers.set('Authorization', authToken.token_type + ' ' + authToken.access_token)
                            });
                            return next.handle(authReq);
                        }
                        else {
                            return next.handle(request);
                        }
                    }));
                }
                else {
                    return next.handle(request);
                }
            }));
        }
        else {
            return next.handle(request);
        }
    };
    HttpAuthInterceptor.ctorParameters = function () { return [
        { type: IAuthenticationService },
        { type: Injector },
        { type: HttpUtils },
        { type: String, decorators: [{ type: Inject, args: [I18N_RESOURCE_URI_TOKEN,] }] }
    ]; };
    HttpAuthInterceptor = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(3, Inject(I18N_RESOURCE_URI_TOKEN)),
        tslib_1.__metadata("design:paramtypes", [IAuthenticationService,
            Injector,
            HttpUtils, String])
    ], HttpAuthInterceptor);
    return HttpAuthInterceptor;
}());
export { HttpAuthInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1hdXRoLmludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNtYXJ0L3V0aWxzLyIsInNvdXJjZXMiOlsic2VydmljZXMvaW50ZXJjZXB0b3JzL2h0dHAtYXV0aC5pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHO0FBQ0gsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFLSCxZQUFZLEVBQ2YsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN4QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZGLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ25GLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTFEOzs7Ozs7OztHQVFHO0FBRUg7SUFDSSw2QkFDWSxxQkFBNkMsRUFDN0MsUUFBa0IsRUFDbEIsU0FBb0IsRUFDYSxpQkFBeUI7UUFIMUQsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF3QjtRQUM3QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDYSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQVE7SUFDbkUsQ0FBQztJQUNKOzs7Ozs7Ozs7O09BVUc7SUFDSCx1Q0FBUyxHQUFULFVBQVUsT0FBeUIsRUFBRSxJQUFpQjtRQUF0RCxpQkEwQ0M7UUF6Q0csSUFDSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztZQUM3QyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFDdkM7WUFDRSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDeEUsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFDLEdBQUc7b0JBQ3RCLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxJQUFJO3dCQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksWUFBWSxDQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLE1BQUEsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDM0QsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxDQUFDLENBQUM7YUFDTjtZQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ3ZFLFNBQVMsQ0FBdUMsVUFBQyxXQUFxQjtnQkFDbEUsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sRUFBRTtvQkFDbkMsT0FBTyxJQUFJLENBQ1AsS0FBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUNsRSxDQUFDLElBQUksQ0FDRixTQUFTLENBQ0wsVUFBQyxTQUFxQjt3QkFDbEIsSUFBSSxTQUFTLEVBQUU7NEJBQ1gsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztnQ0FDMUIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUN4QixlQUFlLEVBQ2YsU0FBUyxDQUFDLFVBQVUsR0FBRyxHQUFHLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FDdEQ7NkJBQ0osQ0FBQyxDQUFDOzRCQUNILE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQzt5QkFDL0I7NkJBQU07NEJBQ0gsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO3lCQUMvQjtvQkFDTCxDQUFDLENBQ0osQ0FDSixDQUFDO2lCQUNMO3FCQUFNO29CQUNILE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDL0I7WUFDTCxDQUFDLENBQUMsQ0FDTCxDQUFDO1NBQ0w7YUFBTTtZQUNILE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMvQjtJQUNMLENBQUM7O2dCQTFEa0Msc0JBQXNCO2dCQUNuQyxRQUFRO2dCQUNQLFNBQVM7NkNBQzNCLE1BQU0sU0FBQyx1QkFBdUI7O0lBTDFCLG1CQUFtQjtRQUQvQixVQUFVLEVBQUU7UUFNSixtQkFBQSxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQTtpREFIRCxzQkFBc0I7WUFDbkMsUUFBUTtZQUNQLFNBQVM7T0FKdkIsbUJBQW1CLENBNkQvQjtJQUFELDBCQUFDO0NBQUEsQUE3REQsSUE2REM7U0E3RFksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEh0dHBFdmVudCxcbiAgICBIdHRwSGFuZGxlcixcbiAgICBIdHRwSW50ZXJjZXB0b3IsXG4gICAgSHR0cFJlcXVlc3QsXG4gICAgSHR0cFJlc3BvbnNlXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEh0dHBVdGlscyB9IGZyb20gJy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IElBdXRoZW50aWNhdGlvblNlcnZpY2UsIElBdXRoVG9rZW4sIElTdG9yYWdlU2VydmljZSB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgR0VUX1JFUVVFU1RTX09OX0hPTERfTUFQIH0gZnJvbSAnLi9lcnJvcnMvdW5hdXRob3JpemVkLWVycm9yLmludGVyY2VwdG9yJztcbmltcG9ydCB7IEkxOE5fUkVTT1VSQ0VfVVJJX1RPS0VOIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcblxuLyoqXG4gKiBAbmdkb2Mgc2VydmljZVxuICogQG5hbWUgQHNtYXJ0dXRpbHMuaHR0cEF1dGhJbnRlcmNlcHRvclxuICpcbiAqIEBkZXNjcmlwdGlvblxuICogTWFrZXMgaXQgcG9zc2libGUgdG8gcGVyZm9ybSBnbG9iYWwgYXV0aGVudGljYXRpb24gYnkgaW50ZXJjZXB0aW5nIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBmb3J3YXJkZWQgdG8gdGhlIHNlcnZlclxuICogYW5kIHJlc3BvbnNlcyBiZWZvcmUgdGhleSBhcmUgZm9yd2FyZGVkIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlLlxuICpcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEh0dHBBdXRoSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGF1dGhlbnRpY2F0aW9uU2VydmljZTogSUF1dGhlbnRpY2F0aW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgaHR0cFV0aWxzOiBIdHRwVXRpbHMsXG4gICAgICAgIEBJbmplY3QoSTE4Tl9SRVNPVVJDRV9VUklfVE9LRU4pIHByaXZhdGUgSTE4Tl9SRVNPVVJDRV9VUkk6IHN0cmluZ1xuICAgICkge31cbiAgICAvKipcbiAgICAgKiBAbmdkb2MgbWV0aG9kXG4gICAgICogQG5hbWUgQHNtYXJ0dXRpbHMuaHR0cEF1dGhJbnRlcmNlcHRvciNyZXF1ZXN0XG4gICAgICogQG1ldGhvZE9mIEBzbWFydHV0aWxzLmh0dHBBdXRoSW50ZXJjZXB0b3JcbiAgICAgKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIEludGVyY2VwdG9yIG1ldGhvZCB3aGljaCBnZXRzIGNhbGxlZCB3aXRoIGEgaHR0cCBjb25maWcgb2JqZWN0LCBpbnRlcmNlcHRzIGFueSByZXF1ZXN0IG1hZGUgdXNpbmcgaHR0cENsaWVudCBzZXJ2aWNlLlxuICAgICAqIEEgY2FsbCB0byBhbnkgUkVTVCByZXNvdXJjZSB3aWxsIGJlIGludGVyY2VwdGVkIGJ5IHRoaXMgbWV0aG9kLCB3aGljaCB0aGVuIGFkZHMgYW4gYXV0aGVudGljYXRpb24gdG9rZW4gdG8gdGhlIHJlcXVlc3RcbiAgICAgKiBhbmQgdGhlbiBmb3J3YXJkcyBpdCB0byB0aGUgUkVTVCByZXNvdXJjZS5cbiAgICAgKlxuICAgICAqL1xuICAgIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgIXJlcXVlc3QudXJsLmluY2x1ZGVzKHRoaXMuSTE4Tl9SRVNPVVJDRV9VUkkpICYmXG4gICAgICAgICAgICB0aGlzLmh0dHBVdGlscy5pc0NSVURSZXF1ZXN0KHJlcXVlc3QpXG4gICAgICAgICkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaHR0cFV0aWxzLmlzR0VUKHJlcXVlc3QpICYmIEdFVF9SRVFVRVNUU19PTl9IT0xEX01BUFtyZXF1ZXN0LnVybF0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9iaikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBHRVRfUkVRVUVTVFNfT05fSE9MRF9NQVBbcmVxdWVzdC51cmxdLnRoZW4oKGJvZHkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5uZXh0KG5ldyBIdHRwUmVzcG9uc2U8YW55Pih7IHN0YXR1czogMjAwLCBib2R5IH0pKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5maWx0ZXJFbnRyeVBvaW50cyhyZXF1ZXN0LnVybCkpLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwPHN0cmluZ1tdLCBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+Pj4oKGVudHJ5UG9pbnRzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZW50cnlQb2ludHMgJiYgZW50cnlQb2ludHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJvbTxPYnNlcnZhYmxlPElBdXRoVG9rZW4+PihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluamVjdG9yLmdldChJU3RvcmFnZVNlcnZpY2UpLmdldEF1dGhUb2tlbihlbnRyeVBvaW50c1swXSlcbiAgICAgICAgICAgICAgICAgICAgICAgICkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXA8SUF1dGhUb2tlbiwgT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4+KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYXV0aFRva2VuOiBJQXV0aFRva2VuKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aFRva2VuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXV0aFJlcSA9IHJlcXVlc3QuY2xvbmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnMuc2V0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0aFRva2VuLnRva2VuX3R5cGUgKyAnICcgKyBhdXRoVG9rZW4uYWNjZXNzX3Rva2VuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUoYXV0aFJlcSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==