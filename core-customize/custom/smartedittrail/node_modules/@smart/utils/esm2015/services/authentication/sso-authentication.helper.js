/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
var SSOAuthenticationHelper_1;
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Injectable, Injector } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { Deferred, PromiseUtils, WindowUtils } from '../../utils';
const SSO_DIALOG_MARKER = 'sso';
var SSO_PROPERTIES;
(function (SSO_PROPERTIES) {
    SSO_PROPERTIES["SSO_CLIENT_ID"] = "SSO_CLIENT_ID";
    SSO_PROPERTIES["SSO_AUTHENTICATION_ENTRY_POINT"] = "SSO_AUTHENTICATION_ENTRY_POINT";
    SSO_PROPERTIES["SSO_LOGOUT_ENTRY_POINT"] = "SSO_LOGOUT_ENTRY_POINT";
    SSO_PROPERTIES["SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT"] = "SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT";
})(SSO_PROPERTIES || (SSO_PROPERTIES = {}));
const CHILD_SMARTEDIT_SENDING_AUTHTOKEN = 'ssoAuthenticate';
const CHILD_SMARTEDIT_SENDING_AUTH_ERROR = 'ssoAuthenticateError';
const SSODIALOG_WINDOW = 'SSODIALOG_WINDOW';
/*
 * Helper to initiate a SAML /SSO autentication sequence through a pop-up
 * (because the sequence involves auto-submiting html form at some point that causes a redirect and hence would
 * loose app context if not executed in a different window)
 * that ultimately loads the app again which in turn will detect its context and do the following:
 * - will not continue loading
 * - wil post the loginToken to the /authenticate end point to retrieve oAuth access
 * - will send back to parent (through postMessage) the retrieved oAuth access
 * - will close;
 */
let SSOAuthenticationHelper = SSOAuthenticationHelper_1 = class SSOAuthenticationHelper {
    constructor(windowUtils, promiseUtils, httpClient, injector) {
        this.windowUtils = windowUtils;
        this.promiseUtils = promiseUtils;
        this.httpClient = httpClient;
        this.injector = injector;
        this.logoutIframeId = 'logoutIframe';
        this.deferred = null;
        this.listenForAuthTokenBeingSentBack();
    }
    /*
     * Initiates the SSO dialog through a pop-up
     */
    launchSSODialog() {
        this.deferred = this.promiseUtils.defer();
        const ssoAuthenticationEntryPoint = this.injector.get(SSO_PROPERTIES.SSO_AUTHENTICATION_ENTRY_POINT) +
            this.getSSOContextPath();
        this.window.open(ssoAuthenticationEntryPoint, SSODIALOG_WINDOW, 'toolbar=no,scrollbars=no,resizable=no,top=200,left=200,width=1000,height=800');
        return this.deferred.promise;
    }
    /*
     * SSO happen in a popup window launched by AuthenticationHelper#launchSSODialog().
     * Once SSO is successful, a 'LoginToken' cookie is present, this is a pre-requisite for doing a POST to the /authenticate
     * endpoint that will return the Authorization bearer token.
     * This bearer is then sent with postMessage to the opener window, i.e. the SmartEdit application that will resume the pending 401 request.
     */
    completeDialog() {
        return new Promise((resolve, reject) => {
            this.httpClient
                .post(this.injector.get(SSO_PROPERTIES.SSO_OAUTH2_AUTHENTICATION_ENTRY_POINT), { client_id: this.injector.get(SSO_PROPERTIES.SSO_CLIENT_ID) })
                .subscribe((authToken) => {
                this.window.opener.postMessage({
                    eventId: CHILD_SMARTEDIT_SENDING_AUTHTOKEN,
                    authToken
                }, this.document.location.origin);
                this.window.close();
                resolve();
            }, (httpErrorResponse) => {
                const clonableHttpErrorResponse = {
                    error: httpErrorResponse.error,
                    status: httpErrorResponse.status
                };
                this.window.opener.postMessage({
                    eventId: CHILD_SMARTEDIT_SENDING_AUTH_ERROR,
                    error: clonableHttpErrorResponse
                }, this.document.location.origin);
                this.window.close();
                reject();
            });
        });
    }
    /*
     * case of the App being a popup only meant for authentication and spun up buy the main app
     */
    isSSODialog() {
        return (this.window.name === SSODIALOG_WINDOW &&
            new RegExp(`[?&]${SSO_DIALOG_MARKER}`).test(location.search));
    }
    /*
     * case of:
     * - the App called from another app in an SSO context and that should therefore auto-authenticate with SSO
     * - last manual authentication was with SSO
     */
    isAutoSSOMain() {
        return (SSOAuthenticationHelper_1.lastAuthenticatedWithSSO ||
            (this.window.name !== SSODIALOG_WINDOW &&
                new RegExp(`[?&]${SSO_DIALOG_MARKER}`).test(location.search)));
    }
    logout() {
        let logoutIframe = this.logoutIframe;
        if (!logoutIframe) {
            logoutIframe = this.document.createElement('iframe');
            logoutIframe.id = this.logoutIframeId;
            logoutIframe.style.display = 'none';
            this.document.body.appendChild(logoutIframe);
        }
        logoutIframe.src = this.injector.get(SSO_PROPERTIES.SSO_LOGOUT_ENTRY_POINT);
        SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = false;
        this.document.location.href = this.document.location.href.replace(this.getSSOContextPath(), this.document.location.pathname);
    }
    // context path of app in an SSO mode
    getSSOContextPath() {
        return `${this.document.location.pathname}?${SSO_DIALOG_MARKER}`;
    }
    listenForAuthTokenBeingSentBack() {
        this.window.addEventListener('message', (event) => {
            if (event.origin !== document.location.origin) {
                return;
            }
            this.logoutIframe && this.logoutIframe.remove();
            if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTHTOKEN) {
                SSOAuthenticationHelper_1.lastAuthenticatedWithSSO = true;
                this.deferred && this.deferred.resolve(event.data.authToken);
            }
            else if (event.data.eventId === CHILD_SMARTEDIT_SENDING_AUTH_ERROR) {
                this.deferred && this.deferred.reject(event.data.error);
            }
        }, false);
    }
    get window() {
        return this.windowUtils.getWindow();
    }
    get document() {
        return this.window.document;
    }
    get logoutIframe() {
        return this.document.querySelector(`iframe#${this.logoutIframeId}`);
    }
};
// static in order to be shared by multiple instances
SSOAuthenticationHelper.lastAuthenticatedWithSSO = false;
SSOAuthenticationHelper.ctorParameters = () => [
    { type: WindowUtils },
    { type: PromiseUtils },
    { type: HttpClient },
    { type: Injector }
];
SSOAuthenticationHelper = SSOAuthenticationHelper_1 = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [WindowUtils,
        PromiseUtils,
        HttpClient,
        Injector])
], SSOAuthenticationHelper);
export { SSOAuthenticationHelper };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NvLWF1dGhlbnRpY2F0aW9uLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2F1dGhlbnRpY2F0aW9uL3Nzby1hdXRoZW50aWNhdGlvbi5oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7O0dBR0c7QUFDSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFckUsT0FBTyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRWxFLE1BQU0saUJBQWlCLEdBQUcsS0FBSyxDQUFDO0FBRWhDLElBQUssY0FLSjtBQUxELFdBQUssY0FBYztJQUNmLGlEQUErQixDQUFBO0lBQy9CLG1GQUFpRSxDQUFBO0lBQ2pFLG1FQUFpRCxDQUFBO0lBQ2pELGlHQUErRSxDQUFBO0FBQ25GLENBQUMsRUFMSSxjQUFjLEtBQWQsY0FBYyxRQUtsQjtBQUVELE1BQU0saUNBQWlDLEdBQUcsaUJBQWlCLENBQUM7QUFDNUQsTUFBTSxrQ0FBa0MsR0FBRyxzQkFBc0IsQ0FBQztBQUVsRSxNQUFNLGdCQUFnQixHQUFHLGtCQUFrQixDQUFDO0FBQzVDOzs7Ozs7Ozs7R0FTRztBQUVILElBQWEsdUJBQXVCLCtCQUFwQyxNQUFhLHVCQUF1QjtJQVFoQyxZQUNZLFdBQXdCLEVBQ3hCLFlBQTBCLEVBQzFCLFVBQXNCLEVBQ3RCLFFBQWtCO1FBSGxCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVJiLG1CQUFjLEdBQUcsY0FBYyxDQUFDO1FBRXpDLGFBQVEsR0FBZ0MsSUFBSSxDQUFDO1FBUWpELElBQUksQ0FBQywrQkFBK0IsRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWU7UUFDWCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFjLENBQUM7UUFFdEQsTUFBTSwyQkFBMkIsR0FDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLDhCQUE4QixDQUFDO1lBQ2hFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNaLDJCQUEyQixFQUMzQixnQkFBZ0IsRUFDaEIsOEVBQThFLENBQ2pGLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILGNBQWM7UUFDVixPQUFPLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxVQUFVO2lCQUNWLElBQUksQ0FDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMscUNBQXFDLENBQUMsRUFDdkUsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQ2pFO2lCQUNBLFNBQVMsQ0FDTixDQUFDLFNBQVMsRUFBRSxFQUFFO2dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FDMUI7b0JBQ0ksT0FBTyxFQUFFLGlDQUFpQztvQkFDMUMsU0FBUztpQkFDWixFQUNELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FDaEMsQ0FBQztnQkFDRixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNwQixPQUFPLEVBQUUsQ0FBQztZQUNkLENBQUMsRUFDRCxDQUFDLGlCQUFvQyxFQUFFLEVBQUU7Z0JBQ3JDLE1BQU0seUJBQXlCLEdBQUc7b0JBQzlCLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxLQUFLO29CQUM5QixNQUFNLEVBQUUsaUJBQWlCLENBQUMsTUFBTTtpQkFDbkMsQ0FBQztnQkFDRixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQzFCO29CQUNJLE9BQU8sRUFBRSxrQ0FBa0M7b0JBQzNDLEtBQUssRUFBRSx5QkFBeUI7aUJBQ25DLEVBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUNoQyxDQUFDO2dCQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ3BCLE1BQU0sRUFBRSxDQUFDO1lBQ2IsQ0FBQyxDQUNKLENBQUM7UUFDVixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDUCxPQUFPLENBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssZ0JBQWdCO1lBQ3JDLElBQUksTUFBTSxDQUFDLE9BQU8saUJBQWlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQy9ELENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGFBQWE7UUFDVCxPQUFPLENBQ0gseUJBQXVCLENBQUMsd0JBQXdCO1lBQ2hELENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssZ0JBQWdCO2dCQUNsQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQ3BFLENBQUM7SUFDTixDQUFDO0lBRUQsTUFBTTtRQUNGLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDckMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNmLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyRCxZQUFZLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDdEMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUNoRDtRQUNELFlBQVksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFFNUUseUJBQXVCLENBQUMsd0JBQXdCLEdBQUcsS0FBSyxDQUFDO1FBQ3pELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUM3RCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUNsQyxDQUFDO0lBQ04sQ0FBQztJQUVELHFDQUFxQztJQUM3QixpQkFBaUI7UUFDckIsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO0lBQ3JFLENBQUM7SUFFTywrQkFBK0I7UUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FDeEIsU0FBUyxFQUNULENBQUMsS0FBbUIsRUFBRSxFQUFFO1lBQ3BCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDM0MsT0FBTzthQUNWO1lBRUQsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBRWhELElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssaUNBQWlDLEVBQUU7Z0JBQzFELHlCQUF1QixDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQztnQkFDeEQsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQ2hFO2lCQUFNLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEtBQUssa0NBQWtDLEVBQUU7Z0JBQ2xFLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMzRDtRQUNMLENBQUMsRUFDRCxLQUFLLENBQ1IsQ0FBQztJQUNOLENBQUM7SUFFRCxJQUFZLE1BQU07UUFDZCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVELElBQVksUUFBUTtRQUNoQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2hDLENBQUM7SUFFRCxJQUFZLFlBQVk7UUFDcEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBb0IsVUFBVSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDO0NBQ0osQ0FBQTtBQTNKRyxxREFBcUQ7QUFDdEMsZ0RBQXdCLEdBQUcsS0FBSyxDQUFDOztZQU92QixXQUFXO1lBQ1YsWUFBWTtZQUNkLFVBQVU7WUFDWixRQUFROztBQVpyQix1QkFBdUI7SUFEbkMsVUFBVSxFQUFFOzZDQVVnQixXQUFXO1FBQ1YsWUFBWTtRQUNkLFVBQVU7UUFDWixRQUFRO0dBWnJCLHVCQUF1QixDQTRKbkM7U0E1SlksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJQXV0aFRva2VuIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBEZWZlcnJlZCwgUHJvbWlzZVV0aWxzLCBXaW5kb3dVdGlscyB9IGZyb20gJy4uLy4uL3V0aWxzJztcblxuY29uc3QgU1NPX0RJQUxPR19NQVJLRVIgPSAnc3NvJztcblxuZW51bSBTU09fUFJPUEVSVElFUyB7XG4gICAgU1NPX0NMSUVOVF9JRCA9ICdTU09fQ0xJRU5UX0lEJyxcbiAgICBTU09fQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQgPSAnU1NPX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UJyxcbiAgICBTU09fTE9HT1VUX0VOVFJZX1BPSU5UID0gJ1NTT19MT0dPVVRfRU5UUllfUE9JTlQnLFxuICAgIFNTT19PQVVUSDJfQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQgPSAnU1NPX09BVVRIMl9BVVRIRU5USUNBVElPTl9FTlRSWV9QT0lOVCdcbn1cblxuY29uc3QgQ0hJTERfU01BUlRFRElUX1NFTkRJTkdfQVVUSFRPS0VOID0gJ3Nzb0F1dGhlbnRpY2F0ZSc7XG5jb25zdCBDSElMRF9TTUFSVEVESVRfU0VORElOR19BVVRIX0VSUk9SID0gJ3Nzb0F1dGhlbnRpY2F0ZUVycm9yJztcblxuY29uc3QgU1NPRElBTE9HX1dJTkRPVyA9ICdTU09ESUFMT0dfV0lORE9XJztcbi8qXG4gKiBIZWxwZXIgdG8gaW5pdGlhdGUgYSBTQU1MIC9TU08gYXV0ZW50aWNhdGlvbiBzZXF1ZW5jZSB0aHJvdWdoIGEgcG9wLXVwXG4gKiAoYmVjYXVzZSB0aGUgc2VxdWVuY2UgaW52b2x2ZXMgYXV0by1zdWJtaXRpbmcgaHRtbCBmb3JtIGF0IHNvbWUgcG9pbnQgdGhhdCBjYXVzZXMgYSByZWRpcmVjdCBhbmQgaGVuY2Ugd291bGRcbiAqIGxvb3NlIGFwcCBjb250ZXh0IGlmIG5vdCBleGVjdXRlZCBpbiBhIGRpZmZlcmVudCB3aW5kb3cpXG4gKiB0aGF0IHVsdGltYXRlbHkgbG9hZHMgdGhlIGFwcCBhZ2FpbiB3aGljaCBpbiB0dXJuIHdpbGwgZGV0ZWN0IGl0cyBjb250ZXh0IGFuZCBkbyB0aGUgZm9sbG93aW5nOlxuICogLSB3aWxsIG5vdCBjb250aW51ZSBsb2FkaW5nXG4gKiAtIHdpbCBwb3N0IHRoZSBsb2dpblRva2VuIHRvIHRoZSAvYXV0aGVudGljYXRlIGVuZCBwb2ludCB0byByZXRyaWV2ZSBvQXV0aCBhY2Nlc3NcbiAqIC0gd2lsbCBzZW5kIGJhY2sgdG8gcGFyZW50ICh0aHJvdWdoIHBvc3RNZXNzYWdlKSB0aGUgcmV0cmlldmVkIG9BdXRoIGFjY2Vzc1xuICogLSB3aWxsIGNsb3NlO1xuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU1NPQXV0aGVudGljYXRpb25IZWxwZXIge1xuICAgIC8vIHN0YXRpYyBpbiBvcmRlciB0byBiZSBzaGFyZWQgYnkgbXVsdGlwbGUgaW5zdGFuY2VzXG4gICAgcHJpdmF0ZSBzdGF0aWMgbGFzdEF1dGhlbnRpY2F0ZWRXaXRoU1NPID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGxvZ291dElmcmFtZUlkID0gJ2xvZ291dElmcmFtZSc7XG5cbiAgICBwcml2YXRlIGRlZmVycmVkOiBEZWZlcnJlZDxJQXV0aFRva2VuPiB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgd2luZG93VXRpbHM6IFdpbmRvd1V0aWxzLFxuICAgICAgICBwcml2YXRlIHByb21pc2VVdGlsczogUHJvbWlzZVV0aWxzLFxuICAgICAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXG4gICAgKSB7XG4gICAgICAgIHRoaXMubGlzdGVuRm9yQXV0aFRva2VuQmVpbmdTZW50QmFjaygpO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogSW5pdGlhdGVzIHRoZSBTU08gZGlhbG9nIHRocm91Z2ggYSBwb3AtdXBcbiAgICAgKi9cbiAgICBsYXVuY2hTU09EaWFsb2coKTogUHJvbWlzZTxJQXV0aFRva2VuPiB7XG4gICAgICAgIHRoaXMuZGVmZXJyZWQgPSB0aGlzLnByb21pc2VVdGlscy5kZWZlcjxJQXV0aFRva2VuPigpO1xuXG4gICAgICAgIGNvbnN0IHNzb0F1dGhlbnRpY2F0aW9uRW50cnlQb2ludCA9XG4gICAgICAgICAgICB0aGlzLmluamVjdG9yLmdldChTU09fUFJPUEVSVElFUy5TU09fQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQpICtcbiAgICAgICAgICAgIHRoaXMuZ2V0U1NPQ29udGV4dFBhdGgoKTtcbiAgICAgICAgdGhpcy53aW5kb3cub3BlbihcbiAgICAgICAgICAgIHNzb0F1dGhlbnRpY2F0aW9uRW50cnlQb2ludCxcbiAgICAgICAgICAgIFNTT0RJQUxPR19XSU5ET1csXG4gICAgICAgICAgICAndG9vbGJhcj1ubyxzY3JvbGxiYXJzPW5vLHJlc2l6YWJsZT1ubyx0b3A9MjAwLGxlZnQ9MjAwLHdpZHRoPTEwMDAsaGVpZ2h0PTgwMCdcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5kZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogU1NPIGhhcHBlbiBpbiBhIHBvcHVwIHdpbmRvdyBsYXVuY2hlZCBieSBBdXRoZW50aWNhdGlvbkhlbHBlciNsYXVuY2hTU09EaWFsb2coKS5cbiAgICAgKiBPbmNlIFNTTyBpcyBzdWNjZXNzZnVsLCBhICdMb2dpblRva2VuJyBjb29raWUgaXMgcHJlc2VudCwgdGhpcyBpcyBhIHByZS1yZXF1aXNpdGUgZm9yIGRvaW5nIGEgUE9TVCB0byB0aGUgL2F1dGhlbnRpY2F0ZVxuICAgICAqIGVuZHBvaW50IHRoYXQgd2lsbCByZXR1cm4gdGhlIEF1dGhvcml6YXRpb24gYmVhcmVyIHRva2VuLlxuICAgICAqIFRoaXMgYmVhcmVyIGlzIHRoZW4gc2VudCB3aXRoIHBvc3RNZXNzYWdlIHRvIHRoZSBvcGVuZXIgd2luZG93LCBpLmUuIHRoZSBTbWFydEVkaXQgYXBwbGljYXRpb24gdGhhdCB3aWxsIHJlc3VtZSB0aGUgcGVuZGluZyA0MDEgcmVxdWVzdC5cbiAgICAgKi9cbiAgICBjb21wbGV0ZURpYWxvZygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAgICAgICAgIC5wb3N0PElBdXRoVG9rZW4+KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluamVjdG9yLmdldChTU09fUFJPUEVSVElFUy5TU09fT0FVVEgyX0FVVEhFTlRJQ0FUSU9OX0VOVFJZX1BPSU5UKSxcbiAgICAgICAgICAgICAgICAgICAgeyBjbGllbnRfaWQ6IHRoaXMuaW5qZWN0b3IuZ2V0KFNTT19QUk9QRVJUSUVTLlNTT19DTElFTlRfSUQpIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAgICAgKGF1dGhUb2tlbikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53aW5kb3cub3BlbmVyLnBvc3RNZXNzYWdlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRJZDogQ0hJTERfU01BUlRFRElUX1NFTkRJTkdfQVVUSFRPS0VOLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRoVG9rZW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG9jdW1lbnQubG9jYXRpb24ub3JpZ2luXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy53aW5kb3cuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgKGh0dHBFcnJvclJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xvbmFibGVIdHRwRXJyb3JSZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogaHR0cEVycm9yUmVzcG9uc2UuZXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBodHRwRXJyb3JSZXNwb25zZS5zdGF0dXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndpbmRvdy5vcGVuZXIucG9zdE1lc3NhZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudElkOiBDSElMRF9TTUFSVEVESVRfU0VORElOR19BVVRIX0VSUk9SLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogY2xvbmFibGVIdHRwRXJyb3JSZXNwb25zZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5vcmlnaW5cbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLndpbmRvdy5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKlxuICAgICAqIGNhc2Ugb2YgdGhlIEFwcCBiZWluZyBhIHBvcHVwIG9ubHkgbWVhbnQgZm9yIGF1dGhlbnRpY2F0aW9uIGFuZCBzcHVuIHVwIGJ1eSB0aGUgbWFpbiBhcHBcbiAgICAgKi9cbiAgICBpc1NTT0RpYWxvZygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMud2luZG93Lm5hbWUgPT09IFNTT0RJQUxPR19XSU5ET1cgJiZcbiAgICAgICAgICAgIG5ldyBSZWdFeHAoYFs/Jl0ke1NTT19ESUFMT0dfTUFSS0VSfWApLnRlc3QobG9jYXRpb24uc2VhcmNoKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qXG4gICAgICogY2FzZSBvZjpcbiAgICAgKiAtIHRoZSBBcHAgY2FsbGVkIGZyb20gYW5vdGhlciBhcHAgaW4gYW4gU1NPIGNvbnRleHQgYW5kIHRoYXQgc2hvdWxkIHRoZXJlZm9yZSBhdXRvLWF1dGhlbnRpY2F0ZSB3aXRoIFNTT1xuICAgICAqIC0gbGFzdCBtYW51YWwgYXV0aGVudGljYXRpb24gd2FzIHdpdGggU1NPXG4gICAgICovXG4gICAgaXNBdXRvU1NPTWFpbigpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIFNTT0F1dGhlbnRpY2F0aW9uSGVscGVyLmxhc3RBdXRoZW50aWNhdGVkV2l0aFNTTyB8fFxuICAgICAgICAgICAgKHRoaXMud2luZG93Lm5hbWUgIT09IFNTT0RJQUxPR19XSU5ET1cgJiZcbiAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKGBbPyZdJHtTU09fRElBTE9HX01BUktFUn1gKS50ZXN0KGxvY2F0aW9uLnNlYXJjaCkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgbG9nb3V0KCk6IGFueSB7XG4gICAgICAgIGxldCBsb2dvdXRJZnJhbWUgPSB0aGlzLmxvZ291dElmcmFtZTtcbiAgICAgICAgaWYgKCFsb2dvdXRJZnJhbWUpIHtcbiAgICAgICAgICAgIGxvZ291dElmcmFtZSA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7XG4gICAgICAgICAgICBsb2dvdXRJZnJhbWUuaWQgPSB0aGlzLmxvZ291dElmcmFtZUlkO1xuICAgICAgICAgICAgbG9nb3V0SWZyYW1lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobG9nb3V0SWZyYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBsb2dvdXRJZnJhbWUuc3JjID0gdGhpcy5pbmplY3Rvci5nZXQoU1NPX1BST1BFUlRJRVMuU1NPX0xPR09VVF9FTlRSWV9QT0lOVCk7XG5cbiAgICAgICAgU1NPQXV0aGVudGljYXRpb25IZWxwZXIubGFzdEF1dGhlbnRpY2F0ZWRXaXRoU1NPID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaHJlZi5yZXBsYWNlKFxuICAgICAgICAgICAgdGhpcy5nZXRTU09Db250ZXh0UGF0aCgpLFxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8vIGNvbnRleHQgcGF0aCBvZiBhcHAgaW4gYW4gU1NPIG1vZGVcbiAgICBwcml2YXRlIGdldFNTT0NvbnRleHRQYXRoKCkge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5kb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZX0/JHtTU09fRElBTE9HX01BUktFUn1gO1xuICAgIH1cblxuICAgIHByaXZhdGUgbGlzdGVuRm9yQXV0aFRva2VuQmVpbmdTZW50QmFjaygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgICAgICdtZXNzYWdlJyxcbiAgICAgICAgICAgIChldmVudDogTWVzc2FnZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50Lm9yaWdpbiAhPT0gZG9jdW1lbnQubG9jYXRpb24ub3JpZ2luKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmxvZ291dElmcmFtZSAmJiB0aGlzLmxvZ291dElmcmFtZS5yZW1vdmUoKTtcblxuICAgICAgICAgICAgICAgIGlmIChldmVudC5kYXRhLmV2ZW50SWQgPT09IENISUxEX1NNQVJURURJVF9TRU5ESU5HX0FVVEhUT0tFTikge1xuICAgICAgICAgICAgICAgICAgICBTU09BdXRoZW50aWNhdGlvbkhlbHBlci5sYXN0QXV0aGVudGljYXRlZFdpdGhTU08gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmVycmVkICYmIHRoaXMuZGVmZXJyZWQucmVzb2x2ZShldmVudC5kYXRhLmF1dGhUb2tlbik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5kYXRhLmV2ZW50SWQgPT09IENISUxEX1NNQVJURURJVF9TRU5ESU5HX0FVVEhfRVJST1IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZlcnJlZCAmJiB0aGlzLmRlZmVycmVkLnJlamVjdChldmVudC5kYXRhLmVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCB3aW5kb3coKSB7XG4gICAgICAgIHJldHVybiB0aGlzLndpbmRvd1V0aWxzLmdldFdpbmRvdygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGRvY3VtZW50KCk6IERvY3VtZW50IHtcbiAgICAgICAgcmV0dXJuIHRoaXMud2luZG93LmRvY3VtZW50O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGxvZ291dElmcmFtZSgpOiBIVE1MSUZyYW1lRWxlbWVudCB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yPEhUTUxJRnJhbWVFbGVtZW50PihgaWZyYW1lIyR7dGhpcy5sb2dvdXRJZnJhbWVJZH1gKTtcbiAgICB9XG59XG4iXX0=