/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient, HttpErrorResponse, HttpRequest } from '@angular/common/http';
import { TranslateService } from '@ngx-translate/core';
import { IAlertService } from '../../../interfaces';
import { BooleanUtils } from '../../../utils';
import { clientErrorPredicate, noInternetConnectionErrorPredicate, readPredicate, retriableErrorPredicate, serverErrorPredicate, timeoutErrorPredicate, DefaultRetryStrategy, ExponentialRetryStrategy, IRetryStrategy, LinearRetryStrategy, OperationContextService } from './retries';
import { LIBRARY_NAME } from '../../../constants';
export const OPERATION_CONTEXT_TOKEN = `${LIBRARY_NAME}_OPERATION_CONTEXT`;
/**
 * @ngdoc service
 * @name @smartutils.services:retryInterceptor
 *
 * @description
 * The retryInterceptor provides the functionality to register a set of predicates with their associated retry strategies.
 * Each time an HTTP request fails, the service try to find a matching retry strategy for the given response.
 */
let RetryInterceptor = class RetryInterceptor {
    constructor(httpClient, translate, operationContextService, alertService, booleanUtils, defaultRetryStrategy, exponentialRetryStrategy, linearRetryStrategy, OPERATION_CONTEXT) {
        this.httpClient = httpClient;
        this.translate = translate;
        this.operationContextService = operationContextService;
        this.alertService = alertService;
        this.OPERATION_CONTEXT = OPERATION_CONTEXT;
        this.TRANSLATE_NAMESPACE = 'se.gracefuldegradation.';
        this.predicatesRegistry = [];
        this.requestToRetryTegistry = {};
        this.register(noInternetConnectionErrorPredicate, exponentialRetryStrategy)
            .register(booleanUtils.isAnyTruthy(clientErrorPredicate, timeoutErrorPredicate), defaultRetryStrategy)
            .register(booleanUtils.areAllTruthy(readPredicate, retriableErrorPredicate), defaultRetryStrategy)
            .register(serverErrorPredicate, exponentialRetryStrategy);
    }
    predicate(request, response) {
        return this.findMatchingStrategy(request, response) !== null;
    }
    responseError(request, response) {
        let retryStrategy = this.retrieveRetryStrategy(request);
        if (!retryStrategy) {
            const StrategyHolder = this.findMatchingStrategy(request, response);
            if (StrategyHolder) {
                this.alertService.showWarning({
                    message: this.translate.instant(this.TRANSLATE_NAMESPACE + 'stillworking')
                });
                retryStrategy = new StrategyHolder();
                retryStrategy.attemptCount = 0;
                this.storeRetryStrategy(request, retryStrategy);
            }
            else {
                return Promise.reject(response);
            }
        }
        return this.handleRetry(retryStrategy, request, response);
    }
    /**
     * @ngdoc method
     * @name @smartutils.services:retryInterceptor#register
     * @methodOf @smartutils.services:retryInterceptor
     *
     * @description
     * Register a new predicate with it's associated strategyHolder.
     *
     * @param {Function} predicate This function takes the 'response' {Object} argument and an (optional) operationContext {String}. This function must return a Boolean that is true if the given response match the predicate.
     * @param {Function} retryStrategy This function will be instanciated at run-time. See {@link @smartutils.services:IRetryStrategy IRetryStrategy}.
     *
     * @return {Object} retryInterceptor The retryInterceptor service.
     *
     * @example
     * ```js
     *      var customPredicate = function(request, response, operationContext) {
     *          return response.status === 500 && operationContext === OPERATION_CONTEXT.TOOLING;
     *      };
     *      var StrategyHolder = function() {
     *          // set the firstFastRetry value to true for the retry made immediately only for the very first retry (subsequent retries will remain subject to the calculateNextDelay response)
     *          this.firstFastRetry = true;
     *      };
     *      StrategyHolder.prototype.canRetry = function() {
     *          // this function must return a {Boolean} if the given request must be retried.
     *          // use this.attemptCount value to determine if the function should return true or false
     *      };
     *      StrategyHolder.prototype.calculateNextDelay = function() {
     *          // this function must return the next delay time {Number}
     *          // use this.attemptCount value to determine the next delay value
     *      };
     *      retryInterceptor.register(customPredicate, StrategyHolder);
     * ```
     */
    register(predicate, retryStrategy) {
        if (typeof predicate !== 'function') {
            throw new Error('retryInterceptor.register error: predicate must be a function');
        }
        if (typeof retryStrategy !== 'function') {
            throw new Error('retryInterceptor.register error: retryStrategy must be a function');
        }
        this.predicatesRegistry.unshift({
            predicate,
            retryStrategy
        });
        return this;
    }
    /**
     * Find a matching strategy for the given response and (optional) operationContext
     * If not provided, the default operationContext is OPERATION_CONTEXT.INTERACTIVE
     *
     * @param {Object} response The http response object
     *
     * @return {Function} The matching retryStrategy
     */
    findMatchingStrategy(request, response) {
        const operationContext = this.operationContextService.findOperationContext(request.url) ||
            this.OPERATION_CONTEXT.INTERACTIVE;
        const matchStrategy = this.predicatesRegistry.find((predicateObj) => {
            return predicateObj.predicate(request, response, operationContext);
        });
        return matchStrategy ? matchStrategy.retryStrategy : null;
    }
    handleRetry(retryStrategy, request, response) {
        retryStrategy.attemptCount++;
        if (retryStrategy.canRetry()) {
            const delay = retryStrategy.firstFastRetry ? 0 : retryStrategy.calculateNextDelay();
            retryStrategy.firstFastRetry = false;
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    this.httpClient
                        .request(request)
                        .toPromise()
                        .then((result) => {
                        this.removeRetryStrategy(request);
                        return resolve(result);
                    }, (error) => reject(error));
                }, delay);
            });
        }
        else {
            this.alertService.showDanger({
                message: this.translate.instant(this.TRANSLATE_NAMESPACE + 'somethingwrong')
            });
            return Promise.reject(response);
        }
    }
    storeRetryStrategy(request, retryStrategy) {
        this.requestToRetryTegistry[this.getRequestUUID(request)] = retryStrategy;
    }
    removeRetryStrategy(request) {
        delete this.requestToRetryTegistry[this.getRequestUUID(request)];
    }
    retrieveRetryStrategy(request) {
        return this.requestToRetryTegistry[this.getRequestUUID(request)];
    }
    getRequestUUID(request) {
        return request.clone().toString();
    }
};
RetryInterceptor.ctorParameters = () => [
    { type: HttpClient },
    { type: TranslateService },
    { type: OperationContextService },
    { type: IAlertService },
    { type: BooleanUtils },
    { type: undefined, decorators: [{ type: Inject, args: [DefaultRetryStrategy,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [ExponentialRetryStrategy,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [LinearRetryStrategy,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [OPERATION_CONTEXT_TOKEN,] }] }
];
RetryInterceptor = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(5, Inject(DefaultRetryStrategy)),
    tslib_1.__param(6, Inject(ExponentialRetryStrategy)),
    tslib_1.__param(7, Inject(LinearRetryStrategy)),
    tslib_1.__param(8, Inject(OPERATION_CONTEXT_TOKEN)),
    tslib_1.__metadata("design:paramtypes", [HttpClient,
        TranslateService,
        OperationContextService,
        IAlertService,
        BooleanUtils, Object, Object, Object, Object])
], RetryInterceptor);
export { RetryInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV0cnkuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ac21hcnQvdXRpbHMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9pbnRlcmNlcHRvcnMvZXJyb3JzL3JldHJ5LmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7QUFDSCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHOUMsT0FBTyxFQUNILG9CQUFvQixFQUNwQixrQ0FBa0MsRUFDbEMsYUFBYSxFQUNiLHVCQUF1QixFQUN2QixvQkFBb0IsRUFDcEIscUJBQXFCLEVBQ3JCLG9CQUFvQixFQUNwQix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLG1CQUFtQixFQUNuQix1QkFBdUIsRUFDMUIsTUFBTSxXQUFXLENBQUM7QUFTbkIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRWxELE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFHLEdBQUcsWUFBWSxvQkFBb0IsQ0FBQztBQUUzRTs7Ozs7OztHQU9HO0FBRUgsSUFBYSxnQkFBZ0IsR0FBN0IsTUFBYSxnQkFBZ0I7SUFVekIsWUFDWSxVQUFzQixFQUN0QixTQUEyQixFQUMzQix1QkFBZ0QsRUFDaEQsWUFBMkIsRUFDbkMsWUFBMEIsRUFDSSxvQkFBMkMsRUFDdkMsd0JBQStDLEVBQ3BELG1CQUEwQyxFQUM5QixpQkFBbUM7UUFScEUsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixjQUFTLEdBQVQs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Z0JBQWdCLENBd0s1QjtTQXhLWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxOSBTQVAgU0Ugb3IgYW4gU0FQIGFmZmlsaWF0ZSBjb21wYW55LiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogQG1vZHVsZSBzbWFydHV0aWxzXG4gKi9cbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBSZXF1ZXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgSUFsZXJ0U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQm9vbGVhblV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgVHlwZWRNYXAgfSBmcm9tICcuLi8uLi8uLi9kdG9zJztcbmltcG9ydCB7IENsYXNzIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHtcbiAgICBjbGllbnRFcnJvclByZWRpY2F0ZSxcbiAgICBub0ludGVybmV0Q29ubmVjdGlvbkVycm9yUHJlZGljYXRlLFxuICAgIHJlYWRQcmVkaWNhdGUsXG4gICAgcmV0cmlhYmxlRXJyb3JQcmVkaWNhdGUsXG4gICAgc2VydmVyRXJyb3JQcmVkaWNhdGUsXG4gICAgdGltZW91dEVycm9yUHJlZGljYXRlLFxuICAgIERlZmF1bHRSZXRyeVN0cmF0ZWd5LFxuICAgIEV4cG9uZW50aWFsUmV0cnlTdHJhdGVneSxcbiAgICBJUmV0cnlTdHJhdGVneSxcbiAgICBMaW5lYXJSZXRyeVN0cmF0ZWd5LFxuICAgIE9wZXJhdGlvbkNvbnRleHRTZXJ2aWNlXG59IGZyb20gJy4vcmV0cmllcyc7XG5pbXBvcnQgeyBJSHR0cEVycm9ySW50ZXJjZXB0b3IgfSBmcm9tICcuLi9pLWh0dHAtZXJyb3IuaW50ZXJjZXB0b3InO1xuXG5leHBvcnQgdHlwZSBSZXRyeVByZWRpY2F0ZSA9IChcbiAgICByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgIHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSxcbiAgICBvcGVyYXRpb25Db250ZXh0Pzogc3RyaW5nXG4pID0+IGJvb2xlYW47XG5cbmltcG9ydCB7IExJQlJBUllfTkFNRSB9IGZyb20gJy4uLy4uLy4uL2NvbnN0YW50cyc7XG5cbmV4cG9ydCBjb25zdCBPUEVSQVRJT05fQ09OVEVYVF9UT0tFTiA9IGAke0xJQlJBUllfTkFNRX1fT1BFUkFUSU9OX0NPTlRFWFRgO1xuXG4vKipcbiAqIEBuZ2RvYyBzZXJ2aWNlXG4gKiBAbmFtZSBAc21hcnR1dGlscy5zZXJ2aWNlczpyZXRyeUludGVyY2VwdG9yXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGUgcmV0cnlJbnRlcmNlcHRvciBwcm92aWRlcyB0aGUgZnVuY3Rpb25hbGl0eSB0byByZWdpc3RlciBhIHNldCBvZiBwcmVkaWNhdGVzIHdpdGggdGhlaXIgYXNzb2NpYXRlZCByZXRyeSBzdHJhdGVnaWVzLlxuICogRWFjaCB0aW1lIGFuIEhUVFAgcmVxdWVzdCBmYWlscywgdGhlIHNlcnZpY2UgdHJ5IHRvIGZpbmQgYSBtYXRjaGluZyByZXRyeSBzdHJhdGVneSBmb3IgdGhlIGdpdmVuIHJlc3BvbnNlLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUmV0cnlJbnRlcmNlcHRvcjxUID0gYW55PiBpbXBsZW1lbnRzIElIdHRwRXJyb3JJbnRlcmNlcHRvcjxUPiB7XG4gICAgcHJpdmF0ZSBUUkFOU0xBVEVfTkFNRVNQQUNFID0gJ3NlLmdyYWNlZnVsZGVncmFkYXRpb24uJztcblxuICAgIHByaXZhdGUgcHJlZGljYXRlc1JlZ2lzdHJ5OiB7XG4gICAgICAgIHByZWRpY2F0ZTogUmV0cnlQcmVkaWNhdGU7XG4gICAgICAgIHJldHJ5U3RyYXRlZ3k6IENsYXNzPElSZXRyeVN0cmF0ZWd5PjtcbiAgICB9W10gPSBbXTtcblxuICAgIHByaXZhdGUgcmVxdWVzdFRvUmV0cnlUZWdpc3RyeTogVHlwZWRNYXA8SVJldHJ5U3RyYXRlZ3k+ID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBvcGVyYXRpb25Db250ZXh0U2VydmljZTogT3BlcmF0aW9uQ29udGV4dFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBJQWxlcnRTZXJ2aWNlLFxuICAgICAgICBib29sZWFuVXRpbHM6IEJvb2xlYW5VdGlscyxcbiAgICAgICAgQEluamVjdChEZWZhdWx0UmV0cnlTdHJhdGVneSkgZGVmYXVsdFJldHJ5U3RyYXRlZ3k6IENsYXNzPElSZXRyeVN0cmF0ZWd5PixcbiAgICAgICAgQEluamVjdChFeHBvbmVudGlhbFJldHJ5U3RyYXRlZ3kpIGV4cG9uZW50aWFsUmV0cnlTdHJhdGVneTogQ2xhc3M8SVJldHJ5U3RyYXRlZ3k+LFxuICAgICAgICBASW5qZWN0KExpbmVhclJldHJ5U3RyYXRlZ3kpIGxpbmVhclJldHJ5U3RyYXRlZ3k6IENsYXNzPElSZXRyeVN0cmF0ZWd5PixcbiAgICAgICAgQEluamVjdChPUEVSQVRJT05fQ09OVEVYVF9UT0tFTikgcHJpdmF0ZSBPUEVSQVRJT05fQ09OVEVYVDogVHlwZWRNYXA8c3RyaW5nPlxuICAgICkge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyKG5vSW50ZXJuZXRDb25uZWN0aW9uRXJyb3JQcmVkaWNhdGUsIGV4cG9uZW50aWFsUmV0cnlTdHJhdGVneSlcbiAgICAgICAgICAgIC5yZWdpc3RlcihcbiAgICAgICAgICAgICAgICBib29sZWFuVXRpbHMuaXNBbnlUcnV0aHkoY2xpZW50RXJyb3JQcmVkaWNhdGUsIHRpbWVvdXRFcnJvclByZWRpY2F0ZSksXG4gICAgICAgICAgICAgICAgZGVmYXVsdFJldHJ5U3RyYXRlZ3lcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5yZWdpc3RlcihcbiAgICAgICAgICAgICAgICBib29sZWFuVXRpbHMuYXJlQWxsVHJ1dGh5KHJlYWRQcmVkaWNhdGUsIHJldHJpYWJsZUVycm9yUHJlZGljYXRlKSxcbiAgICAgICAgICAgICAgICBkZWZhdWx0UmV0cnlTdHJhdGVneVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnJlZ2lzdGVyKHNlcnZlckVycm9yUHJlZGljYXRlLCBleHBvbmVudGlhbFJldHJ5U3RyYXRlZ3kpO1xuICAgIH1cblxuICAgIHByZWRpY2F0ZShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxUPiwgcmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbmRNYXRjaGluZ1N0cmF0ZWd5KHJlcXVlc3QsIHJlc3BvbnNlKSAhPT0gbnVsbDtcbiAgICB9XG5cbiAgICByZXNwb25zZUVycm9yKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PFQ+LCByZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBsZXQgcmV0cnlTdHJhdGVneSA9IHRoaXMucmV0cmlldmVSZXRyeVN0cmF0ZWd5KHJlcXVlc3QpO1xuICAgICAgICBpZiAoIXJldHJ5U3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIGNvbnN0IFN0cmF0ZWd5SG9sZGVyID0gdGhpcy5maW5kTWF0Y2hpbmdTdHJhdGVneShyZXF1ZXN0LCByZXNwb25zZSk7XG4gICAgICAgICAgICBpZiAoU3RyYXRlZ3lIb2xkZXIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5zaG93V2FybmluZyh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5UUkFOU0xBVEVfTkFNRVNQQUNFICsgJ3N0aWxsd29ya2luZycpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0cnlTdHJhdGVneSA9IG5ldyBTdHJhdGVneUhvbGRlcigpO1xuICAgICAgICAgICAgICAgIHJldHJ5U3RyYXRlZ3kuYXR0ZW1wdENvdW50ID0gMDtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlUmV0cnlTdHJhdGVneShyZXF1ZXN0LCByZXRyeVN0cmF0ZWd5KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVSZXRyeShyZXRyeVN0cmF0ZWd5LCByZXF1ZXN0LCByZXNwb25zZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG5nZG9jIG1ldGhvZFxuICAgICAqIEBuYW1lIEBzbWFydHV0aWxzLnNlcnZpY2VzOnJldHJ5SW50ZXJjZXB0b3IjcmVnaXN0ZXJcbiAgICAgKiBAbWV0aG9kT2YgQHNtYXJ0dXRpbHMuc2VydmljZXM6cmV0cnlJbnRlcmNlcHRvclxuICAgICAqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmVnaXN0ZXIgYSBuZXcgcHJlZGljYXRlIHdpdGggaXQncyBhc3NvY2lhdGVkIHN0cmF0ZWd5SG9sZGVyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZGljYXRlIFRoaXMgZnVuY3Rpb24gdGFrZXMgdGhlICdyZXNwb25zZScge09iamVjdH0gYXJndW1lbnQgYW5kIGFuIChvcHRpb25hbCkgb3BlcmF0aW9uQ29udGV4dCB7U3RyaW5nfS4gVGhpcyBmdW5jdGlvbiBtdXN0IHJldHVybiBhIEJvb2xlYW4gdGhhdCBpcyB0cnVlIGlmIHRoZSBnaXZlbiByZXNwb25zZSBtYXRjaCB0aGUgcHJlZGljYXRlLlxuICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHJldHJ5U3RyYXRlZ3kgVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGluc3RhbmNpYXRlZCBhdCBydW4tdGltZS4gU2VlIHtAbGluayBAc21hcnR1dGlscy5zZXJ2aWNlczpJUmV0cnlTdHJhdGVneSBJUmV0cnlTdHJhdGVneX0uXG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IHJldHJ5SW50ZXJjZXB0b3IgVGhlIHJldHJ5SW50ZXJjZXB0b3Igc2VydmljZS5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogYGBganNcbiAgICAgKiAgICAgIHZhciBjdXN0b21QcmVkaWNhdGUgPSBmdW5jdGlvbihyZXF1ZXN0LCByZXNwb25zZSwgb3BlcmF0aW9uQ29udGV4dCkge1xuICAgICAqICAgICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMgPT09IDUwMCAmJiBvcGVyYXRpb25Db250ZXh0ID09PSBPUEVSQVRJT05fQ09OVEVYVC5UT09MSU5HO1xuICAgICAqICAgICAgfTtcbiAgICAgKiAgICAgIHZhciBTdHJhdGVneUhvbGRlciA9IGZ1bmN0aW9uKCkge1xuICAgICAqICAgICAgICAgIC8vIHNldCB0aGUgZmlyc3RGYXN0UmV0cnkgdmFsdWUgdG8gdHJ1ZSBmb3IgdGhlIHJldHJ5IG1hZGUgaW1tZWRpYXRlbHkgb25seSBmb3IgdGhlIHZlcnkgZmlyc3QgcmV0cnkgKHN1YnNlcXVlbnQgcmV0cmllcyB3aWxsIHJlbWFpbiBzdWJqZWN0IHRvIHRoZSBjYWxjdWxhdGVOZXh0RGVsYXkgcmVzcG9uc2UpXG4gICAgICogICAgICAgICAgdGhpcy5maXJzdEZhc3RSZXRyeSA9IHRydWU7XG4gICAgICogICAgICB9O1xuICAgICAqICAgICAgU3RyYXRlZ3lIb2xkZXIucHJvdG90eXBlLmNhblJldHJ5ID0gZnVuY3Rpb24oKSB7XG4gICAgICogICAgICAgICAgLy8gdGhpcyBmdW5jdGlvbiBtdXN0IHJldHVybiBhIHtCb29sZWFufSBpZiB0aGUgZ2l2ZW4gcmVxdWVzdCBtdXN0IGJlIHJldHJpZWQuXG4gICAgICogICAgICAgICAgLy8gdXNlIHRoaXMuYXR0ZW1wdENvdW50IHZhbHVlIHRvIGRldGVybWluZSBpZiB0aGUgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0cnVlIG9yIGZhbHNlXG4gICAgICogICAgICB9O1xuICAgICAqICAgICAgU3RyYXRlZ3lIb2xkZXIucHJvdG90eXBlLmNhbGN1bGF0ZU5leHREZWxheSA9IGZ1bmN0aW9uKCkge1xuICAgICAqICAgICAgICAgIC8vIHRoaXMgZnVuY3Rpb24gbXVzdCByZXR1cm4gdGhlIG5leHQgZGVsYXkgdGltZSB7TnVtYmVyfVxuICAgICAqICAgICAgICAgIC8vIHVzZSB0aGlzLmF0dGVtcHRDb3VudCB2YWx1ZSB0byBkZXRlcm1pbmUgdGhlIG5leHQgZGVsYXkgdmFsdWVcbiAgICAgKiAgICAgIH07XG4gICAgICogICAgICByZXRyeUludGVyY2VwdG9yLnJlZ2lzdGVyKGN1c3RvbVByZWRpY2F0ZSwgU3RyYXRlZ3lIb2xkZXIpO1xuICAgICAqIGBgYFxuICAgICAqL1xuICAgIHJlZ2lzdGVyKHByZWRpY2F0ZTogUmV0cnlQcmVkaWNhdGUsIHJldHJ5U3RyYXRlZ3k6IENsYXNzPElSZXRyeVN0cmF0ZWd5Pik6IFJldHJ5SW50ZXJjZXB0b3I8VD4ge1xuICAgICAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdyZXRyeUludGVyY2VwdG9yLnJlZ2lzdGVyIGVycm9yOiBwcmVkaWNhdGUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiByZXRyeVN0cmF0ZWd5ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3JldHJ5SW50ZXJjZXB0b3IucmVnaXN0ZXIgZXJyb3I6IHJldHJ5U3RyYXRlZ3kgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcmVkaWNhdGVzUmVnaXN0cnkudW5zaGlmdCh7XG4gICAgICAgICAgICBwcmVkaWNhdGUsXG4gICAgICAgICAgICByZXRyeVN0cmF0ZWd5XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGaW5kIGEgbWF0Y2hpbmcgc3RyYXRlZ3kgZm9yIHRoZSBnaXZlbiByZXNwb25zZSBhbmQgKG9wdGlvbmFsKSBvcGVyYXRpb25Db250ZXh0XG4gICAgICogSWYgbm90IHByb3ZpZGVkLCB0aGUgZGVmYXVsdCBvcGVyYXRpb25Db250ZXh0IGlzIE9QRVJBVElPTl9DT05URVhULklOVEVSQUNUSVZFXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgVGhlIGh0dHAgcmVzcG9uc2Ugb2JqZWN0XG4gICAgICpcbiAgICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIG1hdGNoaW5nIHJldHJ5U3RyYXRlZ3lcbiAgICAgKi9cbiAgICBwcml2YXRlIGZpbmRNYXRjaGluZ1N0cmF0ZWd5KFxuICAgICAgICByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgICAgICByZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2VcbiAgICApOiBDbGFzczxJUmV0cnlTdHJhdGVneT4gfCBudWxsIHtcbiAgICAgICAgY29uc3Qgb3BlcmF0aW9uQ29udGV4dCA9XG4gICAgICAgICAgICB0aGlzLm9wZXJhdGlvbkNvbnRleHRTZXJ2aWNlLmZpbmRPcGVyYXRpb25Db250ZXh0KHJlcXVlc3QudXJsKSB8fFxuICAgICAgICAgICAgdGhpcy5PUEVSQVRJT05fQ09OVEVYVC5JTlRFUkFDVElWRTtcbiAgICAgICAgY29uc3QgbWF0Y2hTdHJhdGVneSA9IHRoaXMucHJlZGljYXRlc1JlZ2lzdHJ5LmZpbmQoKHByZWRpY2F0ZU9iaikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHByZWRpY2F0ZU9iai5wcmVkaWNhdGUocmVxdWVzdCwgcmVzcG9uc2UsIG9wZXJhdGlvbkNvbnRleHQpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1hdGNoU3RyYXRlZ3kgPyBtYXRjaFN0cmF0ZWd5LnJldHJ5U3RyYXRlZ3kgOiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlUmV0cnkoXG4gICAgICAgIHJldHJ5U3RyYXRlZ3k6IElSZXRyeVN0cmF0ZWd5LFxuICAgICAgICByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LFxuICAgICAgICByZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2VcbiAgICApOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXRyeVN0cmF0ZWd5LmF0dGVtcHRDb3VudCsrO1xuICAgICAgICBpZiAocmV0cnlTdHJhdGVneS5jYW5SZXRyeSgpKSB7XG4gICAgICAgICAgICBjb25zdCBkZWxheSA9IHJldHJ5U3RyYXRlZ3kuZmlyc3RGYXN0UmV0cnkgPyAwIDogcmV0cnlTdHJhdGVneS5jYWxjdWxhdGVOZXh0RGVsYXkoKTtcbiAgICAgICAgICAgIHJldHJ5U3RyYXRlZ3kuZmlyc3RGYXN0UmV0cnkgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcXVlc3QocmVxdWVzdClcbiAgICAgICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlUmV0cnlTdHJhdGVneShyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChlcnJvcjogYW55KSA9PiByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0sIGRlbGF5KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc2hvd0Rhbmdlcih7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogdGhpcy50cmFuc2xhdGUuaW5zdGFudCh0aGlzLlRSQU5TTEFURV9OQU1FU1BBQ0UgKyAnc29tZXRoaW5nd3JvbmcnKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVzcG9uc2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdG9yZVJldHJ5U3RyYXRlZ3kocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgcmV0cnlTdHJhdGVneTogSVJldHJ5U3RyYXRlZ3kpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0VG9SZXRyeVRlZ2lzdHJ5W3RoaXMuZ2V0UmVxdWVzdFVVSUQocmVxdWVzdCldID0gcmV0cnlTdHJhdGVneTtcbiAgICB9XG4gICAgcHJpdmF0ZSByZW1vdmVSZXRyeVN0cmF0ZWd5KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiB2b2lkIHtcbiAgICAgICAgZGVsZXRlIHRoaXMucmVxdWVzdFRvUmV0cnlUZWdpc3RyeVt0aGlzLmdldFJlcXVlc3RVVUlEKHJlcXVlc3QpXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJldHJpZXZlUmV0cnlTdHJhdGVneShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSVJldHJ5U3RyYXRlZ3kge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0VG9SZXRyeVRlZ2lzdHJ5W3RoaXMuZ2V0UmVxdWVzdFVVSUQocmVxdWVzdCldO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVxdWVzdFVVSUQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiByZXF1ZXN0LmNsb25lKCkudG9TdHJpbmcoKTtcbiAgICB9XG59XG4iXX0=