/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
var CacheEngine_1;
import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Injectable } from '@angular/core';
import { Deferred, PromiseUtils, WindowUtils } from '../../../utils';
import { LogService } from '../../log.service';
/** @internal */
let CacheEngine = CacheEngine_1 = class CacheEngine {
    constructor(windowUtils, promiseUtils, logService) {
        this.windowUtils = windowUtils;
        this.promiseUtils = promiseUtils;
        this.logService = logService;
        this.cachedItemsRegistry = [];
        this.startBackgroundMonitoringJob();
    }
    addItem(item, cacheTiming, refresh) {
        if (this.getItemIndex(item) === -1) {
            this.cachedItemsRegistry.push({
                item,
                cacheTiming,
                refresh,
                completed: false,
                processing: false,
                defer: this.promiseUtils.defer()
            });
        }
        else {
            this.logService.warn(`CacheEngine - item already exist for id: ${item.id}`);
        }
    }
    getItemById(id) {
        const match = this.cachedItemsRegistry.find((obj) => obj.item.id === id);
        return match ? match.item : null;
    }
    handle(item) {
        const obj = this.cachedItemsRegistry[this.getItemIndex(item)];
        if (obj.completed && !this.hasExpired(item)) {
            obj.defer.resolve(item.cache);
        }
        else if (!obj.processing) {
            obj.processing = true;
            this.refreshCache(obj);
        }
        return obj.defer.promise;
    }
    evict(...tags) {
        tags.forEach((tag) => {
            this.cachedItemsRegistry
                .filter((obj) => obj.item.evictionTags.indexOf(tag) > -1)
                .forEach((obj) => this.cachedItemsRegistry.splice(this.getItemIndex(obj.item), 1));
        });
    }
    // regularly go though cache data and call prebound methods to refresh data when needed.
    startBackgroundMonitoringJob() {
        this.windowUtils.runIntervalOutsideAngular(() => {
            return Promise.all(this.cachedItemsRegistry
                .filter((obj) => this.needRefresh(obj.item))
                .map((obj) => this.refreshCache(obj)));
        }, CacheEngine_1.BACKGROUND_REFRESH_INTERVAL);
    }
    refreshCache(obj) {
        return obj.refresh().then((value) => {
            // TODO: read value.metadata to refresh expiry/refresh ages.
            obj.cacheTiming.setAge(obj.item);
            obj.item.cache = value;
            obj.item.timestamp = new Date().getTime();
            obj.completed = true;
            obj.processing = false;
            obj.defer.resolve(value);
        }, (e) => {
            this.logService.debug(`CacheEngine - unable to refresh cache for id: ${obj.item.id}`, e);
            delete obj.item.cache;
            obj.defer.resolve(e);
        });
    }
    hasExpired(item) {
        return item.timestamp + item.expirationAge <= new Date().getTime();
    }
    needRefresh(item) {
        return item.timestamp + item.refreshAge <= new Date().getTime();
    }
    getItemIndex(item) {
        return this.cachedItemsRegistry.findIndex((o) => o.item.id === item.id);
    }
};
CacheEngine.BACKGROUND_REFRESH_INTERVAL = 10000;
CacheEngine.ctorParameters = () => [
    { type: WindowUtils },
    { type: PromiseUtils },
    { type: LogService }
];
CacheEngine = CacheEngine_1 = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [WindowUtils,
        PromiseUtils,
        LogService])
], CacheEngine);
export { CacheEngine };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtZW5naW5lLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHNtYXJ0L3V0aWxzLyIsInNvdXJjZXMiOlsic2VydmljZXMvY2FjaGUvZW5naW5lL2NhY2hlLWVuZ2luZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7R0FHRztBQUNILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBYy9DLGdCQUFnQjtBQUVoQixJQUFhLFdBQVcsbUJBQXhCLE1BQWEsV0FBVztJQUlwQixZQUNZLFdBQXdCLEVBQ3hCLFlBQTBCLEVBQzFCLFVBQXNCO1FBRnRCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFMMUIsd0JBQW1CLEdBQXlCLEVBQUUsQ0FBQztRQU9uRCxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRU0sT0FBTyxDQUNWLElBQXFCLEVBQ3JCLFdBQXlCLEVBQ3pCLE9BQTRCO1FBRTVCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNoQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDO2dCQUMxQixJQUFJO2dCQUNKLFdBQVc7Z0JBQ1gsT0FBTztnQkFDUCxTQUFTLEVBQUUsS0FBSztnQkFDaEIsVUFBVSxFQUFFLEtBQUs7Z0JBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRTthQUNuQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsNENBQTRDLElBQUksQ0FBQyxFQUFFLEVB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QUFDLEVBQ0QsQ0FBQyxDQUFNLEVBQUUsRUFBRTtZQUNQLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUNqQixpREFBaUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFDOUQsQ0FBQyxDQUNKLENBQUM7WUFDRixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3RCLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FDSixDQUFDO0lBQ04sQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFxQjtRQUNwQyxPQUFPLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3ZFLENBQUM7SUFFTyxXQUFXLENBQUMsSUFBcUI7UUFDckMsT0FBTyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNwRSxDQUFDO0lBRU8sWUFBWSxDQUFDLElBQXFCO1FBQ3RDLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLENBQUM7Q0FDSixDQUFBO0FBbEcwQix1Q0FBMkIsR0FBVyxLQUFLLENBQUM7O1lBSTFDLFdBQVc7WUFDVixZQUFZO1lBQ2QsVUFBVTs7QUFQekIsV0FBVztJQUR2QixVQUFVLEVBQUU7NkNBTWdCLFdBQVc7UUFDVixZQUFZO1FBQ2QsVUFBVTtHQVB6QixXQUFXLENBbUd2QjtTQW5HWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEZWZlcnJlZCwgUHJvbWlzZVV0aWxzLCBXaW5kb3dVdGlscyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9sb2cuc2VydmljZSc7XG5cbmltcG9ydCB7IElDYWNoZUl0ZW0sIElDYWNoZVRpbWluZywgSU1ldGFkYXRhIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGludGVyZmFjZSBJQ2FjaGVJdGVtUmVnaXN0cnkge1xuICAgIGl0ZW06IElDYWNoZUl0ZW08YW55PjtcbiAgICBjYWNoZVRpbWluZzogSUNhY2hlVGltaW5nO1xuICAgIGNvbXBsZXRlZDogYm9vbGVhbjtcbiAgICBwcm9jZXNzaW5nOiBib29sZWFuO1xuICAgIGRlZmVyOiBEZWZlcnJlZDxhbnk+O1xuICAgIHJlZnJlc2g8VD4oKTogUHJvbWlzZTxUPjtcbn1cblxuLyoqIEBpbnRlcm5hbCAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhY2hlRW5naW5lIHtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEJBQ0tHUk9VTkRfUkVGUkVTSF9JTlRFUlZBTDogbnVtYmVyID0gMTAwMDA7XG4gICAgcHJpdmF0ZSBjYWNoZWRJdGVtc1JlZ2lzdHJ5OiBJQ2FjaGVJdGVtUmVnaXN0cnlbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgd2luZG93VXRpbHM6IFdpbmRvd1V0aWxzLFxuICAgICAgICBwcml2YXRlIHByb21pc2VVdGlsczogUHJvbWlzZVV0aWxzLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IExvZ1NlcnZpY2VcbiAgICApIHtcbiAgICAgICAgdGhpcy5zdGFydEJhY2tncm91bmRNb25pdG9yaW5nSm9iKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEl0ZW0oXG4gICAgICAgIGl0ZW06IElDYWNoZUl0ZW08YW55PixcbiAgICAgICAgY2FjaGVUaW1pbmc6IElDYWNoZVRpbWluZyxcbiAgICAgICAgcmVmcmVzaDogPFQ+KCkgPT4gUHJvbWlzZTxUPlxuICAgICk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5nZXRJdGVtSW5kZXgoaXRlbSkgPT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnkucHVzaCh7XG4gICAgICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgICAgICBjYWNoZVRpbWluZyxcbiAgICAgICAgICAgICAgICByZWZyZXNoLFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgZGVmZXI6IHRoaXMucHJvbWlzZVV0aWxzLmRlZmVyKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLndhcm4oYENhY2hlRW5naW5lIC0gaXRlbSBhbHJlYWR5IGV4aXN0IGZvciBpZDogJHtpdGVtLmlkfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldEl0ZW1CeUlkKGlkOiBzdHJpbmcpOiBJQ2FjaGVJdGVtPGFueT4gfCBudWxsIHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnkuZmluZCgob2JqKSA9PiBvYmouaXRlbS5pZCA9PT0gaWQpO1xuICAgICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaC5pdGVtIDogbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgaGFuZGxlPFQ+KGl0ZW06IElDYWNoZUl0ZW08YW55Pik6IFByb21pc2U8VD4ge1xuICAgICAgICBjb25zdCBvYmogPSB0aGlzLmNhY2hlZEl0ZW1zUmVnaXN0cnlbdGhpcy5nZXRJdGVtSW5kZXgoaXRlbSldO1xuICAgICAgICBpZiAob2JqLmNvbXBsZXRlZCAmJiAhdGhpcy5oYXNFeHBpcmVkKGl0ZW0pKSB7XG4gICAgICAgICAgICBvYmouZGVmZXIucmVzb2x2ZShpdGVtLmNhY2hlKTtcbiAgICAgICAgfSBlbHNlIGlmICghb2JqLnByb2Nlc3NpbmcpIHtcbiAgICAgICAgICAgIG9iai5wcm9jZXNzaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaENhY2hlKG9iaik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9iai5kZWZlci5wcm9taXNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBldmljdCguLi50YWdzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICB0YWdzLmZvckVhY2goKHRhZykgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5XG4gICAgICAgICAgICAgICAgLmZpbHRlcigob2JqKSA9PiBvYmouaXRlbS5ldmljdGlvblRhZ3MuaW5kZXhPZih0YWcpID4gLTEpXG4gICAgICAgICAgICAgICAgLmZvckVhY2goKG9iaikgPT4gdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5LnNwbGljZSh0aGlzLmdldEl0ZW1JbmRleChvYmouaXRlbSksIDEpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gcmVndWxhcmx5IGdvIHRob3VnaCBjYWNoZSBkYXRhIGFuZCBjYWxsIHByZWJvdW5kIG1ldGhvZHMgdG8gcmVmcmVzaCBkYXRhIHdoZW4gbmVlZGVkLlxuICAgIHByb3RlY3RlZCBzdGFydEJhY2tncm91bmRNb25pdG9yaW5nSm9iKCk6IHZvaWQge1xuICAgICAgICB0aGlzLndpbmRvd1V0aWxzLnJ1bkludGVydmFsT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGVkSXRlbXNSZWdpc3RyeVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChvYmopID0+IHRoaXMubmVlZFJlZnJlc2gob2JqLml0ZW0pKVxuICAgICAgICAgICAgICAgICAgICAubWFwKChvYmopID0+IHRoaXMucmVmcmVzaENhY2hlKG9iaikpXG4gICAgICAgICAgICApO1xuICAgICAgICB9LCBDYWNoZUVuZ2luZS5CQUNLR1JPVU5EX1JFRlJFU0hfSU5URVJWQUwpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCByZWZyZXNoQ2FjaGU8VD4ob2JqOiBJQ2FjaGVJdGVtUmVnaXN0cnkpOiBQcm9taXNlPFQgfCB2b2lkPiB7XG4gICAgICAgIHJldHVybiBvYmoucmVmcmVzaDxJTWV0YWRhdGE+KCkudGhlbihcbiAgICAgICAgICAgICh2YWx1ZTogSU1ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gVE9ETzogcmVhZCB2YWx1ZS5tZXRhZGF0YSB0byByZWZyZXNoIGV4cGlyeS9yZWZyZXNoIGFnZXMuXG4gICAgICAgICAgICAgICAgb2JqLmNhY2hlVGltaW5nLnNldEFnZShvYmouaXRlbSk7XG4gICAgICAgICAgICAgICAgb2JqLml0ZW0uY2FjaGUgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBvYmouaXRlbS50aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBvYmouY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBvYmoucHJvY2Vzc2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIG9iai5kZWZlci5yZXNvbHZlKHZhbHVlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmRlYnVnKFxuICAgICAgICAgICAgICAgICAgICBgQ2FjaGVFbmdpbmUgLSB1bmFibGUgdG8gcmVmcmVzaCBjYWNoZSBmb3IgaWQ6ICR7b2JqLml0ZW0uaWR9YCxcbiAgICAgICAgICAgICAgICAgICAgZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9iai5pdGVtLmNhY2hlO1xuICAgICAgICAgICAgICAgIG9iai5kZWZlci5yZXNvbHZlKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzRXhwaXJlZChpdGVtOiBJQ2FjaGVJdGVtPGFueT4pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGl0ZW0udGltZXN0YW1wICsgaXRlbS5leHBpcmF0aW9uQWdlIDw9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbmVlZFJlZnJlc2goaXRlbTogSUNhY2hlSXRlbTxhbnk+KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBpdGVtLnRpbWVzdGFtcCArIGl0ZW0ucmVmcmVzaEFnZSA8PSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEl0ZW1JbmRleChpdGVtOiBJQ2FjaGVJdGVtPGFueT4pOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZWRJdGVtc1JlZ2lzdHJ5LmZpbmRJbmRleCgobykgPT4gby5pdGVtLmlkID09PSBpdGVtLmlkKTtcbiAgICB9XG59XG4iXX0=