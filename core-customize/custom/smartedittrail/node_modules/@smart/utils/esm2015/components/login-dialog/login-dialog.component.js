import * as tslib_1 from "tslib";
/**
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
/**
 * Copyright (c) 2019 SAP SE or an SAP affiliate company. All rights reserved.
 * @module smartutils
 */
import { Component, HostBinding, Inject, Optional } from '@angular/core';
import { FormControl, FormGroup, Validators } from '@angular/forms';
import { HttpClient, HttpErrorResponse, HttpHeaders, HttpResponse } from '@angular/common/http';
import { ModalRef } from '@fundamental-ngx/core';
import { StringUtils, UrlUtils } from '../../utils';
import { LogService } from '../../services/log.service';
import { IAuthToken, ILoginData, ILoginModalFeedback, ISessionService, IStorageService } from '../../interfaces';
import { SSOAuthenticationHelper } from '../../services/authentication/sso-authentication.helper';
import { DEFAULT_AUTHENTICATION_ENTRY_POINT } from '../../constants';
import { LoginDialogResourceProvider } from './login-dialog-resource-provider';
let LoginDialogComponent = class LoginDialogComponent {
    constructor(modalRef, logService, httpClient, sessionService, storageService, stringUtils, urlUtils, ssoAuthenticationHelper, resource) {
        this.modalRef = modalRef;
        this.logService = logService;
        this.httpClient = httpClient;
        this.sessionService = sessionService;
        this.storageService = storageService;
        this.stringUtils = stringUtils;
        this.urlUtils = urlUtils;
        this.ssoAuthenticationHelper = ssoAuthenticationHelper;
        this.resource = resource;
        this.hostClass = true;
        this.data = null;
        this.authURIKey = '';
        this.authURI = '';
        this.isFullScreen = false;
        this.ssoEnabled = false;
        this.form = new FormGroup({
            username: new FormControl('', Validators.required),
            password: new FormControl('', Validators.required)
        });
        this.signinWithSSO = () => {
            this.form.setErrors(null);
            return this.ssoAuthenticationHelper
                .launchSSODialog()
                .then((data) => this.storeAccessToken(data), (error) => this.APIAuthenticationFailureReportFactory(error))
                .then((userHasChanged) => this.acceptUser(userHasChanged));
        };
        this.sendCredentials = (payload) => {
            return this.httpClient
                .request('POST', this.authURI, {
                headers: new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded'),
                body: this.urlUtils.getQueryString(payload).replace('?', ''),
                observe: 'response'
            })
                .toPromise();
        };
    }
    ngOnInit() {
        this.data = this.modalRef.data || {};
        this.authURI = this.data.authURI;
        this.isFullScreen = this.data.isFullScreen;
        this.ssoEnabled = this.data.ssoEnabled && this.isMainEndPoint();
        this.storageService.removeAuthToken(this.authURI);
        this.authURIKey = btoa(this.authURI).replace(/=/g, '');
        if (this.ssoAuthenticationHelper.isAutoSSOMain()) {
            this.signinWithSSO();
        }
    }
    signinWithCredentials() {
        this.form.setErrors(null);
        if (this.hasRequiredCredentialsError()) {
            this.form.setErrors({
                credentialsRequiredError: 'se.logindialogform.username.and.password.required'
            });
            return Promise.reject();
        }
        const payload = Object.assign({}, (this.data.clientCredentials || {}), { username: this.form.get('username').value, password: this.form.get('password').value, grant_type: 'password' });
        return this.sendCredentials(payload)
            .then((response) => this.storeAccessToken(response), (error) => this.APIAuthenticationFailureReportFactory(error))
            .then((hasUserChanged) => this.acceptUser(hasUserChanged));
    }
    isMainEndPoint() {
        return DEFAULT_AUTHENTICATION_ENTRY_POINT === this.authURI;
    }
    storeAccessToken(response) {
        const token = response instanceof HttpResponse ? response.body : response;
        this.storageService.storeAuthToken(this.authURI, token);
        this.logService.debug(`API Authentication Success: ${this.authURI}`);
        return this.isMainEndPoint()
            ? this.sessionService.hasUserChanged()
            : Promise.resolve(false);
    }
    APIAuthenticationFailureReportFactory(error) {
        this.logService.debug(`API Authentication Failure: ${this.authURI} status: ${error.status}`);
        this.form.setErrors({
            asyncValidationError: (error.error && this.stringUtils.sanitize(error.error.error_description)) ||
                'se.logindialogform.oauth.error.default'
        });
        return Promise.reject(error);
    }
    acceptUser(userHasChanged) {
        this.modalRef.close({
            userHasChanged
        });
        if (this.isMainEndPoint()) {
            this.sessionService.setCurrentUsername();
        }
        return Promise.resolve({ userHasChanged });
    }
    hasRequiredCredentialsError() {
        const username = this.form.get('username');
        const password = this.form.get('password');
        return ((username.errors && username.errors.required) ||
            (password.errors && password.errors.required));
    }
};
LoginDialogComponent.ctorParameters = () => [
    { type: ModalRef },
    { type: LogService },
    { type: HttpClient },
    { type: ISessionService },
    { type: IStorageService },
    { type: StringUtils },
    { type: UrlUtils },
    { type: SSOAuthenticationHelper },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LoginDialogResourceProvider,] }] }
];
tslib_1.__decorate([
    HostBinding('class.su-login-dialog'),
    tslib_1.__metadata("design:type", Boolean)
], LoginDialogComponent.prototype, "hostClass", void 0);
LoginDialogComponent = tslib_1.__decorate([
    Component({
        selector: 'su-login-dialog',
        template: "<div class=\"su-login\">\n    <div class=\"su-login--wrapper\">\n        <div\n            class=\"su-login--logo-wrapper\"\n            [ngClass]=\"{ 'su-login--logo-wrapper_full': !isFullScreen }\"\n        >\n            <img *ngIf=\"resource?.topLogoURL\" [src]=\"resource?.topLogoURL\" class=\"su-login--logo\" />\n            <span class=\"su-login--logo-text\" translate=\"se.application.name\"> </span>\n        </div>\n        <form\n            autocomplete=\"off\"\n            novalidate\n            [formGroup]=\"form\"\n            (submit)=\"signinWithCredentials()\"\n            class=\"su-login--form\"\n        >\n            <div class=\"su-login--auth-message\" *ngIf=\"isFullScreen\">\n                <div translate=\"se.logindialogform.reauth.message1\"></div>\n                <div translate=\"se.logindialogform.reauth.message2\"></div>\n            </div>\n\n            <!--Validation Errors-->\n            <div *ngIf=\"form.errors\" class=\"su-login--form-group\">\n                <fd-alert\n                    type=\"error\"\n                    class=\"su-login--alert-error\"\n                    id=\"invalidError\"\n                    [dismissible]=\"false\"\n                >\n                    <ng-container *ngIf=\"form.errors?.credentialsRequiredError\">\n                        {{ form.errors.credentialsRequiredError | translate }}\n                    </ng-container>\n\n                    <ng-container *ngIf=\"form.errors?.asyncValidationError\">\n                        {{ form.errors.asyncValidationError | translate }}\n                    </ng-container>\n                </fd-alert>\n            </div>\n\n            <div class=\"su-login--form-group\">\n                <input\n                    fd-form-control\n                    type=\"text\"\n                    id=\"username_{{ authURIKey }}\"\n                    name=\"username\"\n                    formControlName=\"username\"\n                    placeholder=\"{{ 'se.authentication.form.input.username' | translate }}\"\n                    autofocus\n                    autocomplete=\"username\"\n                />\n            </div>\n            <div class=\"su-login--form-group\">\n                <input\n                    fd-form-control\n                    type=\"password\"\n                    id=\"password_{{ authURIKey }}\"\n                    name=\"password\"\n                    placeholder=\"{{ 'se.authentication.form.input.password' | translate }}\"\n                    formControlName=\"password\"\n                    autocomplete=\"current-password\"\n                    required\n                />\n            </div>\n            <div class=\"su-login--form-group\">\n                <su-language-dropdown class=\"su-login-language\"></su-language-dropdown>\n            </div>\n            <button\n                fd-button\n                options=\"emphasized\"\n                class=\"su-login--btn\"\n                id=\"submit_{{ authURIKey }}\"\n                name=\"submit\"\n                type=\"submit\"\n                translate=\"se.authentication.form.button.submit\"\n            ></button>\n        </form>\n        <form\n            *ngIf=\"ssoEnabled\"\n            class=\"su-login--form-sso\"\n            name=\"loginDialogFormSSO\"\n            novalidate\n            (submit)=\"signinWithSSO()\"\n        >\n            <button\n                fd-button\n                options=\"emphasized\"\n                class=\"fd-button--emphasized su-login--btn\"\n                id=\"submitSSO_{{ authURIKey }}\"\n                name=\"submitSSO\"\n                type=\"submit\"\n                translate=\"se.authentication.form.button.submit.sso\"\n            ></button>\n        </form>\n    </div>\n</div>\n<img\n    *ngIf=\"resource?.bottomLogoURL\"\n    [src]=\"resource?.bottomLogoURL\"\n    class=\"su-login--logo__best-run\"\n/>\n",
        styles: [".su-login{width:500px;min-height:440px;box-shadow:0 1px 4px 0 rgba(0,0,0,.1);background-color:#fff;border-radius:4px;border:1px solid rgba(0,0,0,.2);padding:20px;margin:0 auto}.su-login--wrapper{padding:40px 100px;width:100%}.su-login--form-group{margin-bottom:20px}.su-login--form-sso{margin-top:20px}.su-login--logo-wrapper{display:-webkit-box;display:flex;-webkit-box-pack:start;justify-content:flex-start;-webkit-box-align:center;align-items:center}.su-login--logo-wrapper.su-login--logo-wrapper_full{padding-bottom:45px}.su-login--logo{height:44px}.su-login--logo-text{font-family:\"72\",web,\"Open Sans\",sans-serif;font-size:1.7142857143rem;line-height:1.3333333333;padding-left:16px;color:#32363a;font-weight:700}.su-login--logo__best-run{position:absolute;bottom:30px;left:30px}.su-login--btn{font-size:1rem;line-height:1.4285714286;font-weight:400;width:100%}.su-login--auth-message{padding-top:20px;padding-bottom:20px;font-size:1rem;line-height:1.4285714286;font-weight:400}.su-login--alert-error{margin-bottom:0;box-shadow:none}"]
    }),
    tslib_1.__param(8, Optional()), tslib_1.__param(8, Inject(LoginDialogResourceProvider)),
    tslib_1.__metadata("design:paramtypes", [ModalRef,
        LogService,
        HttpClient,
        ISessionService,
        IStorageService,
        StringUtils,
        UrlUtils,
        SSOAuthenticationHelper, Object])
], LoginDialogComponent);
export { LoginDialogComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4tZGlhbG9nLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzbWFydC91dGlscy8iLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvbG9naW4tZGlhbG9nL2xvZ2luLWRpYWxvZy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRztBQUNIOzs7R0FHRztBQUNILE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakYsT0FBTyxFQUFtQixXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUNILFVBQVUsRUFDVixVQUFVLEVBQ1YsbUJBQW1CLEVBQ25CLGVBQWUsRUFDZixlQUFlLEVBQ2xCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0seURBQXlELENBQUM7QUFDbEcsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDckUsT0FBTyxFQUF1QiwyQkFBMkIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBYXBHLElBQWEsb0JBQW9CLEdBQWpDLE1BQWEsb0JBQW9CO0lBYTdCLFlBQ1ksUUFBa0IsRUFDbEIsVUFBc0IsRUFDdEIsVUFBc0IsRUFDdEIsY0FBK0IsRUFDL0IsY0FBK0IsRUFDL0IsV0FBd0IsRUFDeEIsUUFBa0IsRUFDbEIsdUJBQWdE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SUFDL0MsQ0FBQztJQUVPLDJCQUEyQjtRQUMvQixNQUFNLFFBQVEsR0FBb0IsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFvQixDQUFDO1FBQy9FLE1BQU0sUUFBUSxHQUFvQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQW9CLENBQUM7UUFFL0UsT0FBTyxDQUNILENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUM3QyxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FDaEQsQ0FBQztJQUNOLENBQUM7Q0FDSixDQUFBOztZQTdIeUIsUUFBUTtZQUNOLFVBQVU7WUFDVixVQUFVO1lBQ04sZUFBZTtZQUNmLGVBQWU7WUFDbEIsV0FBVztZQUNkLFFBQVE7WUFDTyx1QkFBdUI7NENBQ3ZELFFBQVEsWUFBSSxNQUFNLFNBQUMsMkJBQTJCOztBQXJCYjtJQUFyQyxXQUFXLENBQUMsdUJBQXVCLENBQUM7O3VEQUEyQjtBQUR2RCxvQkFBb0I7SUFMaEMsU0FBUyxDQUFDO1FBQ1AsUUFBUSxFQUFFLGlCQUFpQjtRQUUzQiwwMkhBQTRDOztLQUMvQyxDQUFDO0lBdUJPLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLDJCQUEyQixDQUFDLENBQUE7NkNBUjlCLFFBQVE7UUFDTixVQUFVO1FBQ1YsVUFBVTtRQUNOLGVBQWU7UUFDZixlQUFlO1FBQ2xCLFdBQVc7UUFDZCxRQUFRO1FBQ08sdUJBQXVCO0dBckJuRCxvQkFBb0IsQ0EySWhDO1NBM0lZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDIwIFNBUCBTRSBvciBhbiBTQVAgYWZmaWxpYXRlIGNvbXBhbnkuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBAbW9kdWxlIHNtYXJ0dXRpbHNcbiAqL1xuLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkgU0FQIFNFIG9yIGFuIFNBUCBhZmZpbGlhdGUgY29tcGFueS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIEBtb2R1bGUgc21hcnR1dGlsc1xuICovXG5pbXBvcnQgeyBDb21wb25lbnQsIEhvc3RCaW5kaW5nLCBJbmplY3QsIE9uSW5pdCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCwgVmFsaWRhdG9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwSGVhZGVycywgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTW9kYWxSZWYgfSBmcm9tICdAZnVuZGFtZW50YWwtbmd4L2NvcmUnO1xuXG5pbXBvcnQgeyBTdHJpbmdVdGlscywgVXJsVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgICBJQXV0aFRva2VuLFxuICAgIElMb2dpbkRhdGEsXG4gICAgSUxvZ2luTW9kYWxGZWVkYmFjayxcbiAgICBJU2Vzc2lvblNlcnZpY2UsXG4gICAgSVN0b3JhZ2VTZXJ2aWNlXG59IGZyb20gJy4uLy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgU1NPQXV0aGVudGljYXRpb25IZWxwZXIgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hdXRoZW50aWNhdGlvbi9zc28tYXV0aGVudGljYXRpb24uaGVscGVyJztcbmltcG9ydCB7IERFRkFVTFRfQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQgfSBmcm9tICcuLi8uLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgTG9naW5EaWFsb2dSZXNvdXJjZSwgTG9naW5EaWFsb2dSZXNvdXJjZVByb3ZpZGVyIH0gZnJvbSAnLi9sb2dpbi1kaWFsb2ctcmVzb3VyY2UtcHJvdmlkZXInO1xuXG5pbnRlcmZhY2UgSVJlcXVlc3RQYXlsb2FkIHtcbiAgICB1c2VybmFtZTogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG4gICAgZ3JhbnRfdHlwZTogc3RyaW5nO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3N1LWxvZ2luLWRpYWxvZycsXG4gICAgc3R5bGVVcmxzOiBbJy4vbG9naW4tZGlhbG9nLmNvbXBvbmVudC5zY3NzJ10sXG4gICAgdGVtcGxhdGVVcmw6ICcuL2xvZ2luLWRpYWxvZy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgTG9naW5EaWFsb2dDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIEBIb3N0QmluZGluZygnY2xhc3Muc3UtbG9naW4tZGlhbG9nJykgaG9zdENsYXNzOiBib29sZWFuID0gdHJ1ZTtcblxuICAgIHB1YmxpYyBkYXRhOiBJTG9naW5EYXRhID0gKG51bGwgYXMgdW5rbm93bikgYXMgSUxvZ2luRGF0YTtcbiAgICBwdWJsaWMgYXV0aFVSSUtleTogc3RyaW5nID0gJyc7XG4gICAgcHVibGljIGF1dGhVUkk6IHN0cmluZyA9ICcnO1xuICAgIHB1YmxpYyBpc0Z1bGxTY3JlZW46IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwdWJsaWMgc3NvRW5hYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHB1YmxpYyBmb3JtOiBGb3JtR3JvdXAgPSBuZXcgRm9ybUdyb3VwKHtcbiAgICAgICAgdXNlcm5hbWU6IG5ldyBGb3JtQ29udHJvbCgnJywgVmFsaWRhdG9ycy5yZXF1aXJlZCksXG4gICAgICAgIHBhc3N3b3JkOiBuZXcgRm9ybUNvbnRyb2woJycsIFZhbGlkYXRvcnMucmVxdWlyZWQpXG4gICAgfSk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBtb2RhbFJlZjogTW9kYWxSZWYsXG4gICAgICAgIHByaXZhdGUgbG9nU2VydmljZTogTG9nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBJU2Vzc2lvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IElTdG9yYWdlU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzdHJpbmdVdGlsczogU3RyaW5nVXRpbHMsXG4gICAgICAgIHByaXZhdGUgdXJsVXRpbHM6IFVybFV0aWxzLFxuICAgICAgICBwcml2YXRlIHNzb0F1dGhlbnRpY2F0aW9uSGVscGVyOiBTU09BdXRoZW50aWNhdGlvbkhlbHBlcixcbiAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChMb2dpbkRpYWxvZ1Jlc291cmNlUHJvdmlkZXIpIHB1YmxpYyByZXNvdXJjZTogTG9naW5EaWFsb2dSZXNvdXJjZVxuICAgICkge31cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLmRhdGEgPSB0aGlzLm1vZGFsUmVmLmRhdGEgfHwge307XG5cbiAgICAgICAgdGhpcy5hdXRoVVJJID0gdGhpcy5kYXRhLmF1dGhVUkk7XG5cbiAgICAgICAgdGhpcy5pc0Z1bGxTY3JlZW4gPSB0aGlzLmRhdGEuaXNGdWxsU2NyZWVuIGFzIGJvb2xlYW47XG4gICAgICAgIHRoaXMuc3NvRW5hYmxlZCA9ICh0aGlzLmRhdGEuc3NvRW5hYmxlZCBhcyBib29sZWFuKSAmJiB0aGlzLmlzTWFpbkVuZFBvaW50KCk7XG5cbiAgICAgICAgdGhpcy5zdG9yYWdlU2VydmljZS5yZW1vdmVBdXRoVG9rZW4odGhpcy5hdXRoVVJJKTtcblxuICAgICAgICB0aGlzLmF1dGhVUklLZXkgPSBidG9hKHRoaXMuYXV0aFVSSSkucmVwbGFjZSgvPS9nLCAnJyk7XG5cbiAgICAgICAgaWYgKHRoaXMuc3NvQXV0aGVudGljYXRpb25IZWxwZXIuaXNBdXRvU1NPTWFpbigpKSB7XG4gICAgICAgICAgICB0aGlzLnNpZ25pbldpdGhTU08oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzaWduaW5XaXRoU1NPID0gKCk6IFByb21pc2U8SUxvZ2luTW9kYWxGZWVkYmFjaz4gPT4ge1xuICAgICAgICB0aGlzLmZvcm0uc2V0RXJyb3JzKG51bGwpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnNzb0F1dGhlbnRpY2F0aW9uSGVscGVyXG4gICAgICAgICAgICAubGF1bmNoU1NPRGlhbG9nKClcbiAgICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgICAgIChkYXRhOiBJQXV0aFRva2VuKSA9PiB0aGlzLnN0b3JlQWNjZXNzVG9rZW4oZGF0YSksXG4gICAgICAgICAgICAgICAgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4gdGhpcy5BUElBdXRoZW50aWNhdGlvbkZhaWx1cmVSZXBvcnRGYWN0b3J5KGVycm9yKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnRoZW4oKHVzZXJIYXNDaGFuZ2VkOiBib29sZWFuKSA9PiB0aGlzLmFjY2VwdFVzZXIodXNlckhhc0NoYW5nZWQpKTtcbiAgICB9O1xuXG4gICAgcHVibGljIHNpZ25pbldpdGhDcmVkZW50aWFscygpOiBQcm9taXNlPElMb2dpbk1vZGFsRmVlZGJhY2s+IHtcbiAgICAgICAgdGhpcy5mb3JtLnNldEVycm9ycyhudWxsKTtcblxuICAgICAgICBpZiAodGhpcy5oYXNSZXF1aXJlZENyZWRlbnRpYWxzRXJyb3IoKSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtLnNldEVycm9ycyh7XG4gICAgICAgICAgICAgICAgY3JlZGVudGlhbHNSZXF1aXJlZEVycm9yOiAnc2UubG9naW5kaWFsb2dmb3JtLnVzZXJuYW1lLmFuZC5wYXNzd29yZC5yZXF1aXJlZCdcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICAgICAgICAuLi4odGhpcy5kYXRhLmNsaWVudENyZWRlbnRpYWxzIHx8IHt9KSxcbiAgICAgICAgICAgIHVzZXJuYW1lOiAodGhpcy5mb3JtLmdldCgndXNlcm5hbWUnKSBhcyBGb3JtQ29udHJvbCkudmFsdWUsXG4gICAgICAgICAgICBwYXNzd29yZDogKHRoaXMuZm9ybS5nZXQoJ3Bhc3N3b3JkJykgYXMgRm9ybUNvbnRyb2wpLnZhbHVlLFxuICAgICAgICAgICAgZ3JhbnRfdHlwZTogJ3Bhc3N3b3JkJ1xuICAgICAgICB9IGFzIElSZXF1ZXN0UGF5bG9hZDtcblxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kQ3JlZGVudGlhbHMocGF5bG9hZClcbiAgICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgICAgIChyZXNwb25zZTogSHR0cFJlc3BvbnNlPElBdXRoVG9rZW4+IHwgSUF1dGhUb2tlbikgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZUFjY2Vzc1Rva2VuKHJlc3BvbnNlKSxcbiAgICAgICAgICAgICAgICAoZXJyb3IpID0+IHRoaXMuQVBJQXV0aGVudGljYXRpb25GYWlsdXJlUmVwb3J0RmFjdG9yeShlcnJvcilcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC50aGVuKChoYXNVc2VyQ2hhbmdlZDogYm9vbGVhbikgPT4gdGhpcy5hY2NlcHRVc2VyKGhhc1VzZXJDaGFuZ2VkKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc01haW5FbmRQb2ludCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIERFRkFVTFRfQVVUSEVOVElDQVRJT05fRU5UUllfUE9JTlQgPT09IHRoaXMuYXV0aFVSSTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0b3JlQWNjZXNzVG9rZW4oXG4gICAgICAgIHJlc3BvbnNlOiBIdHRwUmVzcG9uc2U8SUF1dGhUb2tlbj4gfCBJQXV0aFRva2VuXG4gICAgKTogUHJvbWlzZUxpa2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCB0b2tlbiA9IHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlID8gcmVzcG9uc2UuYm9keSA6IHJlc3BvbnNlO1xuICAgICAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLnN0b3JlQXV0aFRva2VuKHRoaXMuYXV0aFVSSSwgdG9rZW4gYXMgSUF1dGhUb2tlbik7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5kZWJ1ZyhgQVBJIEF1dGhlbnRpY2F0aW9uIFN1Y2Nlc3M6ICR7dGhpcy5hdXRoVVJJfWApO1xuICAgICAgICByZXR1cm4gdGhpcy5pc01haW5FbmRQb2ludCgpXG4gICAgICAgICAgICA/IHRoaXMuc2Vzc2lvblNlcnZpY2UuaGFzVXNlckNoYW5nZWQoKVxuICAgICAgICAgICAgOiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VuZENyZWRlbnRpYWxzID0gKHBheWxvYWQ6IElSZXF1ZXN0UGF5bG9hZCk6IFByb21pc2U8SHR0cFJlc3BvbnNlPElBdXRoVG9rZW4+PiA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnRcbiAgICAgICAgICAgIC5yZXF1ZXN0PElBdXRoVG9rZW4+KCdQT1NUJywgdGhpcy5hdXRoVVJJLCB7XG4gICAgICAgICAgICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKCkuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyksXG4gICAgICAgICAgICAgICAgYm9keTogdGhpcy51cmxVdGlscy5nZXRRdWVyeVN0cmluZyhwYXlsb2FkKS5yZXBsYWNlKCc/JywgJycpLFxuICAgICAgICAgICAgICAgIG9ic2VydmU6ICdyZXNwb25zZSdcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgQVBJQXV0aGVudGljYXRpb25GYWlsdXJlUmVwb3J0RmFjdG9yeShlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpOiBQcm9taXNlPG5ldmVyPiB7XG4gICAgICAgIHRoaXMubG9nU2VydmljZS5kZWJ1ZyhcbiAgICAgICAgICAgIGBBUEkgQXV0aGVudGljYXRpb24gRmFpbHVyZTogJHt0aGlzLmF1dGhVUkl9IHN0YXR1czogJHtlcnJvci5zdGF0dXN9YFxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuZm9ybS5zZXRFcnJvcnMoe1xuICAgICAgICAgICAgYXN5bmNWYWxpZGF0aW9uRXJyb3I6XG4gICAgICAgICAgICAgICAgKGVycm9yLmVycm9yICYmIHRoaXMuc3RyaW5nVXRpbHMuc2FuaXRpemUoZXJyb3IuZXJyb3IuZXJyb3JfZGVzY3JpcHRpb24pKSB8fFxuICAgICAgICAgICAgICAgICdzZS5sb2dpbmRpYWxvZ2Zvcm0ub2F1dGguZXJyb3IuZGVmYXVsdCdcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFjY2VwdFVzZXIodXNlckhhc0NoYW5nZWQ6IGJvb2xlYW4pOiBQcm9taXNlPElMb2dpbk1vZGFsRmVlZGJhY2s+IHtcbiAgICAgICAgdGhpcy5tb2RhbFJlZi5jbG9zZSh7XG4gICAgICAgICAgICB1c2VySGFzQ2hhbmdlZFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHRoaXMuaXNNYWluRW5kUG9pbnQoKSkge1xuICAgICAgICAgICAgdGhpcy5zZXNzaW9uU2VydmljZS5zZXRDdXJyZW50VXNlcm5hbWUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgdXNlckhhc0NoYW5nZWQgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYXNSZXF1aXJlZENyZWRlbnRpYWxzRXJyb3IoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHVzZXJuYW1lOiBBYnN0cmFjdENvbnRyb2wgPSB0aGlzLmZvcm0uZ2V0KCd1c2VybmFtZScpIGFzIEFic3RyYWN0Q29udHJvbDtcbiAgICAgICAgY29uc3QgcGFzc3dvcmQ6IEFic3RyYWN0Q29udHJvbCA9IHRoaXMuZm9ybS5nZXQoJ3Bhc3N3b3JkJykgYXMgQWJzdHJhY3RDb250cm9sO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAodXNlcm5hbWUuZXJyb3JzICYmIHVzZXJuYW1lLmVycm9ycy5yZXF1aXJlZCkgfHxcbiAgICAgICAgICAgIChwYXNzd29yZC5lcnJvcnMgJiYgcGFzc3dvcmQuZXJyb3JzLnJlcXVpcmVkKVxuICAgICAgICApO1xuICAgIH1cbn1cbiJdfQ==